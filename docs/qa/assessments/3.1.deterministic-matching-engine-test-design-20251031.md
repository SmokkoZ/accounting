# Test Design: Story 3.1

Date: 2025-10-31
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 12
- Unit tests: 8 (67%)
- Integration tests: 3 (25%)
- E2E tests: 1 (8%)
- Priority distribution: P0: 6, P1: 4, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Matching trigger on bet approval

| ID | Level | Priority | Test | Requirement | Justification |
|----|-------|---------|------|----------|------------|-------------|
| 1.3-UNIT-001 | Unit | P0 | Validate input format validation | Pure validation logic | |
| 1.3-INT-001 | Integration | P0 | Service processes request and calls matcher | Multi-component flow | |
| 1.3-E2E-001 | E2E | P0 | End-to-end bet approval to surebet creation | Critical path validation | |

### AC2: Matching algorithm implementation

| ID | Level | Priority | Test | Requirement | Justification |
|----|-------|---------|------|----------|------------|-------------|
| 2.3-UNIT-001 | Unit | P0 | Query opposite-side candidates with exact criteria | Core matching algorithm | |
| 2.3-UNIT-002 | Unit | P0 | Create new surebet if no existing found | Surebet creation logic | |
| 2.3-UNIT-003 | Unit | P0 | Link bets to existing surebet | Junction table operations | |
| 2.3-UNIT-004 | Unit | P0 | Update bet statuses to 'matched' | Status transition logic | |
| 2.3-INT-001 | Integration | P0 | Complete matching workflow with database transaction | End-to-end transaction integrity | |

### AC3: Deterministic side assignment

| ID | Level | Priority | Test | Requirement | Justification |
|----|-------|---------|------|----------|------------|-------------|
| 3.3-UNIT-001 | Unit | P0 | Map OVER/YES/TEAM_A to side 'A' | Core side assignment logic | |
| 3.3-UNIT-002 | Unit | P0 | Map UNDER/NO/TEAM_B to side 'B' | Core side assignment logic | |
| 3.3-UNIT-003 | Unit | P0 | Handle invalid side enum with error | Error handling validation | |
| 3.3-UNIT-004 | Unit | P0 | Verify side immutability constraint | Database constraint validation | |

### AC4: Handle multiple bets on same side

| ID | Level | Priority | Test | Requirement | Justification |
|----|-------|---------|------|----------|------------|-------------|
| 4.3-UNIT-001 | Unit | P0 | Multiple A-side bets vs single B-side bet | Complex matching scenario | |
| 4.3-INT-001 | Integration | P0 | All bets linked to same surebet with correct sides | Multi-bet transaction handling | |

### AC5: Filter unsupported bet types

| ID | Level | Priority | Test | Requirement | Justification |
|----|-------|---------|------|----------|------------|-------------|
| 5.3-UNIT-001 | Unit | P0 | Unsupported bet (is_supported=0) not matched | Input filtering logic | |
| 5.3-UNIT-002 | Unit | P0 | Matching query excludes unsupported candidates | Database query validation | |

### AC6: Matching idempotency

| ID | Level | Priority | Test | Requirement | Justification |
|----|-------|---------|------|----------|------------|-------------|
| 6.3-UNIT-001 | Unit | P0 | Re-running match on already matched bet returns existing surebet_id | Idempotency logic | |
| 6.3-UNIT-002 | Unit | P0 | Multiple match attempts on verified bet create no duplicates | Duplicate prevention logic | |

## Risk Coverage

| Risk ID | Covered by Test | Mitigation Strategy |
|----------|-------------------|-------------------|
| TECH-001 | 1.3-INT-001, 4.3-INT-001 | Database transactions and proper isolation |
| SEC-001 | 1.3-UNIT-001, 5.3-UNIT-001 | Input validation and sanitization |
| PERF-001 | 2.3-UNIT-001, 2.3-UNIT-002 | Query optimization and indexing |
| DATA-001 | 6.3-UNIT-002 | Database transaction integrity |

## Test Environment Requirements

- **Database**: Test database with proper indexes and constraints
- **Mock Services**: Mock external dependencies (FX rates, OpenAI)
- **Test Data**: Comprehensive test datasets covering all scenarios
- **Performance**: Ability to simulate concurrent operations

## Execution Order

1. P0 Unit tests (fail fast)
2. P0 Integration tests
3. P1 Integration tests
4. P0 E2E test
5. P2 tests as time permits

## Success Criteria

- All acceptance criteria have test coverage
- Risk mitigations are validated through testing
- Performance requirements met under load
- Code coverage target achieved (80%+ for matching logic)