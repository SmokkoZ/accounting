story: "11.1.nd-sign-consistency-and-identity-adoption"
epic: "11"
decision: FAIL
date: 2025-11-13
gate_keeper: "Quinn - Test Architect"

risk_score: 20
risk_level: High
risk_factors:
  - factor: "Reconciliation service runtime crash"
    probability: 5
    impact: 5
    score: 25
    priority: High
  - factor: "Statements UI/exports referencing removed fields"
    probability: 5
    impact: 4
    score: 20
    priority: High
  - factor: "Integration suite divergence"
    probability: 4
    impact: 3
    score: 12
    priority: High

nfr_assessment:
  security: PASS
  performance: PASS
  reliability: FAIL
  usability: CONCERNS
  maintainability: CONCERNS

traceability:
  total_requirements: 5
  tested_requirements: 3
  coverage_percentage: 60%
  gaps_identified:
    - "AC3: Reconciliation service raises NameError and statements UI crashes before exposing ND/FS/YF/TB/I''."
    - "AC5: Clipboard/export text still references legacy fields and cannot render because of the crash above."

quality_gate:
  decision: FAIL
  rationale: >
    Settle Associate Now works and CSV rows include the new identity metrics, but the
    reconciliation service now raises a NameError (missing SETTLEMENT_NOTE_PREFIX) and the
    Statements UI/export paths reference removed PartnerFacingSection fields, so users and tests
    cannot exercise the ND/FS/YF/TB/I'' identities end-to-end.
  critical_issues:
    - "src/services/reconciliation_service.py:98 references SETTLEMENT_NOTE_PREFIX without defining/importing it, so get_associate_balances() raises a NameError."
    - "render_export_options() in src/ui/pages/6_statements.py:571-579 still uses partner_section.holdings_eur/delta_eur, causing the Statements page to crash."
    - "tests/integration/test_statement_flow.py:320-326 still expects PartnerFacingSection.holdings_eur, so the integration suite fails before validating the new workflow."
  recommendations:
    - "Define/import SETTLEMENT_NOTE_PREFIX inside src/services/reconciliation_service.py and re-run the reconciliation unit tests."
    - "Update the Statements UI/export clipboard text to use total_balance_eur/imbalance_eur/exit_payout_eur so the page renders and the new terminology shows up."
    - "Bring tests/integration/test_statement_flow.py in sync with the renamed PartnerFacingSection fields so the integration suite guards the Settle Associate flow."
  next_steps:
    - "Verify the UI crash is resolved by running the page and the existing integration tests."
    - "Add a lightweight UI/CLI smoke test for render_export_options to catch regressions around renamed fields."

test_strategy:
  unit_tests: Required
  integration_tests: Required
  e2e_tests: Required
  performance_tests: Not Required
  security_tests: Not Required
  automation_potential: High

technical_debt:
  identified_issues:
    - "Identity constants are duplicated per-module, which already caused the reconciliation crash."
    - "Clipboard/export helpers still hand-roll legacy text instead of reusing the new DTO fields."
  severity: High
  remediation_priority: Immediate
  estimated_effort: 16 hours

success_criteria:
  - "Reconciliation, statements, and bookmaker read models all emit ND/FS/YF/TB/I'' without runtime errors."
  - "Settle Associate Now (UI + service + CSV) keeps I'' at zero and continues to pass integration tests."
  - "Clipboard/export text mirrors the identity terminology without referencing removed fields."

sign_off:
  qa_engineer: "Quinn - Test Architect"
  review_date: 2025-11-13
  approval_status: Rejected
