# Story 7.1: Associate Management UI

## Status
Ready for Review

## Story
**As the operator**, I want a web interface to view, add, edit, and delete associates so I don't have to use Telegram commands for system administration.

## Acceptance Criteria

**View Associates**
- [ ] Display table of all associates with columns:
  - Display Alias (clickable to expand)
  - Home Currency (ISO code)
  - Admin Flag (‚úì or blank)
  - Bookmaker Count (e.g., "2")
  - Created Date (formatted as "2025-11-02")
  - Actions: [Edit] [Delete] buttons
- [ ] Implement search/filter by alias (case-insensitive)
- [ ] Sort by alias (alphabetically) by default
- [ ] Display counter: "Total Associates: X"

**Add Associate**
- [ ] "Add Associate" button opens modal/form with fields:
  - **Display Alias**: Text input (required, unique validation)
  - **Home Currency**: Dropdown (EUR, GBP, USD, AUD, etc.)
  - **Is Admin**: Checkbox (default: unchecked)
  - **Multibook Chat ID**: Text input (optional, Telegram chat for coverage proof)
- [ ] Validation:
  - Alias must be unique (check against existing)
  - Alias must not be empty
  - Currency must be valid ISO code
- [ ] On save:
  - `INSERT INTO associates (display_alias, home_currency, is_admin, multibook_chat_id, created_at_utc, updated_at_utc) VALUES (?, ?, ?, ?, datetime('now') || 'Z', datetime('now') || 'Z')`
  - Display success message: "‚úÖ Associate '<alias>' created"
  - Refresh table to show new associate
- [ ] On validation error:
  - Display error message: "‚ùå Alias already exists" or "‚ùå Invalid currency"

**Edit Associate**
- [ ] "Edit" button opens form pre-populated with current values
- [ ] Allow editing:
  - Display Alias (with unique validation)
  - Home Currency
  - Is Admin flag
  - Multibook Chat ID
- [ ] On save:
  - `UPDATE associates SET display_alias = ?, home_currency = ?, is_admin = ?, multibook_chat_id = ?, updated_at_utc = datetime('now') || 'Z' WHERE id = ?`
  - Display success message: "‚úÖ Associate updated"
- [ ] Validate alias uniqueness (excluding current record)

**Delete Associate**
- [ ] "Delete" button shows warning modal:
  - "‚ö†Ô∏è Are you sure you want to delete '<alias>'?"
- [ ] Pre-delete validation:
  - Check if associate has any bets: `SELECT COUNT(*) FROM bets WHERE associate_id = ?`
  - Check if associate has any ledger entries: `SELECT COUNT(*) FROM ledger_entries WHERE associate_id = ?`
  - If count > 0: Display error "‚ùå Cannot delete associate with existing bets/ledger entries"
- [ ] If validation passes:
  - `DELETE FROM associates WHERE id = ?`
  - Cascade deletes bookmakers (ON DELETE CASCADE in schema)
  - Display success message: "‚úÖ Associate '<alias>' deleted"

**Technical Notes:**
- Use `st.data_editor()` or custom table component
- Leverage Streamlit session state for modal management
- Query fresh data on every page load (no caching)

## Tasks / Subtasks

- [x] Task 1: Create Admin Associates page structure (AC: 1)
  - [x] Create `src/ui/pages/7_admin_associates.py` file
  - [x] Add page title "üßë‚Äçüíº Associate & Bookmaker Management"
  - [x] Set up database connection using `get_db_connection()`
  - [x] Create tab structure with "Associates & Bookmakers" and "Balance History" tabs

- [x] Task 2: Implement "View Associates" table (AC: 1)
  - [x] Create `load_associates()` function to query all associates from database
  - [x] Display table with columns: Display Alias, Home Currency, Admin Flag, Bookmaker Count, Created Date, Actions
  - [x] Format dates using `format_utc_datetime()` formatter
  - [x] Add search/filter text input (case-insensitive filter on alias)
  - [x] Implement alphabetical sort by alias
  - [x] Display counter showing total associates count

- [x] Task 3: Implement "Add Associate" form (AC: 2)
  - [x] Add "Add Associate" button that triggers modal/expander
  - [x] Create form with fields: Display Alias (text input), Home Currency (selectbox), Is Admin (checkbox), Multibook Chat ID (text input)
  - [x] Implement validation: alias not empty, alias unique, currency valid ISO code
  - [x] On submit, insert into `associates` table with UTC timestamps
  - [x] Display success/error messages using `st.success()` or `st.error()`
  - [x] Refresh page using `st.rerun()` after successful insert

- [x] Task 4: Implement "Edit Associate" functionality (AC: 3)
  - [x] Add "Edit" button per associate row
  - [x] Create edit form pre-populated with current associate values
  - [x] Allow editing of: display_alias, home_currency, is_admin, multibook_chat_id
  - [x] Validate uniqueness of alias (excluding current record)
  - [x] On submit, update associate record with new values and updated_at_utc timestamp
  - [x] Display success message and refresh table

- [x] Task 5: Implement "Delete Associate" functionality (AC: 4)
  - [x] Add "Delete" button per associate row
  - [x] Show confirmation modal: "‚ö†Ô∏è Are you sure you want to delete '<alias>'?"
  - [x] Implement pre-delete validation checking for bets and ledger entries
  - [x] If validation fails, display error message preventing deletion
  - [x] If validation passes, execute DELETE query (cascades to bookmakers)
  - [x] Display success message and refresh table

- [x] Task 6: Add currency validation helper (AC: 2)
  - [x] Create `validate_currency()` function in `src/ui/utils/validators.py`
  - [x] Define list of valid ISO currency codes (EUR, GBP, USD, AUD, etc.)
  - [x] Use in form validation for Add/Edit operations

- [x] Task 7: Implement session state management for modals (AC: 2, 3, 4)
  - [x] Use `st.session_state` to track open/closed state of Add/Edit/Delete modals
  - [x] Implement modal open/close logic
  - [x] Clear session state after successful operations

- [x] Task 8: Add testing for associate management (Testing)
  - [x] Write unit tests for `load_associates()` query function
  - [x] Write unit tests for `validate_currency()` helper
  - [x] Write integration tests for add/edit/delete workflows
  - [x] Test validation logic (uniqueness, empty fields, etc.)
  - [x] Test cascade delete behavior

## Dev Notes

### Previous Story Insights
From Epic 0 (Foundation Stories):
- Database schema for `associates` table already exists with columns: id, display_alias, home_currency, multibook_chat_id, is_admin, created_at_utc, updated_at_utc [Source: docs/prd/epic-7-system-administration.md#L327-L338]
- Foreign key constraint exists: `bookmakers.associate_id` references `associates(id)` with ON DELETE CASCADE [Source: docs/prd/epic-7-system-administration.md#L342-L353]
- The system already has associates created via Telegram bot commands, so this UI provides an alternative interface

### Data Models

**associates table** [Source: docs/architecture/data-architecture.md#L89-L103]:
```sql
CREATE TABLE associates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    display_alias TEXT NOT NULL UNIQUE,
    home_currency TEXT NOT NULL DEFAULT 'EUR',
    multibook_chat_id TEXT,
    is_admin BOOLEAN NOT NULL DEFAULT FALSE,
    created_at_utc TEXT NOT NULL DEFAULT (datetime('now') || 'Z'),
    updated_at_utc TEXT NOT NULL DEFAULT (datetime('now') || 'Z')
);
```

**Key Fields**:
- `display_alias`: Unique identifier shown in UI (e.g., "Alice", "Bob", "Admin")
- `home_currency`: Default currency for this associate (EUR, GBP, USD, AUD, etc.)
- `is_admin`: Boolean flag (0 or 1 in SQLite) indicating admin privileges
- `multibook_chat_id`: Optional Telegram chat ID for coverage proof delivery
- `created_at_utc`, `updated_at_utc`: ISO8601 timestamps with "Z" suffix

**Foreign Key Relationships**:
- `bookmakers.associate_id` ‚Üí `associates.id` (ON DELETE CASCADE)
- `bets.associate_id` ‚Üí `associates.id`
- `ledger_entries.associate_id` ‚Üí `associates.id`

### UI Component Specifications

**Page Location**: `src/ui/pages/7_admin_associates.py` [Source: docs/architecture/frontend-architecture.md#L27]

**Streamlit Page Structure** [Source: docs/architecture/frontend-architecture.md#L43-L70]:
```python
# src/ui/pages/7_admin_associates.py
import streamlit as st
from src.core.database import get_db_connection

def render_associates_tab():
    st.subheader("Associate Management")

    # Counter
    st.metric("Total Associates", count_associates())

    # Search filter
    search = st.text_input("üîç Search by alias", "")

    # Add button
    if st.button("+ Add Associate"):
        st.session_state.show_add_modal = True

    # Table display
    associates = load_associates(filter_alias=search)
    for assoc in associates:
        render_associate_row(assoc)
```

**Streamlit Widgets to Use** [Source: docs/architecture/tech-stack.md#L55-L67]:
- `st.text_input()` - For Display Alias, Multibook Chat ID, Search filter
- `st.selectbox()` - For Home Currency dropdown
- `st.checkbox()` - For Is Admin flag
- `st.button()` - For Add, Edit, Delete, Save, Cancel actions
- `st.metric()` - For Total Associates counter
- `st.success()` / `st.error()` - For success/error messages
- `st.expander()` - For Add/Edit forms (alternative to modals)
- `st.rerun()` - To refresh page after data modifications

**Database Query Pattern** [Source: docs/architecture/coding-standards.md#L310-L340]:
```python
# Use parameterized queries only (never string formatting)
def load_associates(filter_alias=None):
    conn = get_db_connection()
    cursor = conn.cursor()

    query = """
        SELECT
            a.*,
            COUNT(b.id) AS bookmaker_count
        FROM associates a
        LEFT JOIN bookmakers b ON a.id = b.associate_id
    """

    params = []
    if filter_alias:
        query += " WHERE LOWER(a.display_alias) LIKE LOWER(?)"
        params.append(f"%{filter_alias}%")

    query += " GROUP BY a.id ORDER BY a.display_alias ASC"

    cursor.execute(query, params)
    return cursor.fetchall()
```

### File Locations

Based on architecture documentation:
- `src/ui/pages/7_admin_associates.py` - New Streamlit page for associate management [Source: docs/architecture/frontend-architecture.md#L27]
- `src/ui/utils/validators.py` - Currency validation helper (may already exist, or create new) [Source: docs/architecture/frontend-architecture.md#L36]
- `src/ui/utils/formatters.py` - Date/currency formatters (already exists from previous stories) [Source: docs/architecture/frontend-architecture.md#L35]
- `src/core/database.py` - Database connection helper (already exists) [Source: docs/architecture/data-architecture.md#L19-L39]

### Technical Constraints

**Python Standards** [Source: docs/architecture/coding-standards.md]:
- Use Python 3.12+ with type hints for all functions [Line 99-109]
- Use Decimal type for any currency amounts (not applicable here since we're displaying metadata)
- All timestamps in UTC ISO8601 with "Z" suffix [Line 198-226]
- Use parameterized queries for all SQL operations (never string formatting) [Line 310-320]

**Streamlit Behavior** [Source: docs/architecture/frontend-architecture.md#L56-L70]:
- Streamlit reruns entire script on every interaction
- Minimize session state usage (only for modal open/closed state)
- Always query fresh data from database on page load (no caching)
- No ORM - use direct SQLite queries via sqlite3 module

**Database Operations**:
- Use `datetime('now') || 'Z'` for UTC timestamps in SQL INSERT/UPDATE [Source: docs/architecture/data-architecture.md#L58-L62]
- Store boolean as INTEGER (0 or 1) in SQLite [Source: docs/prd/epic-7-system-administration.md#L334]
- Enforce foreign keys with PRAGMA foreign_keys = ON [Source: docs/architecture/data-architecture.md#L26-L39]

### Validation Rules

**Associate Validation** [Source: docs/prd/epic-7-system-administration.md#L592-L601]:

| Field | Rule | Error Message |
|-------|------|---------------|
| Display Alias | Not empty | "‚ùå Alias is required" |
| Display Alias | Unique | "‚ùå Alias already exists" |
| Display Alias | Max 50 chars | "‚ùå Alias too long (max 50)" |
| Home Currency | Valid ISO code | "‚ùå Invalid currency code" |

**Valid Currency Codes**:
EUR, GBP, USD, AUD (minimum set, can be expanded)

### Delete Validation Logic

**Can Delete Associate?** [Source: docs/prd/epic-7-system-administration.md#L620-L650]:

```python
def can_delete_associate(db: sqlite3.Connection, associate_id: int) -> tuple[bool, str]:
    """
    Check if associate can be safely deleted.

    Returns:
        (can_delete: bool, reason: str)
    """
    cursor = db.cursor()

    # Check bets
    bet_count = cursor.execute(
        "SELECT COUNT(*) FROM bets WHERE associate_id = ?",
        (associate_id,)
    ).fetchone()[0]

    # Check ledger entries
    ledger_count = cursor.execute(
        "SELECT COUNT(*) FROM ledger_entries WHERE associate_id = ?",
        (associate_id,)
    ).fetchone()[0]

    if bet_count > 0 or ledger_count > 0:
        return False, f"Associate has {bet_count} bets and {ledger_count} ledger entries"

    return True, "OK"
```

### Integration with Telegram Bot

**Coexistence Strategy** [Source: docs/prd/epic-7-system-administration.md#L391-L446]:
- Epic 7 web UI and Telegram bot are equal citizens writing to the same database
- No synchronization logic needed
- Telegram bot commands (`/add_associate`, `/list_associates`) continue to work
- Associates added via web UI can be used in Telegram bot commands
- Associates added via Telegram appear in web UI immediately on page refresh

### UI Layout Reference

**Page Structure** [Source: docs/prd/epic-7-system-administration.md#L467-L522]:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üßë‚Äçüíº Associate & Bookmaker Management                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Tab 1: Associates & Bookmakers                      ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ ‚îÇ [+ Add Associate]      üîç Search: [_______]    ‚îÇ‚îÇ
‚îÇ ‚îÇ                                                 ‚îÇ‚îÇ
‚îÇ ‚îÇ Total Associates: 3                             ‚îÇ‚îÇ
‚îÇ ‚îÇ                                                 ‚îÇ‚îÇ
‚îÇ ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ‚îÇ
‚îÇ ‚îÇ ‚îÇ Alias    ‚îÇ Currency ‚îÇ Admin ‚îÇ Bookmakers ‚îÇ  ‚îÇ‚îÇ
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îÇ‚îÇ
‚îÇ ‚îÇ ‚îÇ Admin    ‚îÇ EUR ‚îÇ ‚úì ‚îÇ 2 ‚îÇ [Edit][Delete]‚îÇ  ‚îÇ‚îÇ
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îÇ‚îÇ
‚îÇ ‚îÇ ‚îÇ Partner A ‚îÇ EUR ‚îÇ  ‚îÇ 2 ‚îÇ [Edit][Delete]‚îÇ  ‚îÇ‚îÇ
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îÇ‚îÇ
‚îÇ ‚îÇ ‚îÇ Partner B ‚îÇ GBP ‚îÇ  ‚îÇ 1 ‚îÇ [Edit][Delete]‚îÇ  ‚îÇ‚îÇ
‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Modal: Add Associate** [Source: docs/prd/epic-7-system-administration.md#L525-L543]:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Add New Associate               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Display Alias: *                ‚îÇ
‚îÇ [___________________________]   ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ Home Currency: *                ‚îÇ
‚îÇ [EUR ‚ñº]                         ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ Is Admin: [ ] Yes               ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ Multibook Chat ID: (optional)   ‚îÇ
‚îÇ [___________________________]   ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ        [Cancel]  [Save]         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Testing

### Testing Standards

**Test Framework** [Source: docs/architecture/testing-strategy.md#L34-L41]:
- Use pytest 7.0+ as testing framework
- Test file naming: `test_` prefix
- Test function naming: descriptive names (e.g., `test_add_associate_with_valid_data()`)
- Follow AAA pattern (Arrange, Act, Assert)

**Test Structure** [Source: docs/architecture/testing-strategy.md#L54-L77]:
```
tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ test_associate_queries.py        # Unit tests for load_associates(), etc.
‚îÇ   ‚îú‚îÄ‚îÄ test_validators.py               # Unit tests for validate_currency()
‚îî‚îÄ‚îÄ integration/
    ‚îî‚îÄ‚îÄ test_associate_management_flow.py # Integration tests for full CRUD workflow
```

**UI Testing Approach** [Source: docs/architecture/testing-strategy.md#L543-L557]:
For Streamlit pages, focus on:
1. **Unit tests** for data loading functions (`load_associates()`, `can_delete_associate()`)
2. **Unit tests** for validation utilities (`validate_currency()`)
3. **Integration tests** for full CRUD workflows (add ‚Üí edit ‚Üí delete)
4. **Manual testing** for visual layout and interaction

**Example Unit Tests**:
```python
# tests/unit/test_associate_queries.py
def test_load_associates_returns_all_associates(test_db):
    """Test loading all associates from database"""
    associates = load_associates(test_db)
    assert len(associates) > 0
    assert all("display_alias" in a for a in associates)

def test_load_associates_filter_by_alias(test_db):
    """Test filtering associates by alias"""
    associates = load_associates(test_db, filter_alias="Alice")
    assert len(associates) == 1
    assert associates[0]["display_alias"] == "Alice"

def test_can_delete_associate_with_no_dependencies(test_db):
    """Test deletion validation passes when no bets/ledger entries"""
    can_delete, reason = can_delete_associate(test_db, associate_id=999)
    assert can_delete is True
    assert reason == "OK"

def test_can_delete_associate_with_bets_fails(test_db):
    """Test deletion validation fails when associate has bets"""
    # Create associate with bets
    associate_id = create_test_associate_with_bets(test_db)
    can_delete, reason = can_delete_associate(test_db, associate_id)
    assert can_delete is False
    assert "bets" in reason.lower()
```

**Example Integration Tests**:
```python
# tests/integration/test_associate_management_flow.py
def test_add_associate_end_to_end(test_db):
    """Test full add associate workflow"""
    # Arrange: Prepare test data
    alias = "Test Associate"
    currency = "EUR"
    is_admin = False

    # Act: Insert associate
    insert_associate(test_db, alias, currency, is_admin, None)

    # Assert: Verify associate exists
    associates = load_associates(test_db, filter_alias=alias)
    assert len(associates) == 1
    assert associates[0]["display_alias"] == alias
    assert associates[0]["home_currency"] == currency

def test_edit_associate_end_to_end(test_db):
    """Test full edit associate workflow"""
    # Arrange: Create test associate
    associate_id = create_test_associate(test_db)

    # Act: Update associate
    update_associate(test_db, associate_id, display_alias="Updated Alias")

    # Assert: Verify changes
    assoc = get_associate_by_id(test_db, associate_id)
    assert assoc["display_alias"] == "Updated Alias"

def test_delete_associate_end_to_end(test_db):
    """Test full delete associate workflow"""
    # Arrange: Create test associate with no dependencies
    associate_id = create_test_associate(test_db)

    # Act: Delete associate
    delete_associate(test_db, associate_id)

    # Assert: Verify associate no longer exists
    assoc = get_associate_by_id(test_db, associate_id)
    assert assoc is None
```

**Coverage Target** [Source: docs/architecture/testing-strategy.md#L482-L492]:
- Unit tests for data loading functions: 90%+
- Unit tests for validation helpers: 90%+
- Integration tests for CRUD workflows: 80%+

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-03 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No debug issues encountered during implementation.

### Completion Notes List
- Successfully implemented full CRUD operations for associate management
- Created validators module with comprehensive validation logic for currency codes, aliases, and chat IDs
- All database operations use parameterized queries with proper type hints
- Session state management implemented using Streamlit expanders for modals
- All 30 tests passing (21 unit tests, 9 integration tests)
- Code formatted with Black and type-checked with mypy (100% passing)
- Cascade delete functionality validated with integration tests
- Functions accept optional connection parameter for testing isolation

### File List
**Source Files Created:**
- [src/ui/pages/7_admin_associates.py](../../../src/ui/pages/7_admin_associates.py) - Main admin page with full CRUD UI
- [src/ui/utils/validators.py](../../../src/ui/utils/validators.py) - Input validation utilities

**Test Files Created:**
- [tests/unit/test_validators.py](../../../tests/unit/test_validators.py) - Unit tests for validators (21 tests)
- [tests/integration/test_associate_management_flow.py](../../../tests/integration/test_associate_management_flow.py) - Integration tests for CRUD workflows (9 tests)

**Files Modified:**
- None (all existing files remain unchanged)

## QA Results

### Review Date: 2025-11-03

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation that fully meets all acceptance criteria with comprehensive test coverage and adherence to coding standards. The code demonstrates:

- **Robust Architecture**: Well-structured separation of concerns with database functions, UI components, and validation utilities
- **Comprehensive Validation**: Thorough input validation covering all edge cases with proper error handling
- **Security Best Practices**: Parameterized queries preventing SQL injection, proper data sanitization
- **Error Handling**: Consistent exception handling with transaction rollback and structured logging
- **Code Organization**: Clear function separation, proper type hints, and comprehensive documentation

### Refactoring Performed

No refactoring was required - the implementation follows established patterns and coding standards excellently.

### Compliance Check

- **Coding Standards**: ‚úì All requirements met
  - Type hints implemented throughout
  - Parameterized queries used exclusively
  - Proper error handling with specific exceptions
  - Structured logging implemented
  - UTC timestamps with "Z" suffix
  - Decimal usage for currency values (where applicable)

- **Project Structure**: ‚úì Excellent adherence
  - Files placed in correct directories per architecture
  - Proper separation of UI, utilities, and database functions
  - Import structure follows established patterns

- **Testing Strategy**: ‚úì Comprehensive coverage
  - Unit tests for all validation functions (21 tests)
  - Integration tests for full CRUD workflows (9 tests)
  - Test coverage exceeds targets (90%+ for unit, 80%+ for integration)
  - Proper test isolation with database setup/teardown

- **All ACs Met**: ‚úì Fully implemented
  - All 4 acceptance criteria completely addressed
  - Edge cases properly handled
  - User experience considerations implemented

### Improvements Checklist

- [x] All validation edge cases covered (validators.py)
- [x] Comprehensive error handling implemented
- [x] Security best practices followed (parameterized queries)
- [x] Proper transaction management with rollback
- [x] Structured logging implemented throughout
- [x] Type hints and documentation complete
- [x] Test coverage exceeds requirements
- [x] UI/UX considerations properly implemented
- [x] Database operations follow best practices
- [x] Session state management properly implemented

### Security Review

**Excellent security implementation:**
- SQL injection prevention through parameterized queries
- Input validation and sanitization for all user inputs
- Proper error message handling without information leakage
- Optional field handling with appropriate validation

**No security concerns identified.**

### Performance Considerations

**Efficient implementation:**
- Database queries optimized with proper indexing considerations
- Connection management with optional parameter for testing
- Efficient filtering and sorting operations
- Minimal database round trips through proper query structure

**No performance issues identified.**

### Files Modified During Review

None - implementation quality was excellent, no modifications required.

### Gate Status

Gate: PASS ‚Üí docs/qa/gates/7.1.associate-management-ui.yml
Risk profile: None (no risks identified)
NFR assessment: None (all NFRs passed)

### Recommended Status

[‚úì Ready for Done]
