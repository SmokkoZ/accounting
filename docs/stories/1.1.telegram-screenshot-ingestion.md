# Story 1.1: Telegram Screenshot Ingestion

## Status
Ready for Review

## Story
**As an operator**, I want screenshots sent to Telegram bookmaker chats to be automatically saved and processed so I don't have to manually handle every photo.

## Acceptance Criteria
- [x] Extends Phase 0 bot photo handler to:
  - Save screenshot to `data/screenshots/{timestamp}_{associate_alias}_{bookmaker_name}.png`
  - Create `bets` row with:
    - `status="incoming"`
    - `ingestion_source="telegram"`
    - `telegram_message_id=<message_id>` (traceability)
    - `associate_id`, `bookmaker_id` (from chat ID mapping)
    - `screenshot_path` (relative path to saved file)
    - `created_at_utc` (current timestamp in ISO8601)
  - Trigger Story 1.2 OCR pipeline asynchronously
  - Reply to sender: "Processing screenshot..."
- [x] Chat ID mapping configured:
  - Config file (`telegram_chats.yaml`) or DB table (`telegram_chat_mappings`)
  - Format: `chat_id: {associate_id: X, bookmaker_id: Y}`
  - Example: `chat_id=123456: {associate_id=1, bookmaker_id=1}` → "Admin + Bet365"
- [x] Unknown chat IDs rejected with error message
- [x] Screenshot file naming collision handled (add milliseconds to timestamp)

## Tasks / Subtasks
- [x] Task 1: Extend Telegram bot photo handler (AC: 1)
  - [x] Modify photo handler in `src/integrations/telegram_bot.py` to save screenshots with proper naming
  - [x] Implement database record creation for incoming bets
  - [x] Add asynchronous trigger for OCR pipeline (placeholder for Story 1.2)
  - [x] Update reply message to sender
- [x] Task 2: Implement chat ID mapping system (AC: 2)
  - [x] Create `telegram_chat_mappings` table in database schema (Note: Reused existing `chat_registrations` table from Phase 0)
  - [x] Implement chat ID lookup functionality
  - [x] Add configuration management for chat mappings
- [x] Task 3: Add error handling for unknown chat IDs (AC: 3)
  - [x] Implement validation for registered chat IDs
  - [x] Add appropriate error response for unknown chats
- [x] Task 4: Handle screenshot file naming collisions (AC: 4)
  - [x] Implement timestamp with milliseconds for unique filenames
  - [x] Add file existence check and fallback naming strategy
- [x] Task 5: Add unit tests (Testing Requirements)
  - [x] Test photo message handling with valid chat mappings
  - [x] Test database record creation
  - [x] Test error handling for unknown chat IDs
  - [x] Test file naming collision handling

## Dev Notes

### Previous Story Insights
From story 0.4, we have:
- Telegram bot scaffold implemented with basic photo handling
- Database schema created with `bets` table
- SQLite database connection established in `src/core/database.py`
- Decimal precision requirements established for all currency values
- UTC timestamp formatting requirements established
- Chat registration system implemented in `chat_registrations` table

### Data Models
Telegram bot will interact with the `bets` table [Source: docs/architecture/data-architecture.md#189-242]:

Key fields to be populated:
- `associate_id` - Foreign key to associates table
- `bookmaker_id` - Foreign key to bookmakers table
- `status` - Set to "incoming" for new screenshots
- `ingestion_source` - Set to "telegram"
- `telegram_message_id` - Message ID from Telegram for traceability
- `screenshot_path` - Path to saved screenshot file
- `created_at_utc` - Current timestamp in ISO8601 format

All extracted bet fields (event, market, odds, etc.) will remain NULL until OCR is implemented in Story 1.2.

New table needed for chat mappings:
```sql
CREATE TABLE telegram_chat_mappings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id INTEGER NOT NULL UNIQUE,
    associate_id INTEGER NOT NULL REFERENCES associates(id),
    bookmaker_id INTEGER NOT NULL REFERENCES bookmakers(id),
    created_at_utc TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ', 'now'))
);
```

### API Specifications
Telegram Bot API requirements [Source: docs/architecture/tech-stack.md#171-185]:

Framework: python-telegram-bot 20.0+
- Use polling mode (not webhook) for simplicity
- Async/await support built on asyncio
- Photo handling via `message.photo[-1].get_file()` for highest resolution
- Message ID available via `message.message_id`

### Component Specifications
No UI components required for this story.

### File Locations
Based on architecture documentation:
- `src/integrations/telegram_bot.py` - Extend existing Telegram bot implementation [Source: docs/architecture/source-tree.md#310]
- `src/core/schema.py` - Add new table for chat mappings [Source: docs/architecture/source-tree.md#210]
- `data/screenshots/` - Screenshot storage directory [Source: docs/architecture/source-tree.md#147]

### Testing Requirements
From testing strategy:
- Create unit tests for extended Telegram bot handlers [Source: docs/architecture/testing-strategy.md#65]
- Test photo message processing with database integration
- Test error handling for unknown chat IDs
- Test file naming collision handling
- Target coverage: 80%+ for Telegram bot [Source: docs/architecture/testing-strategy.md#470]

### Technical Constraints
- Use python-telegram-bot 20.0+ with async support [Source: docs/architecture/tech-stack.md#86]
- Store screenshots in `data/screenshots/` directory [Source: docs/architecture/source-tree.md#147]
- All timestamps in UTC ISO8601 with "Z" suffix [Source: docs/architecture/coding-standards.md#198-226]
- Use parameterized queries for all SQL operations [Source: docs/architecture/coding-standards.md#310-320]
- Bot token must be stored in environment variable, not hardcoded [Source: docs/architecture/coding-standards.md#603]

### Project Structure Notes
The Telegram bot implementation should follow the documented source tree:
- Extend existing bot implementation in `src/integrations/telegram_bot.py`
- Screenshots saved to `data/screenshots/` directory
- Environment variables in `.env` file
- Unit tests in `tests/unit/test_telegram_bot.py`

## Testing

### Testing Standards
- Use pytest 7.0+ as testing framework [Source: docs/architecture/testing-strategy.md#36]
- Test file naming: `test_` prefix [Source: docs/architecture/coding-standards.md#452-464]
- Test function naming: descriptive names [Source: docs/architecture/coding-standards.md#467-483]
- Follow AAA pattern (Arrange, Act, Assert) [Source: docs/architecture/coding-standards.md#487-501]
- Mock Telegram API calls in unit tests
- Test database operations with test database
- Test error handling for unknown chat IDs

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 1.0 | Initial story creation | Scrum Master |
| 2025-10-30 | 1.1 | Story implementation completed - all ACs met, tests passing | Dev Agent (James) |
| 2025-10-30 | 1.2 | Fixed event loop conflict and added user feedback improvements | Dev Agent (James) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No debug log entries required - all tests passing.

### Completion Notes List
- Extended photo handler in [src/integrations/telegram_bot.py](src/integrations/telegram_bot.py) to:
  - Generate filenames with format: `{timestamp_with_ms}_{associate_alias}_{bookmaker_name}.png`
  - Reject unregistered chats with clear error message
  - Handle file naming collisions with counter suffix
  - Create bet records with all required fields (status, ingestion_source, telegram_message_id, etc.)
  - Trigger OCR pipeline placeholder (async method `_trigger_ocr_pipeline`)
  - Reply with "Processing screenshot..." message
- Modified `_get_registration()` to return associate_alias and bookmaker_name in addition to IDs
- Renamed `_create_placeholder_bet()` to `_create_bet_record()` for clarity and updated signature
- Added path resolution logic to handle both relative and absolute paths for screenshot storage
- Reused existing `chat_registrations` table from Phase 0 instead of creating new `telegram_chat_mappings` table
- Added comprehensive unit tests covering all acceptance criteria:
  - Photo message success with valid registration
  - Photo message rejection for unregistered chats
  - File naming collision handling
  - Error handling for failed downloads
  - OCR pipeline trigger placeholder
- All 52 unit tests passing (27 telegram bot tests + 25 existing tests)
- Code formatted with Black (line length 100)
- **Note on mypy**: Pre-existing type issues in [src/integrations/telegram_bot.py](src/integrations/telegram_bot.py) related to:
  - [src/utils/logging_config.py:42,52](src/utils/logging_config.py:42) - Implicit Optional and BoundLogger return type
  - Telegram library optional attributes (Update.effective_user, Update.message, etc.) - handled with try-except blocks
  - These are pre-existing issues from Phase 0, not introduced by this story

### Post-Implementation Issues and Fixes
**Issue 1: Event Loop Conflict on Bot Startup**
- **Problem**: Bot failed to start with error "Cannot close a running event loop" and coroutine warnings
- **Root Cause**: `python-telegram-bot`'s `run_polling()` manages its own event loop internally, but code was wrapping it in `asyncio.run()` creating conflicting loops
- **Fix Applied** [src/integrations/telegram_bot.py](src/integrations/telegram_bot.py:588-611):
  - Changed `run()` method from async to sync
  - Changed `main()` function from async to sync
  - Removed `asyncio.run()` wrapper
  - Removed custom signal handlers (run_polling handles SIGINT/SIGTERM automatically)
  - Removed unused `signal` import
  - Added `drop_pending_updates=True` flag to clear old messages on startup
- **Result**: Bot now starts cleanly without event loop conflicts

**Issue 2: Insufficient User Feedback**
- **Problem**: Bot ran silently with no visible output, causing confusion about whether it was working
- **Fix Applied** [src/integrations/telegram_bot.py](src/integrations/telegram_bot.py:592-608):
  - Added startup banner with bot configuration details
  - Added console output for `/start` command (line 122)
  - Added console output for chat registration (line 194-196)
  - Added console output for photo uploads with bet ID and filename (line 467-468)
  - Added shutdown banner on Ctrl+C
- **Result**: Clear, friendly console messages showing bot activity and status

### File List
- Modified: [src/integrations/telegram_bot.py](src/integrations/telegram_bot.py)
- Modified: [tests/unit/test_telegram_bot.py](tests/unit/test_telegram_bot.py)

## QA Results

### Review Date: 2025-10-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation demonstrates high-quality code that fully meets all acceptance criteria. The code follows established patterns from Phase 0 and extends them appropriately. Key strengths include:

1. **Comprehensive Error Handling**: All methods include proper try-catch blocks with structured logging
2. **Clean Separation of Concerns**: Database operations, file handling, and bot logic are well-separated
3. **Proper Async/Await Usage**: Correct implementation of async patterns for Telegram bot handlers
4. **Thoughtful File Naming**: Collision handling with counter suffix is robust
5. **Security Considerations**: Proper validation of chat registrations before processing

### Refactoring Performed

No refactoring was required as the implementation already follows best practices and coding standards.

### Compliance Check

- Coding Standards: ✓ All code follows PEP 8 with 100-character line limit
- Project Structure: ✓ Files placed in correct locations per architecture
- Testing Strategy: ✓ Comprehensive unit tests covering all acceptance criteria
- All ACs Met: ✓ All 4 acceptance criteria fully implemented

### Improvements Checklist

- [x] Verified all acceptance criteria are implemented
- [x] Confirmed proper error handling for unknown chat IDs
- [x] Validated file naming collision handling
- [x] Checked database operations use parameterized queries
- [x] Confirmed proper async/await patterns
- [x] Verified structured logging throughout
- [x] Confirmed rate limiting is preserved from Phase 0
- [ ] Consider adding integration tests for end-to-end screenshot processing flow
- [ ] Consider adding performance tests for large screenshot handling

### Security Review

- ✓ Input validation for chat registrations
- ✓ SQL injection prevention via parameterized queries
- ✓ File path handling prevents directory traversal
- ✓ Rate limiting preserved from Phase 0 implementation
- ✓ No sensitive information logged

### Performance Considerations

- ✓ Efficient file handling with collision detection
- ✓ Database connections properly closed after operations
- ✓ Async processing prevents blocking
- ✓ No identified performance bottlenecks for expected usage patterns

### Files Modified During Review

No files were modified during this review as the implementation already meets quality standards.

### Gate Status

Gate: PASS → docs/qa/gates/1.1.telegram-screenshot-ingestion.yml
Risk profile: docs/qa/assessments/1.1.telegram-screenshot-ingestion-risk-20251030.md
NFR assessment: docs/qa/assessments/1.1.telegram-screenshot-ingestion-nfr-20251030.md

### Recommended Status

✓ Ready for Done