# Story 9.6: Telegram Confirm Before Ingest

## Status
Ready for Review

## Story
**As a** Telegram bot user,
**I want** to confirm bet screenshots before they are ingested into the system,
**so that** only real bet screenshots are processed and I can provide accurate stake and potential win information at the moment of confirmation.

## Acceptance Criteria
1. When a photo is sent to the bot, it is treated as "pending" and not immediately ingested
2. The bot immediately replies with confirmation prompt including "Ingest" and "Discard" buttons
3. Users can confirm via text commands (yes, ingest, #bet) with optional stake amounts
4. Users can confirm via button tap, followed by optional stake input
5. Users can discard via text commands (no, skip, discard, #skip) or "Discard" button
6. Pending photos are automatically discarded after 60 minutes if no response
7. Confirmed photos are saved to normal screenshots area and processed via existing OCR pipeline
8. Manual stake and potential win values provided during confirmation are stored as overrides
9. Confirmation messages are clearly tied to specific photos to avoid confusion in busy chats
10. Existing OCR and downstream processing work exactly as before once a photo is confirmed

## Tasks / Subtasks
- [x] Task 1: Implement pending photo state management (AC: 1, 6)
  - [x] Subtask 1.1: Create database schema for pending photos with timestamp
  - [x] Subtask 1.2: Implement automatic cleanup of expired pending photos (60+ minutes)
- [x] Task 2: Create confirmation message flow (AC: 2, 9)
  - [x] Subtask 2.1: Design confirmation prompt message with buttons
  - [x] Subtask 2.2: Implement message threading to tie confirmations to specific photos
- [x] Task 3: Implement text-based confirmation parsing (AC: 3, 5)
  - [x] Subtask 3.1: Parse confirmation commands (yes, ingest, #bet)
  - [x] Subtask 3.3: Parse discard commands (no, skip, discard, #skip)
  - [x] Subtask 3.2: Parse stake amounts with decimal support and currency symbol handling
  - [x] Subtask 3.4: Parse potential win amounts with "win=" syntax
- [x] Task 4: Implement button-based confirmation flow (AC: 4, 5)
  - [x] Subtask 4.1: Add inline keyboard with "Ingest" and "Discard" buttons
  - [x] Subtask 4.2: Handle button callbacks and initiate stake input flow if needed
  - [x] Subtask 4.3: Create stake input dialog with optional win= support
- [x] Task 5: Integrate with existing ingestion pipeline (AC: 7, 8, 10)
  - [x] Subtask 5.1: Move confirmed photo to normal screenshots storage
  - [x] Subtask 5.2: Create bet entry with manual stake/win override fields
  - [x] Subtask 5.3: Trigger existing OCR/extraction pipeline
- [x] Task 6: Implement confirmation messaging (AC: 10)
  - [x] Subtask 6.1: Create success confirmation messages with stake/win details
  - [x] Subtask 6.2: Add "Processing screenshot..." status indicator
- [x] Task 7: Add error handling and edge cases (AC: 9)
  - [x] Subtask 7.1: Handle responses that don't reply to correct message/photo
  - [x] Subtask 7.2: Validate stake and win amounts (positive numbers, reasonable limits)
  - [x] Subtask 7.3: Handle malformed input gracefully with helpful error messages

## Dev Notes
### Relevant Source Tree
- `src/integrations/telegram_bot.py` - Main Telegram bot integration
- `src/services/bet_ingestion.py` - Existing bet ingestion service
- `src/core/database.py` - Database schema and connection management
- `src/core/schema.py` - Core data models

### Existing Pattern Reference
This story should follow the existing Telegram bot pattern established in stories 1.1, 1.2, and 9.1-9.5:
- Use existing message handling patterns in `telegram_bot.py`
- Follow existing bet creation flow in `bet_ingestion.py`
- Use existing database connection and transaction patterns
- Maintain consistent error handling and logging

### Key Constraints
- Must not break existing Telegram bot functionality
- Must maintain backwards compatibility with existing OCR pipeline
- Must handle concurrent photo submissions gracefully
- Must work within Telegram's rate limits and message size constraints

### Testing
#### Test Standards
- Test file location: `tests/unit/` and `tests/integration/`
- Testing frameworks: pytest for unit tests, integration tests for end-to-end flows
- Mock external dependencies (Telegram API, OCR service)
- Test all confirmation paths: text commands, button interactions, timeout scenarios

#### Specific Testing Requirements
- Unit tests for parsing stake/win amounts with various formats
- Integration tests for full confirmation flow end-to-end
- Tests for automatic cleanup of expired pending photos
- Tests for concurrent photo submissions
- Tests for error handling and edge cases
- Tests for message threading correctness in busy chats

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex

### Debug Log References
- `pytest tests/unit/test_telegram_bot.py`

### Completion Notes List
- Implemented pending screenshot queue with inline confirmations, text parsing, and timeout cleanup before ingestion.
- Added manual stake/win override plumbing through the schema and Telegram bet creation flow.
- Updated bot unit tests to cover the new behaviors and parsing edge cases.

### File List
- src/core/schema.py
- src/integrations/telegram_bot.py
- tests/unit/test_telegram_bot.py
- docs/stories/9.6.telegram-confirm-before-ingest.md

## QA Results

### Risk Assessment
- **Complexity**: 4/5 (High)
- **Data Sensitivity**: Medium (Financial bet data, user stakes)
- **Integration Risk**: 4/5 (High - Telegram API, OCR pipeline, database)
- **Overall Risk Score**: 16 (High Risk)

### NFR Analysis
- **Security**: CONCERNS (Input validation needed for stake amounts, potential injection risks)
- **Performance**: PASS (Low computational overhead, efficient cleanup)
- **Reliability**: CONCERNS (Concurrent photo handling, message threading complexity)
- **Usability**: PASS (Clear confirmation flow, multiple interaction methods)
- **Maintainability**: PASS (Well-structured tasks, follows existing patterns)

### Test Strategy
- **Unit Tests**: ✅ Comprehensive coverage achieved (39/39 tests passing)
  - PendingConfirmationParsing: 4/4 tests passing (confirm/discard/amount parsing, validation)
  - PhotoMessageHandling: 4/4 tests passing (success, error handling, collision detection)
  - All core telegram bot functionality tested
- **Integration Tests**: ⚠️ Partial coverage achieved
  - Telegram approval workflow: 2/2 tests passing
  - Settlement confirmation tests: 2/2 failing due to unrelated schema issues
  - Missing: End-to-end confirmation flow integration tests
- **E2E Tests**: ❌ Not implemented - multi-user concurrent scenarios not tested
- **Edge Cases**: ✅ Good coverage for parsing validation, but missing concurrent scenario tests

### Requirements Traceability
- **AC1**: ✅ Mapped to pending photo state management tests
- **AC2**: ✅ Mapped to confirmation message flow tests
- **AC3**: ✅ Mapped to text-based confirmation parsing tests
- **AC4**: ✅ Mapped to button-based confirmation flow tests
- **AC5**: ✅ Mapped to discard handling tests
- **AC6**: ✅ Mapped to automatic cleanup tests
- **AC7**: ✅ Mapped to ingestion pipeline integration tests
- **AC8**: ✅ Mapped to manual override storage tests
- **AC9**: ✅ Mapped to message threading tests
- **AC10**: ✅ Mapped to downstream processing tests

### Quality Gate Decision
- **Decision**: CONCERNS
- **Risk Score**: 16 (High Risk)
- **Rationale**: Story implements comprehensive confirmation flow with good acceptance criteria coverage, but high complexity in concurrent photo handling and message threading introduces reliability concerns. Security concerns around input validation require attention before production deployment.
- **Recommendations**:
  1. Implement robust input validation and sanitization for stake/win amounts
  2. Add comprehensive concurrent photo handling tests with race condition coverage
  3. Implement message threading conflict resolution for busy chat scenarios
  4. Add monitoring and alerting for pending photo queue overflow scenarios
  5. Create error recovery procedures for OCR pipeline failures

**QA Engineer**: Quinn - Test Architect
**Date**: 2025-11-09T22:24:48+08:00
