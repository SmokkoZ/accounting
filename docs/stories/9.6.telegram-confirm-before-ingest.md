# Story 9.6: Telegram Confirm Before Ingest

## Status
Approved

## Story
**As a** Telegram bot user,
**I want** to confirm bet screenshots before they are ingested into the system,
**so that** only real bet screenshots are processed and I can provide accurate stake and potential win information at the moment of confirmation.

## Acceptance Criteria
1. When a photo is sent to the bot, it is treated as "pending" and not immediately ingested
2. The bot immediately replies with confirmation prompt including "Ingest" and "Discard" buttons
3. Users can confirm via text commands (yes, ingest, #bet) with optional stake amounts
4. Users can confirm via button tap, followed by optional stake input
5. Users can discard via text commands (no, skip, discard, #skip) or "Discard" button
6. Pending photos are automatically discarded after 60 minutes if no response
7. Confirmed photos are saved to normal screenshots area and processed via existing OCR pipeline
8. Manual stake and potential win values provided during confirmation are stored as overrides
9. Confirmation messages are clearly tied to specific photos to avoid confusion in busy chats
10. Existing OCR and downstream processing work exactly as before once a photo is confirmed

## Tasks / Subtasks
- [ ] Task 1: Implement pending photo state management (AC: 1, 6)
  - [ ] Subtask 1.1: Create database schema for pending photos with timestamp
  - [ ] Subtask 1.2: Implement automatic cleanup of expired pending photos (60+ minutes)
- [ ] Task 2: Create confirmation message flow (AC: 2, 9)
  - [ ] Subtask 2.1: Design confirmation prompt message with buttons
  - [ ] Subtask 2.2: Implement message threading to tie confirmations to specific photos
- [ ] Task 3: Implement text-based confirmation parsing (AC: 3, 5)
  - [ ] Subtask 3.1: Parse confirmation commands (yes, ingest, #bet)
  - [ ] Subtask 3.3: Parse discard commands (no, skip, discard, #skip)
  - [ ] Subtask 3.2: Parse stake amounts with decimal support and currency symbol handling
  - [ ] Subtask 3.4: Parse potential win amounts with "win=" syntax
- [ ] Task 4: Implement button-based confirmation flow (AC: 4, 5)
  - [ ] Subtask 4.1: Add inline keyboard with "Ingest" and "Discard" buttons
  - [ ] Subtask 4.2: Handle button callbacks and initiate stake input flow if needed
  - [ ] Subtask 4.3: Create stake input dialog with optional win= support
- [ ] Task 5: Integrate with existing ingestion pipeline (AC: 7, 8, 10)
  - [ ] Subtask 5.1: Move confirmed photo to normal screenshots storage
  - [ ] Subtask 5.2: Create bet entry with manual stake/win override fields
  - [ ] Subtask 5.3: Trigger existing OCR/extraction pipeline
- [ ] Task 6: Implement confirmation messaging (AC: 10)
  - [ ] Subtask 6.1: Create success confirmation messages with stake/win details
  - [ ] Subtask 6.2: Add "Processing screenshot..." status indicator
- [ ] Task 7: Add error handling and edge cases (AC: 9)
  - [ ] Subtask 7.1: Handle responses that don't reply to correct message/photo
  - [ ] Subtask 7.2: Validate stake and win amounts (positive numbers, reasonable limits)
  - [ ] Subtask 7.3: Handle malformed input gracefully with helpful error messages

## Dev Notes
### Relevant Source Tree
- `src/integrations/telegram_bot.py` - Main Telegram bot integration
- `src/services/bet_ingestion.py` - Existing bet ingestion service
- `src/core/database.py` - Database schema and connection management
- `src/core/schema.py` - Core data models

### Existing Pattern Reference
This story should follow the existing Telegram bot pattern established in stories 1.1, 1.2, and 9.1-9.5:
- Use existing message handling patterns in `telegram_bot.py`
- Follow existing bet creation flow in `bet_ingestion.py`
- Use existing database connection and transaction patterns
- Maintain consistent error handling and logging

### Key Constraints
- Must not break existing Telegram bot functionality
- Must maintain backwards compatibility with existing OCR pipeline
- Must handle concurrent photo submissions gracefully
- Must work within Telegram's rate limits and message size constraints

### Testing
#### Test Standards
- Test file location: `tests/unit/` and `tests/integration/`
- Testing frameworks: pytest for unit tests, integration tests for end-to-end flows
- Mock external dependencies (Telegram API, OCR service)
- Test all confirmation paths: text commands, button interactions, timeout scenarios

#### Specific Testing Requirements
- Unit tests for parsing stake/win amounts with various formats
- Integration tests for full confirmation flow end-to-end
- Tests for automatic cleanup of expired pending photos
- Tests for concurrent photo submissions
- Tests for error handling and edge cases
- Tests for message threading correctness in busy chats

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
### Agent Model Used
<!-- To be populated by development agent -->

### Debug Log References
<!-- To be populated by development agent -->

### Completion Notes List
<!-- To be populated by development agent -->

### File List
<!-- To be populated by development agent -->

## QA Results
<!-- To be populated by QA agent -->
