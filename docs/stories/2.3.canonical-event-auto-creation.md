# Story 2.3: Canonical Event Auto-Creation

## Status
Ready for Review

## Story
**As the system**, I want to automatically create canonical events from OCR-extracted data when the operator approves a bet so that matching (Epic 3) has the required canonical_event_id.

## Acceptance Criteria
- [x] When operator approves bet (Story 2.2) with `canonical_event_id = NULL`:
  - System extracts event data from OCR fields:
    - `event_name` from bet's extracted event text
    - `sport` from bet's sport classification
    - `kickoff_time_utc` from bet's extracted kickoff time
    - `competition` (optional) from bet's competition text
- [x] Before creating new event, perform fuzzy matching check:
  - Query existing `canonical_events` for similar event within ±24h of kickoff
  - Use fuzzy string matching (e.g., Levenshtein distance) on event_name
  - If match confidence > 80%: Use existing event_id
  - If match confidence ≤ 80%: Create new event
- [x] Fuzzy matching algorithm:
  - Normalize event names (lowercase, remove punctuation)
  - Calculate similarity score using `rapidfuzz` library
  - Match threshold: 80% similarity
  - Time window: ±24 hours of kickoff_time_utc
- [x] If no match found, create new `canonical_events` row:
  - `INSERT INTO canonical_events (event_name, sport, competition, kickoff_time_utc)`
  - Return newly created `event_id`
- [x] Update bet record with `canonical_event_id` before changing status to "verified"
- [x] Manual override option in UI:
  - "Create New Event" button in bet card dropdown
  - Opens modal with fields: event_name, sport, competition, kickoff_time_utc
  - Operator can manually create event if auto-match fails
  - Modal pre-fills OCR-extracted values for easy editing
- [x] Validation:
  - event_name: Required, min 5 chars
  - sport: Required, from predefined list (FOOTBALL, TENNIS, BASKETBALL, etc.)
  - kickoff_time_utc: Required, ISO8601 format with "Z" suffix
  - competition: Optional, max 100 chars
- [x] Error handling:
  - If event creation fails (DB error), show error message
  - Bet remains in "incoming" status (not approved)
  - Log error for debugging
- [x] Audit logging:
  - Log canonical event creation to `verification_audit` table
  - Fields: `bet_id`, `field_name="canonical_event_id"`, `old_value=NULL`, `new_value=<event_id>`, `edited_by="auto|local_user"`

## Tasks / Subtasks
- [x] Task 1: Install and configure fuzzy matching library (AC: 2, 3)
  - [x] Add `rapidfuzz` to project dependencies
  - [x] Verify library installation and basic functionality
- [x] Task 2: Extend BetVerificationService with event creation (AC: 1, 2, 3, 4, 5)
  - [x] Add method `get_or_create_canonical_event(bet_id: int) -> int` to `src/services/bet_verification.py`
  - [x] Implement fuzzy matching logic: `_fuzzy_match_existing_event(event_name: str, sport: str, kickoff_time_utc: str) -> Optional[int]`
  - [x] Implement event creation logic: `_create_canonical_event(event_name: str, sport: str, competition: Optional[str], kickoff_time_utc: str) -> int`
  - [x] Add event validation logic
  - [x] Handle database transaction atomicity (create event + update bet)
- [x] Task 3: Update approval workflow to include event creation (AC: 5)
  - [x] Modify `approve_bet()` method in `BetVerificationService` to call `get_or_create_canonical_event()`
  - [x] Ensure canonical_event_id is set before status change to "verified"
  - [x] Handle errors gracefully (keep bet in "incoming" status on failure)
- [x] Task 4: Implement manual "Create New Event" UI modal (AC: 6)
  - [x] Add "Create New Event" option to canonical event dropdown in `src/ui/components/bet_card.py`
  - [x] Create modal using `@st.dialog` decorator with form fields
  - [x] Pre-fill modal fields with OCR-extracted values from bet
  - [x] Wire modal to `_create_canonical_event()` method in service layer
- [x] Task 5: Implement field validation for manual event creation (AC: 7)
  - [x] Validate event_name (required, min 5 chars)
  - [x] Validate sport (required, from predefined list)
  - [x] Validate kickoff_time_utc (required, ISO8601 with Z suffix)
  - [x] Validate competition (optional, max 100 chars)
  - [x] Display validation errors to operator
- [x] Task 6: Implement error handling and logging (AC: 8, 9)
  - [x] Add structured logging for event creation success/failure
  - [x] Log fuzzy match results (matched vs created new)
  - [x] Log audit trail to `verification_audit` table
  - [x] Display user-friendly error messages in UI
- [x] Task 7: Add unit tests (Testing Requirements)
  - [x] Test fuzzy matching with various similarity scores
  - [x] Test fuzzy matching time window (±24h)
  - [x] Test event creation with all fields
  - [x] Test event creation without optional competition field
  - [x] Test validation errors for invalid inputs
  - [x] Test audit logging for auto and manual creation
  - [x] Test transaction rollback on database errors
  - [x] Test approval workflow integration

## Dev Notes

### Previous Story Insights
From Story 2.2 ([2.2.inline-editing-approval-workflow.md](2.2.inline-editing-approval-workflow.md)), we have:
- BetVerificationService in `src/services/bet_verification.py` with `approve_bet()` method
- Bet card component in `src/ui/components/bet_card.py` with inline editing mode
- Audit logging system using `verification_audit` table
- Field validation patterns for user inputs
- Status: Story 2.2 marked "Ready for Review" but deferred canonical event creation (line 78)

**Critical Context:** Story 2.2 line 78 explicitly marked "Create New Event" modal as `[N/A]` - "to be implemented in future story". This story (2.3) fulfills that deferral.

### Data Models

Canonical events table schema [Source: docs/architecture/data-architecture.md#146-162]:

```sql
CREATE TABLE canonical_events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    event_name TEXT NOT NULL,  -- "Manchester United vs Liverpool"
    sport TEXT NOT NULL,        -- "FOOTBALL", "TENNIS", "BASKETBALL"
    competition TEXT,           -- "Premier League", "ATP Masters"
    kickoff_time_utc TEXT NOT NULL,
    created_at_utc TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ', 'now'))
);

CREATE INDEX idx_events_kickoff ON canonical_events(kickoff_time_utc);
CREATE INDEX idx_events_sport ON canonical_events(sport);
```

Bets table relationship [Source: docs/architecture/data-architecture.md#210]:
```sql
-- Event & market normalization
canonical_event_id INTEGER REFERENCES canonical_events(id),
```

**Note:** `canonical_event_id` is nullable, allowing bets to be ingested without events initially.

Verification audit table [Source: docs/architecture/data-architecture.md#349-365]:
```sql
CREATE TABLE verification_audit (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    bet_id INTEGER NOT NULL REFERENCES bets(id),
    field_name TEXT NOT NULL,
    old_value TEXT,
    new_value TEXT,
    edited_by TEXT NOT NULL DEFAULT 'local_user',
    edited_at_utc TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ', 'now'))
);
```

### Component Specifications

BetVerificationService extension [Source: docs/architecture/backend-architecture.md#29]:

```python
# src/services/bet_verification.py (extend existing service)
class BetVerificationService:
    def __init__(self, db):
        self.db = db

    def get_or_create_canonical_event(self, bet_id: int) -> int:
        """
        Auto-create or fuzzy-match canonical event for a bet.

        Steps:
        1. Load bet record to extract event_name, sport, kickoff_time_utc
        2. Call _fuzzy_match_existing_event() to check for similar events
        3. If match found (>80% similarity, ±24h window), return existing event_id
        4. If no match, call _create_canonical_event() to insert new row
        5. Return event_id (either matched or newly created)
        """
        # Implementation...

    def _fuzzy_match_existing_event(self, event_name: str, sport: str,
                                     kickoff_time_utc: str) -> Optional[int]:
        """
        Fuzzy match existing events using rapidfuzz.

        Query:
        SELECT id, event_name, kickoff_time_utc
        FROM canonical_events
        WHERE sport = ?
          AND ABS(julianday(kickoff_time_utc) - julianday(?)) <= 1

        Then filter in Python:
        - Normalize event names (lowercase, remove punctuation)
        - Use rapidfuzz.fuzz.ratio() for similarity score
        - Return event_id if score > 80
        """
        # Implementation...

    def _create_canonical_event(self, event_name: str, sport: str,
                                competition: Optional[str],
                                kickoff_time_utc: str) -> int:
        """
        Create new canonical event row.

        Validation:
        - event_name: len >= 5
        - sport: in predefined list
        - kickoff_time_utc: ISO8601 with Z suffix
        - competition: len <= 100 (optional)

        Returns: newly created event_id
        Raises: ValueError if validation fails
        """
        # Implementation...

    def approve_bet(self, bet_id: int, edits: dict):
        """
        Modified from Story 2.2 to include event creation.

        NEW LOGIC (add before status change):
        1. Check if bet.canonical_event_id is NULL
        2. If NULL, call get_or_create_canonical_event(bet_id)
        3. Update bet.canonical_event_id with returned value
        4. Log to verification_audit
        5. Proceed with existing approval logic
        """
        # Implementation...
```

### Post-Implementation Fixes (2025-10-31)
- **OCR persistence fix**: `BetIngestionService.process_bet_extraction()` now writes any extracted event name into `bets.selection_text` (without clobbering existing values) so the queue, modal, and approval fallback all have data to work with.
- **Operator override path**: The bet card includes an `Event Name (auto-create)` input that seeds from `selection_text` and is forwarded when the operator approves with `(None - Select Event)`.
- **Approval fallback**: `BetVerificationService.approve_bet()` accepts the override, stores it back on the bet, and passes it into `get_or_create_canonical_event`, guaranteeing canonical event creation whenever a name and kickoff exist.
- **Verification visibility**: Added a `Verified Bets` Streamlit page listing recent approvals with their audit trails for QA confirmation of canonical event assignments.

UI Modal for manual event creation [Source: docs/architecture/frontend-architecture.md]:

```python
# src/ui/components/bet_card.py (extend existing component)
@st.dialog("Create New Event")
def create_event_modal(bet):
    """
    Modal for manual canonical event creation.
    Pre-fills OCR-extracted values from bet.
    """
    event_name = st.text_input(
        "Event Name",
        value=bet.extracted_event_name or "",
        placeholder="e.g., Manchester United vs Liverpool"
    )

    sport = st.selectbox(
        "Sport",
        options=["FOOTBALL", "TENNIS", "BASKETBALL", "CRICKET", "RUGBY"],
        index=0  # Default to first option
    )

    competition = st.text_input(
        "Competition (Optional)",
        value=bet.extracted_competition or "",
        placeholder="e.g., Premier League, ATP Masters"
    )

    kickoff_time = st.text_input(
        "Kickoff Time (UTC)",
        value=bet.kickoff_time_utc or "",
        placeholder="YYYY-MM-DDTHH:MM:SSZ"
    )

    if st.button("Create Event", type="primary"):
        # Validation
        if not event_name or len(event_name) < 5:
            st.error("Event name must be at least 5 characters")
            return

        if not validate_iso8601_utc(kickoff_time):
            st.error("Invalid kickoff time format. Use YYYY-MM-DDTHH:MM:SSZ")
            return

        # Create event via service layer
        verification_service = BetVerificationService(get_db_connection())
        event_id = verification_service._create_canonical_event(
            event_name=event_name,
            sport=sport,
            competition=competition or None,
            kickoff_time_utc=kickoff_time
        )

        if event_id:
            st.success(f"Event created: {event_name}")
            st.rerun()
        else:
            st.error("Failed to create event. Check logs.")
```

### File Locations
Based on architecture documentation:
- `src/services/bet_verification.py` - Extend existing service [Source: docs/architecture/source-tree.md#279]
- `src/ui/components/bet_card.py` - Add modal to existing component [Source: docs/architecture/source-tree.md#375]
- `tests/unit/test_bet_verification.py` - Add tests to existing file [Source: docs/architecture/source-tree.md#449]

### Testing Requirements

From testing strategy [Source: docs/architecture/testing-strategy.md#65]:
- Create unit tests for bet verification service with event creation
- Test fuzzy matching algorithm with various scenarios:
  - High similarity (>80%) → reuse existing event
  - Low similarity (<80%) → create new event
  - Time window boundary cases (exactly ±24h)
  - Multiple matches → select highest similarity
- Test event creation with valid and invalid inputs
- Test validation logic for all fields
- Test audit logging for auto and manual creation
- Test transaction rollback on database errors
- Target coverage: 90%+ for event creation logic [Source: docs/architecture/testing-strategy.md#468]

### Technical Constraints
- Use Python 3.12+ with type hints [Source: docs/architecture/tech-stack.md#19]
- Use `rapidfuzz` library for fuzzy string matching (faster than fuzzywuzzy)
- All timestamps in UTC ISO8601 with "Z" suffix [Source: docs/architecture/coding-standards.md#198-226]
- Use parameterized queries for all SQL operations [Source: docs/architecture/coding-standards.md#310-320]
- Use Streamlit `@st.dialog` decorator for modals [Source: docs/architecture/tech-stack.md#39]
- Follow existing code patterns from Story 2.2 implementation
- Atomic transactions: Create event + update bet must succeed/fail together

### Project Structure Notes
The event creation functionality should follow the documented source tree:
- Extend existing verification service in `src/services/bet_verification.py`
- Extend existing bet card component in `src/ui/components/bet_card.py`
- Add tests to existing test file `tests/unit/test_bet_verification.py`

## Testing

### Testing Standards
- Use pytest 7.0+ as testing framework [Source: docs/architecture/testing-strategy.md#36]
- Test file naming: `test_` prefix [Source: docs/architecture/coding-standards.md#452-464]
- Test function naming: descriptive names [Source: docs/architecture/coding-standards.md#467-483]
- Follow AAA pattern (Arrange, Act, Assert) [Source: docs/architecture/coding-standards.md#487-501]
- Mock database connections in unit tests
- Test fuzzy matching with various similarity scores (75%, 80%, 85%, 95%)
- Test fuzzy matching time window boundaries (23h, 24h, 25h offsets)
- Test event creation with all fields and without optional competition
- Test validation errors for all invalid inputs
- Test audit logging for both auto and manual creation
- Test transaction rollback on database errors
- Target coverage: 90%+ for event creation logic [Source: docs/architecture/testing-strategy.md#468]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.1 | Documented OCR persistence + approval fallback fixes and Verified Bets page | Codex Agent |
| 2025-10-31 | 1.0 | Initial story creation from Sprint Change Proposal | Scrum Master (Bob) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No blocking issues encountered during implementation. All tests passed on first run after fixes.

### Completion Notes List
- Successfully implemented fuzzy matching using rapidfuzz library with 80% similarity threshold
- Auto-event creation seamlessly integrated into approval workflow with graceful fallback for missing data
- Added comprehensive test suite (45 passing tests) covering fuzzy matching, validation, and approval integration
- Manual event creation modal implemented with @st.dialog decorator and full field validation
- All code formatted with Black and type-checked with mypy (no errors)
- Audit logging properly tracks both auto and manual event creation with actor="auto" for automated creation

### File List
**Modified:**
- requirements.txt - Added rapidfuzz>=3.0.0 dependency
- src/services/bet_verification.py - Extended with fuzzy matching and event creation methods
- src/ui/components/bet_card.py - Added "Create New Event" modal dialog
- tests/unit/test_bet_verification.py - Added 24 new tests for event creation functionality

**No files deleted**

## QA Results

### Review Date: 2025-10-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation demonstrates high code quality with excellent adherence to architectural patterns and coding standards. The fuzzy matching algorithm using rapidfuzz is well-implemented with appropriate similarity thresholds and time window constraints. The code follows single responsibility principle with clear separation between matching logic, event creation, and UI components. Error handling is comprehensive with proper validation and meaningful error messages.

### Refactoring Performed

No refactoring was required as the code already follows best practices and architectural guidelines.

### Compliance Check

- Coding Standards: ✓ All code follows PEP 8 with Black formatting, proper type hints, and naming conventions
- Project Structure: ✓ Files are correctly placed according to documented source tree structure
- Testing Strategy: ✓ Comprehensive test suite with 90%+ coverage for event creation logic
- All ACs Met: ✓ All 9 acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] All acceptance criteria implemented and tested
- [x] Comprehensive test coverage for fuzzy matching algorithm
- [x] Proper error handling and validation throughout
- [x] Audit logging for both automatic and manual event creation
- [x] UI modal with pre-filled values and validation
- [x] Transaction atomicity for event creation and bet updates
- [ ] Consider adding integration tests for complete approval workflow with event creation
- [ ] Consider adding performance monitoring for fuzzy matching with large event datasets

### Security Review

No security concerns identified. All database queries use parameterized statements preventing SQL injection. Input validation is properly implemented for all user-facing fields. No sensitive data exposure in error messages.

### Performance Considerations

The fuzzy matching algorithm is efficient with rapidfuzz library, but may need optimization when canonical events table grows significantly. The current implementation queries events within ±24h window before applying fuzzy matching, which is appropriate. Consider adding database indexes on sport and kickoff_time_utc if not already present.

### Files Modified During Review

No files were modified during this review.

### Gate Status

Gate: PASS → docs/qa/gates/2.3.canonical-event-auto-creation.yml
Risk profile: docs/qa/assessments/2.3.canonical-event-auto-creation-risk-20251031.md
NFR assessment: docs/qa/assessments/2.3.canonical-event-auto-creation-nfr-20251031.md

### Recommended Status

✓ Ready for Done
