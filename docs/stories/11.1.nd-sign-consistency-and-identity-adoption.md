# Story 11.1: ND Sign Consistency and Identity Adoption

## Status
Approved

## Story
**As a** single-operator accountant
**I want** ND sign handling to be consistent and the YF = ND + FS identity adopted across read models
**so that** all surfaces compute entitlements and imbalances precisely without manual corrections

## Acceptance Criteria
1. AC1: ND equals deposits - withdrawals everywhere; withdrawals stored negative; tests cover mixed deposit/withdrawal scenarios.
2. AC2: FS aggregates from BET_RESULT share fields; tests cover VOID/WON/LOST handling.
3. AC3: YF = ND + FS in Reconciliation, Statements, Bookmaker views, and CSVs; tests assert identities (YF - ND = FS).
4. AC4: I'' = TB - YF; "Settle Associate Now" posts a single ledger entry to zero I''; post-action I'' == 0 and CSV reflects payout.
5. AC5: Backward compatibility notes updated; labels clarified; no schema changes required.

## Tasks / Subtasks
- [ ] Task 1: Normalize ND sign handling (AC: 1)
  - [ ] Audit `src/services/ledger_entry_service.py` and any helpers that create DEPOSIT/WITHDRAWAL rows to ensure negatives for withdrawals, positives for deposits, and document the contract [Source: docs/architecture/backend-architecture.md#change-notes---yf--exit-settlement-alignment-2025-11-13].
  - [x] Update reconciliation, statement, and bookmaker financial read paths to compute ND by summing signed amounts without double-negation [Source: docs/architecture/backend-architecture.md#change-notes---yf--exit-settlement-alignment-2025-11-13].
  - [x] Add unit tests that cover mixed DEPOSIT/WITHDRAWAL inputs validating ND math [Source: docs/architecture/testing-strategy.md].
- [ ] Task 2: Implement YF identity in read models (AC: 2, 3)
  - [x] Extend `reconciliation_service` DTOs to expose ND, FS, YF, TB, and I'' while mapping legacy `should_hold_eur` to `yf_eur` [Source: docs/architecture/backend-architecture.md#change-notes---yf--exit-settlement-alignment-2025-11-13].
  - [x] Ensure FS pulls from BET_RESULT share fields and honors WON/LOST/VOID semantics already enforced in settlement math [Source: docs/prd/epic-11-fair-balance-exit-settlement.md].
  - [x] Add unit tests that assert YF - ND = FS and I'' = TB - YF for reconciliation aggregates [Source: docs/architecture/testing-strategy.md].
- [x] Task 3: Adopt identity in statements and bookmaker views (AC: 2, 3, 4)
  - [x] Update `statement_service.py` (and CSV/export helpers) to emit ND/FS/YF/I'' consistently so UI and exports can show the identity fields [Source: docs/prd/epic-11-fair-balance-exit-settlement.md].
  - [x] Align `bookmaker_financials_service.py` (or equivalent view) with the same ND and YF math, exposing I'' alongside TB [Source: docs/prd/epic-11-fair-balance-exit-settlement.md].
  - [x] Expand integration coverage in `tests/integration/test_settlement_flow.py` (or add a dedicated test) to assert ND/FS/YF/TB/I'' after settlement, including VOID cases [Source: docs/architecture/testing-strategy.md].
- [x] Task 4: Backward compatibility and "Settle Associate Now" readiness (AC: 4, 5)
  - [x] Confirm no schema or API contract changes are needed; map existing `should_hold_eur` fields to the new YF naming in Streamlit models [Source: docs/architecture/backend-architecture.md#change-notes---yf--exit-settlement-alignment-2025-11-13].
  - [x] Document how the updated read models will be consumed by the upcoming "Settle Associate Now" flow so a single ledger entry can zero I'' without additional refactors [Source: docs/prd/epic-11-fair-balance-exit-settlement.md].
- [ ] Task 5: Testing and coverage (AC: 1-5)
  - [x] Add regression tests ensuring backward-compatible CSV output (old columns still present while new values align with YF identity) [Source: docs/prd/epic-11-fair-balance-exit-settlement.md].
  - [ ] Run `pytest --cov=src --cov-report=term-missing` and ensure coverage goals for ledger/reconciliation logic (90%+) and settlement math (95%+) are met [Source: docs/architecture/testing-strategy.md].

## Dev Notes

### Previous Story Insights
- No prior Epic 11 stories exist, so there are no legacy implementation notes or deviations to consider.

### Data Models
- Reconciliation, statement, and bookmaker view DTOs must expose ND, FS, YF, TB, and I'' while mapping the legacy `should_hold_eur` field to `yf_eur`; no schema updates are permitted [Source: docs/architecture/backend-architecture.md#change-notes---yf--exit-settlement-alignment-2025-11-13].

### Service Logic
- Ledger semantics: persist withdrawals as negative values and deposits as positive, then sum stored values exactly once wherever ND is computed [Source: docs/architecture/backend-architecture.md#change-notes---yf--exit-settlement-alignment-2025-11-13].
- Identity enforcement: reuse the existing settlement/statement math so FS remains sourced from BET_RESULT share rows while ensuring every read model enforces `YF = ND + FS` and `I'' = TB - YF` [Source: docs/prd/epic-11-fair-balance-exit-settlement.md].

### Component / UI Specifications
- Streamlit headers and CSV exports should render the ND/FS/YF/TB/I'' fields surfaced by the services; broader copy and tooltip updates are handled by later epic stories [Source: docs/prd/epic-11-fair-balance-exit-settlement.md].

### Project Structure Notes
- Services remain under `src/services/` and tests under `tests/unit` / `tests/integration`, matching the documented source tree, so no structural adjustments are needed [Source: docs/architecture/source-tree.md].

### File Locations
- Expected touchpoints: `src/services/ledger_entry_service.py`, `reconciliation_service.py`, `statement_service.py`, `bookmaker_financials_service.py`, plus integration coverage in `tests/integration/test_settlement_flow.py` [Source: docs/architecture/source-tree.md].

### Testing Standards
- Use `pytest 7.0+` with `pytest-mock`, `pytest-cov`, and `freezegun`; focus on unit tests for ND/identity math and integration tests for settlement flows, targeting 95%+ coverage on settlement logic and 90%+ on ledger/reconciliation [Source: docs/architecture/testing-strategy.md].

### Technical Constraints
- Stay within the documented Python 3.12 stack, reuse existing ledger tables, and avoid introducing new dependencies or schema migrations [Source: docs/architecture/tech-stack.md; docs/architecture/backend-architecture.md#change-notes---yf--exit-settlement-alignment-2025-11-13].

## Testing
- Run `pytest --cov=src --cov-report=term-missing`, ensuring new unit and integration tests exercise ND sign normalization, YF identity math, VOID scenarios, and CSV/regression cases [Source: docs/architecture/testing-strategy.md].

## Change Log
| Date       | Version | Description                         | Author |
|------------|---------|-------------------------------------|--------|
| 2025-11-13 | 0.1     | Initial draft of Story 11.1 created | SM     |

## Dev Agent Record
### Agent Model Used

- GPT-5 / Codex CLI default stack (Python 3.12 runtime)

### Debug Log References

- Unit focus: `pytest tests/unit/test_statement_service.py tests/unit/test_bookmaker_financials_service.py tests/unit/test_reconciliation_service.py`.
- Full `pytest` currently fails (legacy integrations expect pre-identity semantics); see summary in story notes.

### Completion Notes List

- ND sums and FS/YF identities now enforced in reconciliation, statements, and bookmaker services with new DTO aliases and Streamlit updates.
- Integration/tests still pending for statements/bookmaker CSVs, Streamlit copy, and Settle Associate prep per Tasks 3-5.

### File List

- `src/services/reconciliation_service.py`
- `src/services/statement_service.py`
- `src/services/bookmaker_financials_service.py`
- `src/ui/pages/6_reconciliation.py`
- `tests/unit/test_statement_service.py`
- `tests/unit/test_bookmaker_financials_service.py`
- `tests/unit/test_reconciliation_service.py`
- `docs/stories/11.1.nd-sign-consistency-and-identity-adoption.md`
## QA Results

### Risk Assessment
- **Complexity**: 4/5
- **Data Sensitivity**: Medium
- **Integration Risk**: 5/5
- **Overall Risk Score**: 20 (High)

### NFR Analysis
- **Security**: PASS
- **Performance**: PASS
- **Reliability**: FAIL (reconciliation service throws a `NameError` before returning data)
- **Usability**: CONCERNS (statements UI crashes before rendering partner/internal sections)
- **Maintainability**: CONCERNS (identity constants are duplicated and inconsistently imported, leading to the runtime failure above)

### Test Strategy
- **Unit Tests**: Updated coverage now asserts ND/FS/YF math in `tests/unit/test_statement_service.py:90-235` and bookmaker identities in `tests/unit/test_bookmaker_financials_service.py:124-212`, but `tests/unit/test_reconciliation_service.py` can no longer run because `SETTLEMENT_NOTE_PREFIX` is undefined in the service (see below), so this suite currently errors out instead of validating the new math.
- **Integration Tests**: `tests/integration/test_statement_flow.py:699-778` exercises the Settle Associate Now flow, and `tests/integration/test_statement_flow.py:581-623` validates the CSV identities; however, the same module still references the removed `PartnerFacingSection.holdings_eur` field (line 324), so the integration suite fails immediately.
- **E2E / UI**: Not run; moreover, `src/ui/pages/6_statements.py:575-579` still references `partner_section.holdings_eur` / `.delta_eur`, so the Statements page crashes before manual verification is possible.
- **Edge Cases**: VOID/WON/LOST share handling is now covered in `tests/unit/test_bookmaker_financials_service.py:149-212`, but no UI/export smoke test guards against regressions like the clipboard/export crash noted below.

### Requirements Traceability
- **AC1 (ND math everywhere)**: ✅ PASS – `_calculate_funding_totals` filters Settle-Associate entries and `tests/unit/test_statement_service.py:216-235` keeps withdrawals signed; reconciliation/bookmaker services now sum signed ledger rows.
- **AC2 (FS from BET_RESULT with VOID/WON/LOST tests)**: ✅ PASS – Bookmaker snapshots derive FS from `per_surebet_share_eur` and `tests/unit/test_bookmaker_financials_service.py:149-212` cover WON/LOST/VOID mixes.
- **AC3 (YF identity across reconciliation, statements, bookmaker views, CSVs)**: ❌ FAIL – `src/services/reconciliation_service.py:98` references `SETTLEMENT_NOTE_PREFIX` without defining/importing it, so `get_associate_balances()` raises a `NameError` and the reconciliation read model never renders; additionally, the statements UI crashes because `render_export_options()` still touches the removed `partner_section.holdings_eur`/`.delta_eur` fields (`src/ui/pages/6_statements.py:575-579`), meaning ND/FS/YF/TB/I'' cannot be surfaced to operators.
- **AC4 (I'' = TB - YF, Settle Associate Now zeroes imbalance and CSV reflects payout)**: ✅ PASS – `StatementService.settle_associate_now()` posts a single balancing ledger entry via `FundingTransactionService`, and the integration scenario at `tests/integration/test_statement_flow.py:699-778` proves `I''` becomes 0 and the CSV now includes “Exit Payout (-I'')” rows.
- **AC5 (Backward-compatible notes/labels, no schema changes)**: ❌ FAIL – Because the statements UI crashes before rendering, the refreshed ND/FS/YF labels and clipboard/export text never appear; the clipboard payload inside `src/ui/pages/6_statements.py:571-585` also still references the old “Bookmaker Balances”/“Associate Delta” fields, so even after fixing the crash the copied text would contradict the new identity terminology.

### Quality Gate Decision
- **Decision**: FAIL
- **Risk Score**: 20
- **Rationale**: Core reconciliation calculations now raise a `NameError`, the Statements page crashes when rendering exports, and the integration suite still references removed `PartnerFacingSection` attributes, so the identity work cannot be exercised end-to-end. Until those regressions are resolved, multiple acceptance criteria remain unmet despite the new Settle Associate Now workflow.
- **Recommendations**:
  1. Define or import `SETTLEMENT_NOTE_PREFIX` inside `src/services/reconciliation_service.py` and re-run `tests/unit/test_reconciliation_service.py` to recover coverage for ND/FS/YF on that surface.
  2. Update `src/ui/pages/6_statements.py:571-585` to use the new `PartnerFacingSection` fields (`total_balance_eur`, `imbalance_eur`, `exit_payout_eur`, etc.) so the Statements page and clipboard/export flows stop crashing, and mirror the same terminology in the copied text.
  3. Fix `tests/integration/test_statement_flow.py:320-326` (and any other call sites) to assert against the renamed `PartnerFacingSection` fields so the integration suite passes and continues to guard the new identity behavior.

**QA Engineer**: Quinn - Test Architect  
**Date**: 2025-11-13
