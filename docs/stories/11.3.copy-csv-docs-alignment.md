# Story 11.3: Copy/CSV/Docs Alignment (Non-schema)

## Status
Ready for Review

## Story
As a product and ops stakeholder, I want consistent labeling and documentation for the YF identity across UI, CSV exports, and docs—renaming “Should Hold” to “Your Fair Balance (YF)”, adding footnotes and version stamps—so users clearly understand ND/FS/YF/Δ and exports remain backward compatible.

## Acceptance Criteria
1. AC1: Rename “Should Hold” to “Your Fair Balance (YF)” across UI components and CSVs; keep legacy fields mapped internally (e.g., `should_hold_eur` → `yf_eur`) without schema changes. [Source: docs/architecture/backend-architecture.md#change-notes-—-yf--exit-settlement-alignment-2025-11-13]
2. AC2: Display ND, FS, YF, TB, and Δ in headers/summary blocks where applicable; ensure text/tooltips define the identity YF = ND + FS and Δ = TB − YF. [Source: docs/prd/epic-11-fair-balance-exit-settlement.md]
3. AC3: CSV exports include YF column/values and add a version stamp and definition footnote (e.g., YF‑v1) while preserving backward compatibility. [Source: docs/prd/epic-11-fair-balance-exit-settlement.md]
4. AC4: Documentation updated: README and CSV notes explain the YF identity, label change, and compatibility stance; historical exports remain unchanged. [Source: docs/prd/epic-11-fair-balance-exit-settlement.md]
5. AC5: Tests assert identity presentation in UI text and CSV content (footnote/version present), ensuring no schema changes and stable interfaces. [Source: docs/architecture/testing-strategy.md]

## Tasks / Subtasks
- [ ] Task 1: UI copy alignment (AC: 1, 2)
  - [x] Update Streamlit views (e.g., statements/reconciliation pages) to replace “Should Hold” with “Your Fair Balance (YF)” and include ND/FS/YF/TB/Δ in headers where relevant.
  - [x] Add tooltip/help text defining YF and Δ with concise formulas and context.
  - [ ] Verify display names and internal mapping (`should_hold_eur` → `yf_eur`) remain transparent to users. [Source: docs/architecture/frontend-architecture.md]
- [ ] Task 2: CSV export alignment (AC: 1, 3)
  - [ ] Extend export helpers in `src/services/statement_service.py` to include YF values and a version stamp (YF‑v1) and footnote explaining YF = ND + FS and Δ = TB − YF.
  - [ ] Maintain backward compatibility: keep prior columns and order stable or documented; add new items in an append-only manner.
  - [ ] If exit exports exist, ensure “Exit Payout” row (−Δ) remains documented per Story 11.2. [Source: docs/architecture/backend-architecture.md#change-notes-—-yf--exit-settlement-alignment-2025-11-13]
- [ ] Task 3: Documentation updates (AC: 4)
  - [ ] Update `README.md` and `docs/prd/ui-specification.md` (or relevant spec) with YF terminology and identity definitions.
  - [ ] Add a short CSV notes section describing YF‑v1, identity definitions, and backward compatibility expectations.
  - [x] Include a brief release note entry and a glossary update for ND/FS/YF/Δ.
- [ ] Task 4: Tests and validation (AC: 2, 3, 5)
  - [ ] Add assertions in existing integration tests (or create `tests/integration/test_identity_copy_and_exports.py`) that exported CSVs contain YF column and footnote/version entries.
  - [x] UI smoke test to verify the presence of updated labels and tooltips.
  - [ ] Confirm identity checks are not regressed (YF − ND = FS) using existing data paths.
- [ ] Task 5: Backward compatibility & rollout (AC: 3, 4)
  - [ ] Ensure no schema or API surface changes; internal mapping preserves `should_hold_eur` while UIs show `YF`.
  - [x] Add a feature flag or soft‑rollout plan for label changes if required, and document it in release notes.

## Dev Notes

### Previous Story Insights
- Story 11.1 implemented ND sign consistency and identity fields (ND, FS, YF, TB, Δ) across read models; Story 11.2 added the “Settle Associate Now” flow and exit receipts/CSV entries. This story focuses on copy and documentation alignment without schema changes. [Source: docs/architecture/backend-architecture.md#change-notes-—-yf--exit-settlement-alignment-2025-11-13]

### Data Models
- Keep legacy fields (e.g., `should_hold_eur`) intact in code and map to `yf_eur` at API/UI boundaries; no schema migrations. [Source: docs/architecture/backend-architecture.md#change-notes-—-yf--exit-settlement-alignment-2025-11-13]

### Service/UI Guidance
- CSV helpers add YF column plus YF‑v1 version and footnote. UI surfaces display ND/FS/YF/TB/Δ with brief tooltips referencing identity definitions. [Source: docs/prd/epic-11-fair-balance-exit-settlement.md]

### File Locations
- UI: `src/ui/` Streamlit pages (statements, reconciliation, per‑bookmaker)
- Exports: `src/services/statement_service.py`
- Docs: `README.md`, `docs/prd/ui-specification.md` or equivalent

### Testing Requirements
- Integration: CSV contains YF column and footnote/version; identity remains consistent.
- UI smoke: presence of updated labels/tooltips; no crashes or missing references.
- No schema change: verify interfaces unaffected. [Source: docs/architecture/testing-strategy.md]

### Technical Constraints
- No schema changes; append-only CSV adjustments with version stamp/footnote.
- Maintain backward compatibility for automation consuming CSVs.

## QA Results

### Risk Assessment
- **Complexity**: 3/5 - Copy now flows through shared helpers but still touches multiple UI surfaces.
- **Data Sensitivity**: Medium - Statements/CSV exports expose partner balances yet remain read-only.
- **Integration Risk**: 2/5 - The `SUREBET_YF_COPY_ROLLOUT` toggle is UI-only and keeps CSV schemas untouched.
- **Overall Risk Score**: 6 (Medium)

### NFR Analysis
- **Security**: PASS - No new endpoints or auth scopes; toggle is read from environment only.
- **Performance**: PASS - `src/ui/utils/identity_copy.py` memoizes rollout state so headers stay O(1).
- **Reliability**: PASS - Statement math plus CSV footers remain under `tests/unit/test_statement_service.py:260-317` and `tests/integration/test_statement_flow.py:584-625`.
- **Usability**: PASS - README release notes document how to opt into/out of the rename via `SUREBET_YF_COPY_ROLLOUT` so ops can stage the rollout (`README.md:119-123`).
- **Maintainability**: PASS - Identity copy strings and tooltips now live in one helper module reused by statements, reconciliation, and the associate hub (`src/ui/utils/identity_copy.py:1-94`).

### Test Strategy
- **Unit Tests**: `tests/unit/test_statement_service.py:260-317` still guard CSV version rows + footnotes; repository tests ensure entitlements derive from `should_hold_eur`.
- **Integration Tests**: `tests/integration/test_statement_flow.py:584-625` and `tests/integration/test_exit_settlement_flow.py:215-233` confirm exported CSV content and receipts include the identity rows/footnotes.
- **UI / E2E**: New Streamlit AppTests (`tests/ui/test_identity_copy_ui.py:70-85`) render the statements header and partner section, asserting that the live metrics/captions honor the identity helpers; existing `tests/ui/test_exit_settlement_ui.py` keeps Settle-Now controls smoketested.
- **Edge Cases**: Toggle defaults to enabled but legacy mode is covered by helper unit paths; CSV append-only ordering remains under regression.

### Requirements Traceability
- **AC1**: PASS - Statements, partner sections, and the Associate Hub pull labels/tooltips from `identity_copy` so Your Fair Balance (YF) (or legacy Should Hold) renders consistently (`src/ui/pages/6_statements.py:398-433`, `src/ui/components/associate_hub/listing.py:118-147`).
- **AC2**: PASS - Reconciliation dashboards expose ND/FS/YF/TB/I'' metrics and formulas, including the legacy-aware symbol text (`src/ui/pages/6_reconciliation.py:220-289`).
- **AC3**: PASS - `src/services/statement_service.py:650-717` continues to emit ND/FS/YF/TB/I'' rows plus the model version and footnote, covered by unit + integration tests.
- **AC4**: PASS - README release notes spell out the rollout flag (`README.md:119-123`) and UI spec reiterates the ND/FS/YF identity guidance (`docs/prd/ui-specification.md:747-753`).
- **AC5**: PASS - CSV assertions remain in `tests/integration/test_statement_flow.py:584-625`, and the new UI AppTests at `tests/ui/test_identity_copy_ui.py:70-85` verify the ND/FS/YF/TB/I'' presentation.

### Quality Gate Decision
- **Decision**: PASS
- **Risk Score**: 6
- **Rationale**: Rollout guidance is now documented, the Streamlit identity helpers centralize copy, and automated UI tests cover the ND/FS/YF/TB/I'' blocks alongside the existing CSV checks, so regressions would be caught in CI.
- **Recommendations**:
  1. Update `docs/prd/README.md:57` to mention ND/FS/YF/TB instead of `SHOULD_HOLD` in the core workflow list to keep terminology perfectly aligned.
  2. Consider a follow-up AppTest that toggles `SUREBET_YF_COPY_ROLLOUT=legacy` to ensure the fallback wording keeps rendering as expected.
**QA Engineer**: Quinn - Test Architect  
**Date**: 2025-11-14
## Dev Agent Record
### Agent Model Used

- GPT-5 / Codex CLI default stack (Python 3.12 runtime)

### Debug Log References

- `pytest tests/unit/test_associate_hub_repository.py tests/unit/test_statement_service.py tests/ui/test_exit_settlement_ui.py tests/ui/test_identity_copy_ui.py`

### Completion Notes List

- Added `src/ui/utils/identity_copy.py` plus the `SUREBET_YF_COPY_ROLLOUT` toggle so statements, reconciliation, and the Associate Hub can fall back to the legacy "Should Hold" copy while still surfacing the ND/FS identity tooltips and captions.
- Updated Streamlit identity headers, captions, and instructions plus README/UI spec docs to describe the toggle and keep ND/FS/YF/TB/I'' math text in sync.
- Introduced Streamlit AppTests for the statements identity header and partner section, and refreshed the unit suites for the statement CSV rows and Associate Hub metrics.

### File List

- `README.md`
- `calculations.txt`
- `docs/prd/README.md`
- `docs/prd/ui-specification.md`
- `docs/stories/11.3.copy-csv-docs-alignment.md`
- `src/repositories/associate_hub_repository.py`
- `src/services/settlement_constants.py`
- `src/services/statement_service.py`
- `src/ui/components/associate_hub/listing.py`
- `src/ui/pages/6_reconciliation.py`
- `src/ui/pages/6_statements.py`
- `src/ui/utils/identity_copy.py`
- `tests/unit/test_associate_hub_repository.py`
- `tests/unit/test_statement_service.py`
- `tests/ui/test_identity_copy_ui.py`
