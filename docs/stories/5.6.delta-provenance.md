# Story 5.6: Delta Provenance & Counterparty Links

## Status: Draft

## Story

**As the finance operator**, I need every associate’s delta to tie back to the counterpart and surebet that created it so that I can trace surpluses/shortfalls and settle them precisely.

## Acceptance Criteria

- [ ] **Ledger Linking**: Each settlement ledger entry records the surebet it originated from and the opposing associate (winner vs loser) so gains and losses are explicitly paired.
- [ ] **Counterparty Audit Table**: A new `surebet_settlement_links` table persists `surebet_id`, `winner_associate_id`, `loser_associate_id`, `amount_eur`, source ledger entry ids, and timestamps for every settlement or correction that moves value between associates.
- [ ] **Backfill / Migration**: Historical ledger data is scanned to populate the new table for all existing settled surebets, including adjustments introduced by corrections.
- [ ] **Repository APIs**: `ReconciliationService` (or a dedicated provenance service) can return, for any associate, the list of counterparties and surebets contributing to their current delta, with signed amounts and timestamps.
- [ ] **Delta Provenance View**: A service or materialized view exposes delta breakdowns grouped by surebet and counterparty, ready for UI consumption and exports.
- [ ] **UI Extension**: The Associate Operations drawer includes a “Delta Breakdown” section showing surplus/deficit entries with surebet ID, counterparty alias, amount, timestamp, and link to ledger entries.
- [ ] **Telemetry**: Provenance queries emit structlog events (`delta_provenance_viewed`) capturing associate id, number of linked surebets, and timing to support performance monitoring.
- [ ] **Tests**: Unit and integration tests cover link creation, backfill accuracy, provenance queries, and the new UI output (including zero-state handling).

## Dev Notes

### Scope & Dependencies
- Builds on existing ledger schema (Stories 5.1–5.4) and assumes surebet settlements already populate `ledger_entries.surebet_id`.
- Requires consistent associate IDs for both participants in a surebet; confirmations from settlement service may need updates to expose both sides.

### Data Model
- Add nullable `opposing_associate_id` to settlement-related ledger entries if not already present; enforce via migration and update writers.
- Create `surebet_settlement_links` table:
  - `id INTEGER PRIMARY KEY AUTOINCREMENT`
  - `surebet_id INTEGER NOT NULL`
  - `winner_associate_id INTEGER NOT NULL`
  - `loser_associate_id INTEGER NOT NULL`
  - `amount_eur TEXT NOT NULL`
  - `winner_ledger_entry_id INTEGER NOT NULL`
  - `loser_ledger_entry_id INTEGER NOT NULL`
  - `created_at_utc TEXT NOT NULL DEFAULT (datetime('now') || 'Z')`
  - Foreign keys to `surebets`, `associates`, and `ledger_entries`
- Introduce helper indexes on `(winner_associate_id)` and `(loser_associate_id)` for quick lookups.

### Services & Repositories
- Update settlement workflows (e.g., `SettlementService`, `ReconciliationService`) to write link rows immediately after ledger entries are created.
- Build a `DeltaProvenanceService` that:
  1. Fetches current delta components for an associate.
  2. Groups link rows by counterparty and surebet.
  3. Returns enriched records with signed amounts (positive when associate won, negative when lost) and associated timestamps.
- Ensure corrections (Story 5.1) can optionally specify a counterparty; when absent, provide tooling to manually link them.

### UI & UX
- In the associate drawer, add a “Delta Breakdown” tab or subsection:
  - Summary chips (total surplus, total deficit) with quick count of linked surebets.
  - Data table with columns: Surebet ID (clickable), Counterparty Alias, Amount (signed, color-coded), Event Timestamp, Details (link to ledger entry).
  - Empty states explaining when no provenance has been recorded.
- Provide pagination or lazy loading if more than ~20 surebet links exist.

### Telemetry & Reporting
- Log `delta_provenance_viewed` with query duration and counts to monitor performance.
- Extend exports/API responses to include breakdown data so finance can reconcile outside the UI.
- Document SQL snippets in `docs/analytics/delta_provenance_examples.sql` for analysts (follow-up deliverable).

## Test Strategy

- **Unit Tests**:
  - Settlement service writes `surebet_settlement_links` with correct associations.
  - Delta provenance calculations match expected signed totals for multi-surebet scenarios.
- **Backfill Tests**:
  - Migration script populates link table for historical data; verify with fixture database covering wins, losses, and corrections.
- **Integration Tests**:
  - UI tests ensure the drawer renders breakdown rows with accurate amounts and handles empty states.
  - API/service tests return ordered, grouped results for associates with mixed surpluses/deficits.
- **Manual QA Scenarios**:
  1. Settle a new surebet, confirm both associates show matching +/- entries in Delta Breakdown.
  2. Apply a adjustment that changes surebet amounts and confirm link table updates plus UI refresh.
  3. Compare aggregate delta with sum of provenance entries to ensure parity.
