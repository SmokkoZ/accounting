# Story 13.3: Associates Hub Balance History & Deep Linking

## Status: Draft

## Story

**As the** single-operator accountant  
**I want** a Balance History tab in the Associates Hub with deep links from Management and Overview  
**so that** I can analyse historical ND/TB/I'' trends per associate/bookmaker and export the data without leaving the hub.

## Acceptance Criteria

1. **Balance History Tab & Filters**  
   The Associates Hub includes a `Balance History` tab that provides filters for associate, bookmaker, and date range; when opened directly it defaults to "All associates" with a reasonable recent date window, and when opened via deep link it inherits the selected associate (and optional bookmaker) from Management or Overview. [Source: docs/prd/epic-13-associates-hub-brownfield-enhancement.md]
2. **Deep Linking from Management & Overview**  
   Clicking "View history" from an associate row on the Management tab or from an Overview card switches to the Balance History tab and applies the appropriate associate/bookmaker filters, without resetting other global hub filters unnecessarily. [Source: docs/prd/epic-13-associates-hub-brownfield-enhancement.md; src/ui/utils/state_management.py]
3. **Historical Charts for ND/TB/I''**  
   The Balance History tab shows at least one time-series chart that plots ND, TB, and I'' (and optionally YF) across the selected date range for the filtered associate/bookmaker, using the existing reconciliation/balance datasets so the curves match other finance views. [Source: docs/stories/5.2.reconciliation-dashboard-associate-view.md; docs/stories/5.3.bookmaker-balance-drilldown.md]
4. **Historical Table View**  
   Beneath the chart, a table lists historical balance snapshots with columns such as date/time, associate, bookmaker, ND, YF, TB, I'', currency, and source (e.g. balance check vs. ledger aggregate), reusing the same conventions and thresholds from prior reconciliation and balance stories. [Source: docs/stories/5.3.bookmaker-balance-drilldown.md; docs/prd/epic-5-corrections-reconciliation.md]
5. **XLSX Export of Filtered History**  
   The Balance History tab exposes an "Export Excel" or "Download Excel" control that exports the currently filtered history to an `.xlsx` file, matching the Excel styling and typing rules introduced when CSV exports were replaced in Epic 12. [Source: docs/stories/12.2.replace-csv-with-styled-xlsx-exports.md; docs/prd/epic-13-associates-hub-brownfield-enhancement.md]
6. **Performance & UX Guardrails**  
   History queries are constrained by the selected date range and pagination to avoid locking the UI on large datasets; empty-result and error states are surfaced with helpful copy instead of failing silently. [Source: docs/architecture/backend-architecture.md; docs/stories/5.3.bookmaker-balance-drilldown.md]
7. **No Telegram-Specific Data on History Tab**  
   The Balance History tab presents ledger/balance history only and does not surface Telegram message history, coverage proof events, or other Telegram-specific workflow details. [Source: docs/prd/epic-13-associates-hub-brownfield-enhancement.md]

## Tasks / Subtasks

- [ ] **Task 1: Implement Balance History tab shell (AC: 1, 6, 7)**  
  - [ ] Extend the `src/ui/pages/7_associates_hub.py` page so the third tab renders a Balance History surface with associate/bookmaker/date filters and clear empty-state messaging. [Source: docs/prd/epic-13-associates-hub-brownfield-enhancement.md; docs/prd/ui-specification.md]  
  - [ ] Connect filters to session state so the selected associate/bookmaker/date range survive reruns and navigation within the hub. [Source: src/ui/utils/state_management.py]  
  - [ ] Ensure that no Telegram-specific metrics or message details are queried or displayed on this tab. [Source: docs/prd/epic-13-associates-hub-brownfield-enhancement.md]

- [ ] **Task 2: Wire deep-linking from Management and Overview (AC: 2)**  
  - [ ] Add "View history" actions on Management and Overview that set `selected_associate_id`, optional `selected_bookmaker_id`, and a target tab indicator in session state, then trigger a safe rerun. [Source: docs/stories/13.1.associates-hub-management-tab.md; docs/stories/13.2.associates-hub-overview-and-funding-detail.md; src/ui/utils/state_management.py]  
  - [ ] On rerun, detect the target tab indicator to switch to the Balance History tab and pre-populate filters with the selected associate/bookmaker while leaving other hub filters (e.g. currency) intact. [Source: docs/prd/epic-13-associates-hub-brownfield-enhancement.md]  
  - [ ] Add a breadcrumb or caption indicating which associate/bookmaker and date range are currently in focus so the operator understands the context of the deep link.

- [ ] **Task 3: Build historical charts and table (AC: 3, 4, 6)**  
  - [ ] Reuse or extend the existing reconciliation/balance services to fetch historical ND/TB/I'' (and optionally YF) series for the selected associate/bookmaker and date range, using the same identity formulas as elsewhere. [Source: docs/stories/5.2.reconciliation-dashboard-associate-view.md; docs/stories/5.3.bookmaker-balance-drilldown.md; docs/prd/epic-11-fair-balance-exit-settlement.md]  
  - [ ] Render one or more time-series charts (e.g. line charts) showing ND, TB, and I'' over time; tooltips should include exact values and timestamps. [Source: docs/architecture/Frontend_Architecture_v5.md]  
  - [ ] Render a paginated table listing per-snapshot fields (timestamp, associate, bookmaker, ND, YF, TB, I'', currency, source) with sorting options (date, imbalance magnitude, associate/bookmaker). [Source: docs/stories/5.3.bookmaker-balance-drilldown.md]  
  - [ ] Protect performance by limiting default date ranges (e.g. last 30â€“90 days) and paginating long histories, with clear messaging when filters are too broad or return no rows. [Source: docs/architecture/backend-architecture.md]

- [ ] **Task 4: Implement XLSX export and tests (AC: 5, 6)**  
  - [ ] Add an "Export Excel" control that calls a dedicated export function to write the currently filtered history to an `.xlsx` workbook, reusing the styling and numeric typing rules introduced in Story 12.2. [Source: docs/stories/12.2.replace-csv-with-styled-xlsx-exports.md; src/services/ledger_service.py]  
  - [ ] Ensure the exported sheet preserves row/column ordering from the on-screen table and includes the key filters (associate/bookmaker/date range) in either a header row or file metadata. [Source: docs/prd/epic-13-associates-hub-brownfield-enhancement.md]  
  - [ ] Add unit tests that open the generated workbook in memory and assert that ND/TB/I'' columns are numeric and that the row count matches the filtered result set, plus at least one integration test that runs the export end-to-end from the UI. [Source: docs/architecture/testing-strategy.md]

## Dev Notes

### Previous Story & Epic Context

- Story 5.3 (Bookmaker Balance Drilldown) defines how modeled vs. reported balances, differences, and status thresholds are computed; the Balance History tab should reuse these calculations rather than introducing new ones. [Source: docs/stories/5.3.bookmaker-balance-drilldown.md]  
- Story 5.2 (Reconciliation Dashboard Associate View) and Epic 11 specify the ND/YF/TB/I'' identity and visual conventions used across reconciliation surfaces; historical charts must remain consistent with those views. [Source: docs/stories/5.2.reconciliation-dashboard-associate-view.md; docs/prd/epic-11-fair-balance-exit-settlement.md]  
- Story 12.2 (Replace CSV with Styled XLSX Exports) introduced `.xlsx` export styling and typing rules, which this story adopts for balance history exports. [Source: docs/stories/12.2.replace-csv-with-styled-xlsx-exports.md]

### Data & Services

- Historical ND/TB/I'' data is derived from the same ledger and balance check tables used by reconciliation and balance drilldown flows; this story adds new read models and visualizations but does not change how ledger data is stored. [Source: docs/prd/epic-5-corrections-reconciliation.md; docs/architecture/data-architecture.md]  
- Export logic should sit alongside existing ledger/statement exporters to avoid duplicating workbook generation concerns, sharing the same libraries and formatting conventions. [Source: src/services/ledger_service.py; docs/architecture/tech-stack.md]

### UX & Navigation

- Deep linking from Management/Overview into Balance History is central to the Associates Hub concept; the selected associate/bookmaker must be obvious when viewing trends so the operator can quickly pivot between config, current status, and history. [Source: docs/prd/epic-13-associates-hub-brownfield-enhancement.md]  
- The Balance History tab remains focused on financial history; Telegram message history and coverage proof flows are explicitly out of scope and should be handled by a separate Telegram Hub. [Source: docs/prd/epic-13-associates-hub-brownfield-enhancement.md]

