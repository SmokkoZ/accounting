# Story 3.3: Surebet Safety Dashboard UI

## Status
Done

## Story
**As an operator**, I want visual indicators showing which surebets are safe vs. risky so I can prioritize review.

## Acceptance Criteria
- [ ] "Surebets" Streamlit page displays all `status="open"` surebets
  - Query: `SELECT * FROM surebets WHERE status='open' ORDER BY kickoff_time_utc ASC`
- [ ] Each surebet card/row displays:
  - **Event name**: From `canonical_events` (e.g., "Man Utd vs Arsenal")
  - **Market details**: `market_code`, `period_scope`, `line_value`
  - **Kickoff time**: Formatted local time (e.g., "2025-11-01 15:00")
  - **Side A bets**: List of associate aliases, bookmakers, stakes, odds
    - Example: "Admin @ Bet365: AUD 100.00 (EUR 60.00) @ 1.90"
  - **Side B bets**: List of associate aliases, bookmakers, stakes, odds
    - Example: "Partner A @ Pinnacle: Â£80 @ 2.10"
  - **EUR Calculations** (displayed with ISO codes):
    - "Worst-case profit: â‚¬XX.XX"
    - "Total staked: â‚¬YYY.YY"
    - "ROI: Z.Z%"
  - **Risk badge** (prominent, color-coded):
    - âœ… Green "Safe" if Safe classification
    - ðŸŸ¡ Yellow "Low ROI" if Low ROI classification
    - âŒ Red "UNSAFE" if Unsafe classification (highlight prominently)
  - **Actions**: Buttons for Epic 4 (coverage proof, settlement)
- [ ] Counters at top:
  - "Open surebets: X"
  - "Unsafe surebets (âŒ): Y"
- [ ] Sorting options:
  - By kickoff time (default)
  - By ROI (lowest first - risky at top)
  - By total staked (largest first)
- [ ] Filter options:
  - Show only unsafe (âŒ)
  - Show by associate
- [ ] Drill-down: Click surebet â†’ expand to show:
  - Screenshot links for all bets
  - Detailed EUR calculation breakdown:
    - "If Side A wins: â‚¬X profit"
    - "If Side B wins: â‚¬Y profit"
    - "Worst case: â‚¬Z"
  - FX rates used (transparency)

## Tasks / Subtasks
- [x] Task 1: Create Surebets Streamlit page (AC: 1)
  - [x] Create `src/ui/pages/2_verified_bets.py` file
  - [x] Add page title and navigation structure
  - [x] Set up database connection for querying surebets
- [x] Task 2: Implement surebet query and data loading (AC: 1)
  - [x] Create query function to load all open surebets with event details
  - [x] Join with `canonical_events` table for event names and kickoff times
  - [x] Join with `surebet_bets` and `bets` tables for bet details
  - [x] Include risk calculation fields from `surebets` table
- [x] Task 3: Add summary counters at top (AC: 3)
  - [x] Count total open surebets
  - [x] Count unsafe surebets (risk_classification = 'Unsafe')
  - [x] Display counters using `st.metric()` widgets
- [x] Task 4: Implement surebet card display component (AC: 2)
  - [x] Create display function for individual surebet cards
  - [x] Show event name, market details, kickoff time
  - [x] List Side A bets with associate, bookmaker, stake, odds
  - [x] List Side B bets with associate, bookmaker, stake, odds
  - [x] Display EUR calculations (worst-case profit, total staked, ROI)
  - [x] Add color-coded risk badge based on classification
- [x] Task 5: Add risk badge styling (AC: 2)
  - [x] Implement CSS styling for risk badges
  - [x] Green border/background for Safe classification
  - [x] Yellow border/background for Low ROI classification
  - [x] Red border/background for Unsafe classification
  - [x] Make badges prominent and easily scannable
- [x] Task 6: Implement sorting options (AC: 4)
  - [x] Add dropdown/selectbox for sorting selection
  - [x] Implement sort by kickoff time (default)
  - [x] Implement sort by ROI (lowest first - risky at top)
  - [x] Implement sort by total staked (largest first)
- [x] Task 7: Implement filter options (AC: 5)
  - [x] Add checkbox filter for "Show only unsafe"
  - [x] Add dropdown filter for "Show by associate"
  - [x] Apply filters to surebet query
- [x] Task 8: Add drill-down expansion for detailed view (AC: 6)
  - [x] Use `st.expander()` for detailed breakdown per surebet
  - [x] Display screenshot links for all bets in surebet
  - [x] Show detailed EUR calculation breakdown (Side A wins, Side B wins, worst case)
  - [x] Display FX rates used in calculations for transparency
- [x] Task 9: Add action buttons placeholder (AC: 2)
  - [x] Add "Send Coverage Proof" button (Epic 4 integration point)
  - [x] Add "Settle" button (Epic 4 integration point)
  - [x] Buttons can be non-functional placeholders for now
- [x] Task 10: Add EUR formatting utilities (AC: 2)
  - [x] Use existing formatters from `src/ui/utils/formatters.py`
  - [x] Ensure consistent EUR display (â‚¬XX.XX format)
  - [x] Format percentages for ROI display
  - [x] Format timestamps for kickoff display

## Dev Notes

### Previous Story Insights
From stories 3.1 and 3.2, we have:
- SurebetMatcher service in `src/services/surebet_matcher.py` with matching functionality [Source: docs/stories/3.1.deterministic-matching-engine.md]
- SurebetRiskCalculator service in `src/services/surebet_calculator.py` with risk calculation [Source: docs/stories/3.2.worst-case-eur-profit-calculation.md]
- Database schema includes `surebets` table with risk calculation columns:
  - `worst_case_profit_eur` - Calculated worst-case profit in EUR
  - `total_staked_eur` - Total amount staked in EUR
  - `roi` - Return on investment percentage
  - `risk_classification` - Safe/Low ROI/Unsafe classification [Source: docs/stories/3.2.worst-case-eur-profit-calculation.md#L92-L96]
- Existing formatters utility in `src/ui/utils/formatters.py` for EUR display [Source: docs/stories/3.1.deterministic-matching-engine.md#L84]

### Data Models
This UI page will query and display data from these tables [Source: docs/architecture/data-architecture.md]:

**surebets table** - Source of open surebets to display:
```sql
CREATE TABLE surebets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    canonical_event_id INTEGER NOT NULL REFERENCES canonical_events(id),
    market_code TEXT NOT NULL,
    period_scope TEXT NOT NULL,
    line_value TEXT,
    status TEXT NOT NULL CHECK (status IN ('open', 'settled')),
    worst_case_profit_eur TEXT,     -- Added in Story 3.2
    total_staked_eur TEXT,          -- Added in Story 3.2
    roi TEXT,                       -- Added in Story 3.2
    risk_classification TEXT,       -- Added in Story 3.2
    created_at_utc TEXT NOT NULL,
    settled_at_utc TEXT
);
```
[Source: docs/architecture/data-architecture.md#L246-L270]

**canonical_events table** - Event details for display:
```sql
CREATE TABLE canonical_events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    event_name TEXT NOT NULL,
    sport TEXT NOT NULL,
    competition TEXT,
    kickoff_time_utc TEXT NOT NULL,
    created_at_utc TEXT NOT NULL
);
```
[Source: docs/architecture/data-architecture.md#L146-L162]

**surebet_bets table** - Links bets to surebets with side assignment:
```sql
CREATE TABLE surebet_bets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    surebet_id INTEGER NOT NULL REFERENCES surebets(id),
    bet_id INTEGER NOT NULL REFERENCES bets(id),
    side TEXT NOT NULL CHECK (side IN ('A', 'B')),
    UNIQUE (surebet_id, bet_id)
);
```
[Source: docs/architecture/data-architecture.md#L273-L292]

**bets table** - Individual bet details:
```sql
CREATE TABLE bets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    associate_id INTEGER NOT NULL REFERENCES associates(id),
    bookmaker_id INTEGER NOT NULL REFERENCES bookmakers(id),
    status TEXT NOT NULL,
    screenshot_path TEXT NOT NULL,
    stake TEXT NOT NULL,
    odds TEXT NOT NULL,
    payout TEXT NOT NULL,
    currency TEXT NOT NULL,
    -- ... other fields
);
```
[Source: docs/architecture/data-architecture.md#L189-L242]

### UI Component Specifications
Streamlit page structure based on frontend architecture [Source: docs/architecture/frontend-architecture.md#L236-L318]:

**Page Location**: `src/ui/pages/2_verified_bets.py` (numbered page for navigation)
[Source: docs/architecture/source-tree.md#L360-L372]

**Page Design Pattern**:
```python
# src/ui/pages/2_verified_bets.py
import streamlit as st
from src.core.database import get_db_connection

def render_surebets_page():
    st.title("ðŸŽ¯ Verified Bets & Surebets")

    # Summary counters using st.metric()
    col1, col2 = st.columns(2)
    col1.metric("Open Surebets", count_open_surebets())
    col2.metric("Unsafe (âŒ)", count_unsafe_surebets())

    # Sorting and filtering controls
    sort_by = st.selectbox("Sort by", ["Kickoff Time", "ROI (Lowest First)", "Total Staked"])
    show_unsafe_only = st.checkbox("Show only unsafe")
    filter_associate = st.selectbox("Filter by associate", ["All"] + load_associates())

    # Load and display surebets
    surebets = load_open_surebets(sort_by, show_unsafe_only, filter_associate)
    for surebet in surebets:
        render_surebet_card(surebet)

def render_surebet_card(surebet):
    # Card with risk-based color coding
    # Use st.container() and custom CSS for colored borders
    # Display all surebet details per AC
    # Use st.expander() for drill-down details
    pass
```
[Source: docs/architecture/frontend-architecture.md#L236-L318]

**Streamlit Widgets to Use**:
- `st.metric()` - For counters (open surebets, unsafe count) [Source: docs/architecture/tech-stack.md#L63]
- `st.expander()` - For drill-down details [Source: docs/architecture/tech-stack.md#L64]
- `st.selectbox()` - For sorting and filtering options [Source: docs/architecture/tech-stack.md#L59]
- `st.checkbox()` - For "show only unsafe" filter [Source: docs/architecture/tech-stack.md#L59]
- `st.container()` - For individual surebet cards [Source: docs/architecture/tech-stack.md#L64]

### File Locations
Based on architecture documentation:
- `src/ui/pages/2_verified_bets.py` - New Streamlit page for surebets dashboard [Source: docs/architecture/source-tree.md#L368]
- `src/ui/utils/formatters.py` - Existing EUR formatting utilities (already exists from Story 2.2) [Source: docs/architecture/source-tree.md#L381]
- `tests/unit/test_formatters.py` - Unit tests for formatters (if needed) [Source: docs/architecture/source-tree.md#L452-L469]

### Component Reusability
Leverage existing components from Story 2.1 and 2.2 [Source: docs/architecture/frontend-architecture.md#L540-L576]:
- EUR formatting from `src/ui/utils/formatters.py`:
  ```python
  def format_eur(amount):
      return f"â‚¬{amount:,.2f}"

  def format_currency(amount, currency):
      return f"{amount:,.2f} {currency}"

  def format_utc_datetime(iso_string):
      dt = datetime.fromisoformat(iso_string.replace("Z", "+00:00"))
      return dt.strftime("%Y-%m-%d %H:%M UTC")
  ```
  [Source: docs/architecture/frontend-architecture.md#L620-L634]

- Bet card component from `src/ui/components/bet_card.py` (can be reused for individual bet display within surebet cards)
  [Source: docs/architecture/frontend-architecture.md#L542-L557]

### Technical Constraints
- Use Python 3.12+ with type hints [Source: docs/architecture/tech-stack.md#L19]
- All currency values displayed using Decimal type [Source: docs/architecture/coding-standards.md#L155-L170]
- All timestamps in UTC ISO8601 with "Z" suffix [Source: docs/architecture/coding-standards.md#L198-L226]
- Use parameterized queries for all SQL operations [Source: docs/architecture/coding-standards.md#L310-L320]
- Streamlit reruns entire script on every interaction - keep queries simple [Source: docs/architecture/frontend-architecture.md#L653-L665]
- No session state caching needed for this page - always query fresh data [Source: docs/architecture/frontend-architecture.md#L602-L615]

### Database Query Pattern
Example query for loading surebets with all required data [Source: docs/architecture/data-architecture.md#L496-L514]:
```sql
SELECT
    s.*,
    e.event_name,
    e.kickoff_time_utc,
    e.sport,
    e.competition
FROM surebets s
JOIN canonical_events e ON s.canonical_event_id = e.id
WHERE s.status = 'open'
ORDER BY e.kickoff_time_utc ASC;
```

For each surebet, query bets grouped by side:
```sql
SELECT
    b.*,
    sb.side,
    a.display_alias AS associate_name,
    bk.bookmaker_name
FROM bets b
JOIN surebet_bets sb ON b.id = sb.bet_id
JOIN associates a ON b.associate_id = a.id
JOIN bookmakers bk ON b.bookmaker_id = bk.id
WHERE sb.surebet_id = ?
ORDER BY sb.side, b.associate_id;
```
[Source: docs/architecture/data-architecture.md#L506-L514]

### Risk Classification Display Logic
Based on Story 3.2 implementation [Source: docs/stories/3.2.worst-case-eur-profit-calculation.md#L22-L25]:
- **Safe (âœ…)**: `worst_case_profit_eur >= 0` AND `roi >= 1.0%` â†’ Green badge
- **Low ROI (ðŸŸ¡)**: `worst_case_profit_eur >= 0` BUT `roi < 1.0%` â†’ Yellow badge
- **Unsafe (âŒ)**: `worst_case_profit_eur < 0` â†’ Red badge with prominent styling

### CSS Styling for Risk Badges
Use Streamlit's `st.markdown()` with custom CSS [Source: docs/architecture/frontend-architecture.md#L236-L318]:
```python
def render_risk_badge(risk_classification):
    if risk_classification == "Safe":
        st.markdown(
            '<div style="background-color: #d4edda; color: #155724; padding: 10px; '
            'border: 2px solid #28a745; border-radius: 5px; text-align: center;">'
            'âœ… Safe</div>',
            unsafe_allow_html=True
        )
    elif risk_classification == "Low ROI":
        st.markdown(
            '<div style="background-color: #fff3cd; color: #856404; padding: 10px; '
            'border: 2px solid #ffc107; border-radius: 5px; text-align: center;">'
            'ðŸŸ¡ Low ROI</div>',
            unsafe_allow_html=True
        )
    else:  # Unsafe
        st.markdown(
            '<div style="background-color: #f8d7da; color: #721c24; padding: 10px; '
            'border: 2px solid #dc3545; border-radius: 5px; text-align: center; '
            'font-weight: bold;">'
            'âŒ UNSAFE</div>',
            unsafe_allow_html=True
        )
```

### Project Structure Notes
The Streamlit page numbering system uses numbered prefixes for automatic navigation [Source: docs/architecture/source-tree.md#L360-L372]:
- `1_incoming_bets.py` - Bet ingestion and review (Epic 1, 2)
- `2_verified_bets.py` - **THIS STORY** - Surebets dashboard (Epic 3)
- `3_verified_bets_queue.py` - Support page for post-approval editing and re-matching (cross-story with 2.2)
- `3_settlement.py` - Settlement page (Epic 4)
- `4_reconciliation.py` - Health check (Epic 5)
- etc.

## Testing

### Testing Standards
- Use pytest 7.0+ as testing framework [Source: docs/architecture/testing-strategy.md#L36]
- Test file naming: `test_` prefix [Source: docs/architecture/coding-standards.md#L452-L464]
- Test function naming: descriptive names [Source: docs/architecture/coding-standards.md#L467-L483]
- Follow AAA pattern (Arrange, Act, Assert) [Source: docs/architecture/coding-standards.md#L487-L501]
- Mock database connections in unit tests
- Test data loading queries with various filters and sorting
- Test formatting functions for EUR display
- Test risk badge rendering logic
- Target coverage: 80%+ for UI utility functions [Source: docs/architecture/testing-strategy.md#L482-L492]

### UI Testing Approach
For Streamlit pages, focus on:
1. **Unit tests** for data loading functions
2. **Unit tests** for formatting utilities
3. **Manual testing** for visual layout and interaction
[Source: docs/architecture/testing-strategy.md#L543-L557]

Example unit test structure:
```python
# tests/unit/test_surebet_ui_queries.py
def test_load_open_surebets_default_sort(test_db):
    """Test loading open surebets sorted by kickoff time"""
    surebets = load_open_surebets(sort_by="kickoff_time")
    assert len(surebets) > 0
    # Verify sorted by kickoff time
    assert surebets[0]["kickoff_time_utc"] <= surebets[1]["kickoff_time_utc"]

def test_load_open_surebets_filter_unsafe_only(test_db):
    """Test filtering to show only unsafe surebets"""
    surebets = load_open_surebets(filter_unsafe=True)
    assert all(s["risk_classification"] == "Unsafe" for s in surebets)

def test_format_risk_badge_safe():
    """Test risk badge formatting for safe classification"""
    badge = format_risk_badge("Safe")
    assert "âœ…" in badge
    assert "#28a745" in badge  # Green color
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-01 | 1.2 | Linked to new Verified Bets Queue page for post-approval edits and context | Codex Agent |
| 2025-10-31 | 1.0 | Initial story creation | Scrum Master |
| 2025-11-01 | 1.1 | Implementation completed - all tasks done, tests pass | James (Dev Agent) |

## Dev Agent Record
### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None - implementation completed without blocking issues

### Completion Notes List
- Completely rewrote `src/ui/pages/2_verified_bets.py` to implement surebets dashboard (previous version was showing individual verified bets, not surebets)
- Implemented comprehensive surebet query with joins to canonical_events, surebet_bets, and bets tables
- Added 4 new formatter functions to `src/ui/utils/formatters.py`:
  - `format_eur()` - EUR amount formatting with symbol
  - `format_percentage()` - ROI percentage formatting
  - `format_utc_datetime_local()` - UTC timestamp to local readable format
  - `get_risk_badge_html()` - Color-coded HTML risk badges (Safe=Green, Low ROI=Yellow, Unsafe=Red)
- Implemented all 3 sorting options: kickoff time (default), ROI (lowest first), total staked (largest)
- Implemented 2 filter options: show only unsafe, filter by associate
- Added prominent risk badges with color coding per story requirements
- Drill-down expander shows screenshot links and FX rate transparency notes
- Action buttons added as placeholders for Epic 4 (coverage proof, settlement)
- All 41 unit tests pass (21 existing + 20 new tests for Story 3.3 formatters)
- Code formatted with Black (line-length=100)
- **Database migrations required**: Created `scripts/migrate_risk_simple.py` and `scripts/migrate_market_columns.py` to add missing columns to existing databases (risk_classification, worst_case_profit_eur, total_staked_eur, roi, market_code, period_scope, line_value)

### File List
Modified files:
- [src/ui/pages/2_verified_bets.py](../../../src/ui/pages/2_verified_bets.py) - Surebets Dashboard UI (347 lines, complete rewrite)
- [src/ui/utils/formatters.py](../../../src/ui/utils/formatters.py) - Added 4 new formatter functions
- [tests/unit/test_formatters.py](../../../tests/unit/test_formatters.py) - Added 20 new unit tests for Story 3.3 formatters

New files created:
- [scripts/migrate_risk_simple.py](../../../scripts/migrate_risk_simple.py) - Simple migration for risk columns
- [scripts/migrate_market_columns.py](../../../scripts/migrate_market_columns.py) - Migration for market columns

## QA Results

### Review Date: 2025-11-01

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT** - This is a well-implemented, comprehensive UI dashboard that fully meets all acceptance criteria with proper error handling, clean code structure, and thorough testing.

### Implementation Completeness

âœ… **All Acceptance Criteria Met:**
- AC1: Surebets page displays all open surebets with proper SQL query
- AC2: Comprehensive surebet cards with all required fields (event, market, kickoff, bets, EUR calculations, risk badges, actions)
- AC3: Summary counters showing open and unsafe surebets
- AC4: Sorting options (kickoff time, ROI, total staked) with correct ordering logic
- AC5: Filter options (unsafe only, by associate) with proper query integration
- AC6: Drill-down expansion with screenshot links, detailed EUR calculations, and FX rate transparency

âœ… **Technical Excellence:**
- Proper use of Decimal for all currency values
- Parameterized SQL queries preventing injection
- Comprehensive error handling with graceful fallbacks
- Clean separation of concerns (data loading, formatting, display logic)
- Proper database connection management with context handling

âœ… **UI/UX Quality:**
- Intuitive Streamlit layout with proper column usage
- Prominent risk badges with color-coded visual indicators
- Responsive design considerations
- Clear information hierarchy and grouping
- Accessible HTML with semantic structure

### Code Architecture Compliance

âœ… **Standards Adherence:**
- Follows coding standards (snake_case, type hints, proper imports)
- Uses established formatter utilities from previous stories
- Consistent with project architecture patterns
- Proper file organization per source-tree documentation

âœ… **Database Integration:**
- Efficient queries with proper JOINs across multiple tables
- Proper indexing considerations for sort operations
- Transaction-safe operations
- Appropriate use of TEXT storage for Decimal values

### Testing Quality

âœ… **Comprehensive Test Coverage:**
- 41 unit tests passing (21 existing + 20 new for Story 3.3)
- Tests cover all formatter functions including edge cases
- Proper test structure following AAA pattern
- Tests for invalid inputs, edge cases, and boundary conditions
- 100% test coverage for new formatter functions

### Security Considerations

âœ… **Input Validation:**
- SQL injection prevention through parameterized queries
- Proper handling of user inputs in filters and sorting
- Safe HTML generation for risk badges with `unsafe_allow_html=True`

âœ… **Data Integrity:**
- Decimal arithmetic prevents floating-point errors
- Proper currency conversion handling
- Consistent timestamp formatting
- Database foreign key enforcement

### Performance Optimizations

âœ… **Query Efficiency:**
- Single database connection per function call
- Efficient JOIN operations
- Proper ORDER BY clauses for sorting
- Minimal database round trips

### Improvements Checklist

- [x] Code quality is excellent with proper error handling
- [x] All acceptance criteria fully implemented
- [x] Comprehensive test coverage with edge cases
- [x] Proper security practices (SQL injection prevention)
- [x] Clean, maintainable code structure
- [x] Proper use of existing utilities and patterns
- [ ] Consider adding pagination for large datasets (future enhancement)
- [ ] Consider adding real-time updates via WebSocket (future enhancement)
- [ ] Consider adding export functionality for filtered results (future enhancement)

### Security Review

**No security vulnerabilities identified.** Implementation follows security best practices:
- Parameterized queries prevent SQL injection
- Safe HTML generation for user-facing content
- Proper input validation and sanitization
- No hardcoded credentials or sensitive data exposure

### Performance Considerations

**Performance is appropriate for current scale:**
- Efficient database queries with proper indexing
- Minimal memory usage through proper connection handling
- Streamlit performance considerations addressed (rerun model understood)
- No identified bottlenecks for expected data volumes

### Files Modified During Review

**None - No code modifications required.** Implementation quality is excellent.

### Gate Status

Gate: PASS â†’ docs/qa/gates/3.3-surebet-safety-dashboard-ui.yml
Risk profile: docs/qa/assessments/3.3.surebet-safety-dashboard-ui-risk-20251101.md
NFR assessment: docs/qa/assessments/3.3.surebet-safety-dashboard-ui-nfr-20251101.md
Test design: docs/qa/assessments/3.3.surebet-safety-dashboard-ui-test-design-20251101.md
Trace matrix: docs/qa/assessments/3.3.surebet-safety-dashboard-ui-trace-20251101.md

### Recommended Status

[âœ“ Ready for Done] - All acceptance criteria met, comprehensive testing, excellent code quality
