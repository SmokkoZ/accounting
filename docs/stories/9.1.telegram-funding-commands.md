# Story 9.1: Telegram Funding Commands (Deposit/Withdraw)

## Status
Draft

## Story
As an operator, I want the Telegram bot to accept funding commands in registered chats so deposits and withdrawals can be initiated quickly without specifying a bookmaker.

## Acceptance Criteria

- [ ] Text command parsing (case-insensitive):
  - Patterns: `deposit <amount>` and `withdraw <amount>`
  - Examples: `deposit 500`, `withdraw 250.75`
  - Reject on invalid amount; reply with usage tip
- [ ] Registration required
  - If chat not registered: reply with instruction to use `/register <associate_alias> <bookmaker_name>`
- [ ] Currency resolution
  - Currency = associate `home_currency` from DB
- [ ] Admin auto-approval
  - If sender is admin user or admin chat: create `ledger_entries` row immediately
  - Type: `DEPOSIT` or `WITHDRAWAL`
  - Associate/bookmaker: from `chat_registrations`
  - Amount: positive for deposits; negative for withdrawals (native)
  - FX snapshot: fetch current daily FX; store snapshot
  - Reply to chat: "Approved: <type> <amount> <CUR> recorded"
- [ ] Associate approval path
  - Create funding draft tied to `(associate_id, bookmaker_id)` with `source='telegram'`
  - Persist recommended: `funding_drafts` table (id, chat_id, associate_id, bookmaker_id, type, amount_native, native_currency, note, created_at_utc, source)
  - Reply to chat: "Submitted for approval: <type> <amount> <CUR>."
- [ ] Observability
  - Log events with fields: chat_id, user_id, associate_id, bookmaker_id, type, amount, currency, approval_path
  - Handle and log parse/DB errors without crashing bot

## Tasks / Subtasks

- [ ] Add `MessageHandler(filters.TEXT & ~filters.COMMAND, ...)` to `src/integrations/telegram_bot.py`
  - [ ] Recognize patterns and route to funding workflow
- [ ] Extend `FundingService` or add `BookmakerFundingService`
  - [ ] Create drafts with `(associate_id, bookmaker_id)`
  - [ ] Accept path writes `ledger_entries` with `bookmaker_id`
  - [ ] Optional: implement `funding_drafts` DB table instead of in-memory
- [ ] Add FX lookup via `fx_manager`
- [ ] Unit tests for parser and service integration

## Dev Notes

- Chatâ†’context comes from `chat_registrations` (schema: `src/core/schema.py:691`)
- Existing `FundingService` uses associate-level funding; this story adds bookmaker-scoped funding when source is Telegram chat
- Keep append-only ledger invariant; no updates/deletes (see triggers)

