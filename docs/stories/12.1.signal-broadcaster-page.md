# Story 12.1: Signal Broadcaster Page

## Status
Approved

## Story
**As an** operations lead,  
**I want** a Streamlit page where I can paste raw signal text, pick pre-configured or custom Telegram chats, preview the exact message, and send it through the existing bot,  
**so that** I can broadcast surebet signals quickly without leaving the console or risking formatting changes.

## Acceptance Criteria
1. A new “Signal Broadcaster” page provides a multiline text area plus chat selection controls; the Send action stays disabled with an inline helper message until both text and at least one chat are present. [Source: docs/prd/epic-12-signal-broadcaster-and-styled-excel-exports.md]
2. The chat selector supports friendly labels (associate + bookmaker) with search and optional routing presets that pre-fill typical combinations while remaining editable. [Source: docs/prd/epic-12-signal-broadcaster-and-styled-excel-exports.md]
3. A live preview panel shows exactly what will be posted (whitespace, tabs, and line breaks preserved) before the operator sends anything. [Source: docs/prd/epic-12-signal-broadcaster-and-styled-excel-exports.md]
4. Sending posts the raw text to every selected Telegram chat via the existing bot pipeline without reformatting; success banners include the number of chats addressed. [Source: docs/prd/epic-12-signal-broadcaster-and-styled-excel-exports.md]
5. Partial failures surface inline with the friendly label or chat ID for each chat; all errors are visible without reloading, and the operator can adjust and resend immediately. [Source: docs/prd/epic-12-signal-broadcaster-and-styled-excel-exports.md]

## Tasks / Subtasks
- [x] Task 1: Add Signal Broadcaster navigation & layout (AC: 1, 3)
  - [x] Create `src/ui/pages/8_signal_broadcaster.py` with a Streamlit layout that follows the declarative navigation/page pattern; wire it into `src/ui/app.py` via `st.navigation` with a fallback sidebar link. [Source: docs/architecture/Frontend_Architecture_v5.md#app-shell--navigation]
  - [x] Build the core form (text area, Send controls, helper text) using Streamlit’s single-page workflow conventions so the page reruns predictably and matches the “one workflow per page” guidance. [Source: docs/architecture/Frontend_Architecture_v5.md#page-patterns-updated]
  - [x] Gate the Send button until both inputs are valid and show the inline helper copy in the same container (no dialogs) as described in the ACs. [Source: docs/architecture/Frontend_Architecture_v5.md#interaction-model--rerun-control]
- [x] Task 2: Surface chat data, search, and presets (AC: 1, 2)
  - [x] Query the `telegram_chats` table and join to `associates`/`bookmakers` so each option includes the friendly alias + bookmaker label, caching the dataset via fragments or `st.cache_data` for performance. [Source: docs/architecture/integration-architecture.md#database-telegram_chats-table-optional-for-mvp-can-be-hardcoded]
  - [x] Keep data access aligned with the documented schema for associates/bookmakers so search fields remain descriptive and accurate. [Source: docs/architecture/data-architecture.md#associates]
  - [x] Represent routing presets as structured data (e.g., config or helper in `src/ui/utils/state_management.py`) so selecting one pre-populates the same multi-select control while allowing edits afterward. [Source: docs/architecture/source-tree.md#srcui--streamlit-ui]
- [x] Task 3: Implement preview + fragment scaffolding (AC: 3)
  - [x] Render a preview panel that mirrors whitespace verbatim (e.g., `st.code` or `st.text_area` in read-only mode) and isolate it in an `@st.fragment` or dedicated container so updates don’t rerun the whole page. [Source: docs/architecture/Frontend_Architecture_v5.md#interaction-model--rerun-control]
- [x] Task 4: Deliver messages and surface per-chat results (AC: 4, 5)
  - [x] Reuse the existing Telegram bot integration (python-telegram-bot) to send the raw text, honoring the retry/backoff guidance and rate limits so bursts of chats stay within API quotas. [Source: docs/architecture/integration-architecture.md#error-handling]
  - [x] Enforce chat whitelisting/authorization before send attempts to avoid exposing unknown destinations, and surface failure reasons inline. [Source: docs/architecture/security-architecture.md#telegram-bot-security]
  - [x] Log and display success/failure counts in the UI by mapping responses back to the friendly labels. [Source: docs/architecture/Frontend_Architecture_v5.md#page-patterns-updated]
- [x] Task 5: Testing, logging, and operator feedback (AC: 3, 4, 5)
  - [x] Add unit tests for the label builder/preset logic plus service-level tests that mock Telegram to assert retries, success summaries, and error surfacing. [Source: docs/architecture/testing-strategy.md#test-structure]
  - [x] Document structured logs (chat IDs, presets used, retry counts) to align with the existing logging standards so operators can audit broadcasts. [Source: docs/architecture/source-tree.md#src/utils--shared-utilities]

## Dev Notes
### Previous Story Insights
- This is the first story in Epic 12, so follow the baseline “single workflow per Streamlit page” pattern and add a dedicated navigation entry before layering on shared fragments. [Source: docs/architecture/Frontend_Architecture_v5.md#page-patterns-updated]

### UI Architecture & Navigation
- Use the documented `st.navigation` setup in `src/ui/app.py` (with automatic sidebar fallbacks) so the Signal Broadcaster page behaves like existing pages 1–7. [Source: docs/architecture/Frontend_Architecture_v5.md#app-shell--navigation]
- Keep expensive UI regions (chat search, preview, result log) wrapped in `@st.fragment` blocks so reruns stay scoped even while users type or toggle presets. [Source: docs/architecture/Frontend_Architecture_v5.md#interaction-model--rerun-control]
- If confirmation or status dialogs are needed for bulk errors, apply the `@st.dialog` pattern while still keeping the main form on-screen for quick retries. [Source: docs/architecture/Frontend_Architecture_v5.md#interaction-model--rerun-control]

### Data Models & Chat Sources
- Chat options live in `telegram_chats` alongside associate and bookmaker references; join those tables to build friendly labels such as “Alice – SportsBet (AU)” and include the raw `chat_id` for auditing. [Source: docs/architecture/integration-architecture.md#database-telegram_chats-table-optional-for-mvp-can-be-hardcoded]
- Reuse the canonical associate/bookmaker metadata so routing presets remain accurate when display aliases or bookmaker names change. [Source: docs/architecture/data-architecture.md#bookmakers]
- Cache chat lookups or hydrate them once per rerun via the recommended SQLite access patterns to avoid re-querying on every keystroke. [Source: docs/architecture/data-architecture.md#database-technology]

### Telegram Integration & Delivery
- Sending must go through the python-telegram-bot client with exponential backoff (+500 ms spacing) as documented for coverage proofs, ensuring we stay within Telegram’s 30 msg/s (multi-chat) and 1 msg/s (per-chat) caps. [Source: docs/architecture/integration-architecture.md#rate-limiting]
- Follow the provided retry helper (with `TelegramError` handling) and surface failures immediately so no silent drops occur. [Source: docs/architecture/integration-architecture.md#error-handling]
- Only expose chats already whitelisted in `telegram_chats` and respect the “no public commands” rule to keep the bot locked down. [Source: docs/architecture/security-architecture.md#telegram-bot-security]
- The UI relies on `TELEGRAM_BOT_TOKEN` plus other `.env` secrets already loaded via `Config`, so validate configuration before enabling Send. [Source: docs/architecture/tech-stack.md#environment-configuration]

### Technical Constraints
- Stick with Python 3.12 + Streamlit ≥ 1.30 (1.46 recommended) so fragments, dialogs, and navigation helpers are available in production. [Source: docs/architecture/tech-stack.md#frontend-stack]
- Preserve message text exactly—no normalization, trimming, or markdown conversion—because operators expect WYSIWYG output when interacting with Telegram. [Source: docs/architecture/integration-architecture.md#1-telegram-bot-integration]

### Project Structure Notes
- Place the new page under `src/ui/pages/8_signal_broadcaster.py` and register it through `src/ui/app.py` per the documented UI tree; helper utilities can live in `src/ui/utils/state_management.py` or `components/` if they’re shared. [Source: docs/architecture/source-tree.md#srcui--streamlit-ui]
- Any reusable Telegram send helper that lives outside the UI should be implemented in `src/services/` or `src/integrations/` so it can be unit-tested independently. [Source: docs/architecture/source-tree.md#src/services--business-logic]
- Add related tests under `tests/unit/` (and integration tests under `tests/integration/` if DB access is required) to stay aligned with the standard test tree. [Source: docs/architecture/source-tree.md#tests]

## Testing
- Follow the documented pyramid: unit tests for label building/preset selection and Telegram send orchestration, integration tests for the end-to-end broadcast flow against a SQLite fixture, and UI smoke/regression coverage where practical. [Source: docs/architecture/testing-strategy.md#testing-pyramid]
- Place new tests under `tests/unit/` (pure helpers) and `tests/integration/` (SQLite + Telegram mock) with pytest fixtures described in the shared structure. [Source: docs/architecture/testing-strategy.md#test-structure]
- Mock Telegram APIs using `pytest-mock`/`AsyncMock` to assert retry counts, per-chat status aggregation, and preservation of the raw text payload. [Source: docs/architecture/testing-strategy.md#testing-tools]
- Include acceptance-style checks ensuring success banners report counts and failure summaries enumerate chat labels, aligning with the checklist’s emphasis on measurable success criteria. [Source: docs/architecture/testing-strategy.md#manual-testing-checklist]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-15 | 1.0 | Initial draft for Signal Broadcaster page | Bob (Scrum Master) |

## Dev Agent Record
  ### Agent Model Used
  - Codex GPT-5 (James / dev)
  
  ### Debug Log References
  - 2025-11-15: Preserved raw signal formatting by rendering previews with HTML `<pre>` blocks and sending the untouched textarea payload (src/ui/pages/8_signal_broadcaster.py:15).
  - 2025-11-15: Reinforced routing preset/state helpers for chat discovery and caching (src/ui/utils/state_management.py:11).
  - 2025-11-15: Added the reusable Signal Broadcast service to deliver Telegram messages without mutating whitespace (src/services/signal_broadcast_service.py:1).
  - 2025-11-15: Extended pytest coverage to guard multiline/tabbed payload delivery (tests/unit/test_signal_broadcasting.py:1).
  
  ### Completion Notes List
  - Live preview now mirrors the original signal with `<pre>` rendering, so pasted tabs/line breaks stay intact.
  - Telegram sends reuse the exact textarea payload; no whitespace normalization occurs anywhere in the pipeline.
  - Added regression tests ensuring multi-line/tabbed strings reach Telegram unchanged.
  
  ### File List
  - src/ui/pages/8_signal_broadcaster.py
  - src/services/signal_broadcast_service.py
  - src/ui/utils/state_management.py
  - src/ui/app.py
  - tests/unit/test_signal_broadcasting.py

## QA Results

### Risk Assessment
- **Complexity**: 4/5 - Combining new Streamlit navigation, cached DB joins, preset state, and Telegram broadcast orchestration in a single workflow carries notable moving parts.
- **Data Sensitivity**: Medium - Payload is internal surebet intel and includes chat IDs but no regulated PII, so leakage is harmful yet contained.
- **Integration Risk**: 4/5 - Depends on the telegram_chats and associates/bookmakers schema plus the python-telegram-bot client and retry helpers.
- **Overall Risk Score**: 16 (Medium) - Probability 4 x impact 4 because mis-sends or failed retries directly affect operations.

### NFR Analysis
- **Security**: PASS - Story mandates chat whitelisting and reuse of the locked-down bot token; add config validation tests to prevent sending to unknown chats.
- **Performance**: PASS - Fragments and `st.cache_data` keep chat lookups from thrashing reruns; biggest cost is multi-chat send which is bounded by Telegram limits.
- **Reliability**: CONCERNS - Success banner math and per-chat retry/error aggregation need deterministic tests to avoid silent drops or double sends when rerunning the page.
- **Usability**: PASS - Gating the Send button, inline helper copy, and live preview meet operator expectations, provided helper text mirrors the disable reasons.
- **Maintainability**: PASS - Isolating presets/utilities under `src/ui/utils` plus fragment scaffolding keeps business logic shareable with future automation flows.

### Test Strategy
- **Unit Tests**: Cover friendly-label builders, preset hydration, send-button gating logic, and helpers that map responses into success/error summaries.
- **Integration Tests**: Use SQLite fixtures plus mocked Telegram client to push multi-chat payloads, assert retry/backoff behavior, preserve whitespace, and confirm success counts.
- **E2E Tests**: High-value smoke that runs the Streamlit workflow via Streamlit testing APIs or Playwright to validate preview fidelity and disable/enable transitions.
- **Edge Cases**: Zero-length text with presets selected, 4k-plus character multiline payloads, duplicate chats introduced via presets, missing bot token or chat removed from whitelist, and Telegram errors mid-batch requiring immediate resend.

### Requirements Traceability
- **AC1**: Covered - UI tests must verify multiline input, chat selection guardrails, helper copy, and button gating.
- **AC2**: Covered - Unit tests for the join plus label builder along with preset-to-multiselect hydration ensure search friendliness.
- **AC3**: Covered - Fragment-level tests need to assert preview containers render whitespace verbatim on every rerun.
- **AC4**: Partial coverage - Add integration tests that mock Telegram to assert raw payload delivery and success banner counts across multi-chat batches.
- **AC5**: Partial coverage - Need negative-path tests that raise per-chat failures, surface inline summaries, and allow immediate resend without clearing state.

### Quality Gate Decision
- **Decision**: PASS
- **Risk Score**: 16
- **Rationale**: Story text, tasks, and dev notes define the UI workflow, integration boundaries, and logging expectations; remaining gaps are limited to documenting deterministic tests for multi-chat send reliability.
- **Recommendations**:
  1. Document concrete test cases for AC4 and AC5, including sample Telegram error payloads, before implementation starts.
  2. Add an operator-visible resend or audit-log verification step to the testing checklist so reruns cannot duplicate sends silently.

**QA Engineer**: Quinn - Test Architect  
**Date**: 2025-11-14
