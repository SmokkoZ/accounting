# Story 5.3: Bookmaker Balance Drilldown

## Status: Approved

## Story

**As the operator**, I want to compare modeled bookmaker balances against reported live balances to identify missing transactions so I can apply corrections for discrepancies.

## Acceptance Criteria

- [ ] **Bookmaker drilldown interface**: Reconciliation page includes expandable per-bookmaker breakdown or separate drilldown tab
- [ ] **Per-bookmaker data display**: Grouped by associate + bookmaker with modeled vs. reported comparison
- [ ] **Modeled Balance calculation**:
  - Query: `SUM(amount_eur)` from all `ledger_entries` WHERE `associate_id=X AND bookmaker_id=Y`
  - Convert to native currency: `modeled_native = modeled_eur / fx_rate`
  - Display: "â‚¬XXX (YYY AUD)" where YYY is approximate native equivalent
- [ ] **Reported Live Balance display**:
  - From `bookmaker_balance_checks` table with manual entry capability
  - Display: "ZZZ AUD (â‚¬AAA)" with timestamp "Last checked: X hours ago"
- [ ] **Difference calculation**:
  - `difference_native = reported_native - modeled_native`
  - `difference_eur = difference_native * fx_rate`
  - Color coding:
    - **ðŸŸ¢ Green** if `|difference_eur| < â‚¬10`: "Balanced"
    - **ðŸŸ¡ Yellow** if `10 <= |difference_eur| < â‚¬50`: "Minor mismatch"
    - **ðŸ”´ Red** if `|difference_eur| >= â‚¬50`: "Major mismatch - investigate"
- [ ] **"Apply Correction" button**: Pre-fills correction form (Story 5.1) with:
  - Associate: X
  - Bookmaker: Y
  - Amount: `difference_native` (to bring modeled in line with reported)
  - Currency: bookmaker's currency
  - Note: "Balance reconciliation for [bookmaker] on [date]"
- [ ] **Manual balance entry form**: Inline form with associate selector, bookmaker selector, balance amount (native currency), "Update Balance" button
- [ ] **Bookmaker balance checks table**: 
  - Insert/update `bookmaker_balance_checks` row on "Update Balance"
  - Show timestamp of last balance check
- [ ] **Table filtering features**: 
  - Sortable by difference (largest first)
  - Filter: show only mismatches option
  - Collapsible associate rows with bookmaker detail breakdown
- [ ] **Data integrity**: Balance checks do NOT auto-create corrections (operator decides)

## Dev Notes

### Previous Story Insights

From Story 5.2 (Reconciliation Dashboard Associate View):
- ReconciliationService and AssociateBalance calculations established [Source: docs/stories/5.2.reconciliation-dashboard-associate-view.md#ReconciliationService-Class]
- DELTA threshold logic (Â±â‚¬10) for status determination [Source: docs/stories/5.2.reconciliation-dashboard-associate-view.md#Color-Coding-Thresholds]
- Color coding patterns for financial health indicators [Source: docs/stories/5.2.reconciliation-dashboard-associate-view.md#Color-Coding-Thresholds]
- Decimal precision handling and FX rate management [Source: docs/stories/5.2.reconciliation-dashboard-associate-view.md#Decimal-Precision-Requirements]

From Story 5.1 (Post-Settlement Correction Interface):
- CorrectionService and BOOKMAKER_CORRECTION entry patterns [Source: docs/stories/5.1.post-settlement-correction-interface.md#CorrectionService-Class]
- Forward-only correction principles with pre-filled form integration [Source: docs/stories/5.1.post-settlement-correction-interface.md#Forward-Only-Enforcement]
- FX rate freezing and ledger entry creation workflows [Source: docs/stories/5.1.post-settlement-correction-interface.md#FX-Rate-Management]

From Story 4.4 (Ledger Entry Generation):
- LedgerEntryService with bookmaker-specific aggregation patterns [Source: docs/stories/4.4.ledger-entry-generation.md#LedgerEntryService-Class]
- Transaction management and atomic correction workflows [Source: docs/stories/4.4.ledger-entry-generation.md#Transaction-Atomicity]
- Native currency to EUR conversion with fx_rate_snapshot [Source: docs/stories/4.4.ledger-entry-generation.md#ledger_entries-table]

### Data Models

**bookmaker_balance_checks table** [Source: docs/prd/epic-5-implementation-guide.md#Bookmaker-Balance-Check-Table]:
```sql
CREATE TABLE bookmaker_balance_checks (
    check_id INTEGER PRIMARY KEY AUTOINCREMENT,
    associate_id INTEGER NOT NULL REFERENCES associates(associate_id),
    bookmaker_id INTEGER NOT NULL REFERENCES bookmakers(bookmaker_id),
    balance_native TEXT NOT NULL,  -- Decimal
    currency TEXT NOT NULL,
    checked_at_utc TEXT NOT NULL,
    created_by TEXT NOT NULL DEFAULT 'local_user',
    note TEXT,
    UNIQUE(associate_id, bookmaker_id)  -- One row per bookmaker, UPDATE on new check
);
```

**bookmakers table** [Source: docs/architecture/data-architecture.md#bookmakers-CORE-TABLE]:
```sql
CREATE TABLE bookmakers (
    bookmaker_id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    currency TEXT NOT NULL,  -- Native currency for this bookmaker
    is_active BOOLEAN NOT NULL DEFAULT 1,
    created_at_utc TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ', 'now'))
);
```

**Extended ledger_entries table** [Source: docs/architecture/data-architecture.md#ledger_entries-CRITICAL-TABLE]:
- **bookmaker_id**: Links entries to specific bookmakers (required for BET_RESULT, optional for corrections)
- **amount_native/native_currency**: Original currency amounts
- **fx_rate_snapshot**: EUR conversion rate frozen at creation time

### Bookmaker Balance Service

**BookmakerBalanceService Class** [Source: docs/prd/epic-5-implementation-guide.md#Task-5.3.1]:
```python
@dataclass
class BookmakerBalance:
    """Balance comparison for one bookmaker."""
    associate_id: int
    associate_alias: str
    bookmaker_id: int
    bookmaker_name: str
    currency: str
    
    # Modeled balance (from ledger_entries)
    modeled_balance_eur: Decimal
    modeled_balance_native: Decimal
    fx_rate: Decimal
    
    # Reported balance (from balance checks)
    reported_balance_native: Decimal
    reported_balance_eur: Decimal
    last_checked: Optional[datetime]
    
    # Difference calculation
    difference_native: Decimal
    difference_eur: Decimal
    status: str  # "balanced", "minor_mismatch", "major_mismatch"
    status_icon: str  # ðŸŸ¢, ðŸŸ¡, ðŸ”´

class BookmakerBalanceService:
    """Service for bookmaker balance reconciliation."""
    
    MINOR_MISMATCH_THRESHOLD_EUR = Decimal("10.00")  # Â±â‚¬10
    MAJOR_MISMATCH_THRESHOLD_EUR = Decimal("50.00")  # Â±â‚¬50
    
    def __init__(self, ledger_repo: LedgerEntryRepository, balance_check_repo: BookmakerBalanceCheckRepository):
        self.ledger_repo = ledger_repo
        self.balance_check_repo = balance_check_repo
    
    def get_bookmaker_balances(self, associate_id: Optional[int] = None) -> List[BookmakerBalance]:
        """Calculate modeled vs. reported balances for all bookmakers."""
        
    def update_reported_balance(self, associate_id: int, bookmaker_id: int, balance_native: Decimal, currency: str, note: Optional[str] = None):
        """Update or create bookmaker balance check record."""
        
    def get_correction_prefill(self, balance: BookmakerBalance) -> dict:
        """Generate pre-filled correction form data."""
```

### File Locations

Based on architecture documentation:
- `src/services/bookmaker_balance_service.py` - Core bookmaker balance reconciliation logic [Source: docs/architecture/backend-architecture.md#Service-Layer]
- `src/ui/components/reconciliation/bookmaker_drilldown.py` - Bookmaker balance table component
- `src/ui/pages/6_reconciliation.py` - Extended reconciliation page with drilldown [Source: docs/architecture/frontend-architecture.md#Streamlit-Pages]
- `src/repositories/bookmaker_balance_check_repository.py` - Repository for balance checks table
- `src/services/correction_service.py` - Integration for pre-filled corrections [Source: docs/architecture/backend-architecture.md#Service-Layer]

### Technical Constraints

**Balance Check Table Operations** [Source: docs/prd/epic-5-implementation-guide.md#Task-5.3.1]:
```python
# UPSERT operation for balance checks
def update_reported_balance(self, associate_id: int, bookmaker_id: int, balance_native: Decimal, currency: str, note: Optional[str] = None):
    """Insert new balance check or update existing (UNIQUE constraint on associate_id, bookmaker_id)."""
    
    query = """
    INSERT INTO bookmaker_balance_checks (associate_id, bookmaker_id, balance_native, currency, checked_at_utc, note)
    VALUES (?, ?, ?, ?, ?, ?)
    ON CONFLICT(associate_id, bookmaker_id) 
    DO UPDATE SET 
        balance_native = excluded.balance_native,
        currency = excluded.currency,
        checked_at_utc = excluded.checked_at_utc,
        note = excluded.note
    """
```

**Balance Comparison Logic** [Source: docs/prd/epic-5-implementation-guide.md#Balance-Comparison-Logic]:
```python
# Status determination based on difference thresholds
def determine_status(self, difference_eur: Decimal) -> tuple[str, str]:
    """Determine status and icon based on difference magnitude."""
    abs_difference = abs(difference_eur)
    
    if abs_difference < self.MINOR_MISMATCH_THRESHOLD_EUR:
        return "balanced", "ðŸŸ¢"
    elif abs_difference < self.MAJOR_MISMATCH_THRESHOLD_EUR:
        return "minor_mismatch", "ðŸŸ¡"
    else:
        return "major_mismatch", "ðŸ”´"
```

**Integration with Correction Service** [Source: docs/prd/epic-5-implementation-guide.md#Correction-Prefill-Integration]:
```python
def get_correction_prefill(self, balance: BookmakerBalance) -> dict:
    """Generate pre-filled correction data that integrates with Story 5.1 correction form."""
    return {
        "associate_id": balance.associate_id,
        "bookmaker_id": balance.bookmaker_id,
        "amount_native": str(balance.difference_native),  # String for form input
        "currency": balance.currency,
        "note": f"Balance reconciliation for {balance.bookmaker_name} on {datetime.now().strftime('%Y-%m-%d')}"
    }
```

### Integration Points

**Upstream Dependencies**:
- Epic 4 (Settlement): Produces `BET_RESULT` ledger entries with bookmaker_id
- Story 5.1 (Corrections): Provides pre-fill integration for BOOKMAKER_CORRECTION entries
- Story 5.2 (Associate View): Provides reconciliation context and UI patterns
- Epic 7 (User Management): Associates and bookmakers reference data
- Epic 0 (Foundation): FX rate system for currency conversion

**Downstream Consumers**:
- Story 5.4 (Funding Events): May affect bookmaker-specific holdings
- Epic 6 (Reporting): Uses bookmaker balance data for detailed statements

**UI Integration**:
- Extension of existing reconciliation page (src/ui/pages/6_reconciliation.py)
- Integration with correction form pre-fill workflow
- Real-time balance comparison and status updates
- Export functionality for bookmaker-level balance reports

### Calculation Examples

**Example 1: Major Mismatch Scenario**
```
Bookmaker: Bet365 (Admin)
Modeled Balance: â‚¬500.00 (â‚¬500.00 Ã· 0.65 = â‚¬769.23 AUD)
Reported Balance: â‚¬450.00 AUD (â‚¬450.00 Ã— 0.65 = â‚¬292.50 EUR)
Difference: â‚¬292.50 - â‚¬500.00 = -â‚¬207.50 EUR
Status: ðŸ”´ Red - "Major mismatch - investigate"
Action: "Apply Correction" pre-fills +â‚¬450.00 AUD correction
```

**Example 2: Minor Mismatch Scenario**
```
Bookmaker: DraftKings (Partner A)
Modeled Balance: â‚¬750.00 (â‚¬750.00 Ã· 0.72 = â‚¬1,041.67 USD)
Reported Balance: â‚¬1,080.00 USD (â‚¬1,080.00 Ã— 0.72 = â‚¬777.60 EUR)
Difference: â‚¬777.60 - â‚¬750.00 = +â‚¬27.60 EUR
Status: ðŸŸ¡ Yellow - "Minor mismatch"
Action: Monitor or apply small correction if persistent
```

**Example 3: Balanced Scenario**
```
Bookmaker: Unibet (Partner B)
Modeled Balance: â‚¬320.00 (â‚¬320.00 Ã· 0.58 = â‚¬551.72 EUR)
Reported Balance: â‚¬560.00 EUR (â‚¬560.00 Ã— 0.58 = â‚¬324.80 EUR)
Difference: â‚¬324.80 - â‚¬320.00 = +â‚¬4.80 EUR
Status: ðŸŸ¢ Green - "Balanced"
Action: No action required
```

## Tasks / Subtasks

- [ ] Task 1: Create BookmakerBalanceCheck Repository
  - [ ] Implement BookmakerBalanceCheckRepository with UPSERT operations
  - [ ] Add query methods for latest balance checks by associate/bookmaker
  - [ ] Handle UNIQUE constraint conflicts (associate_id, bookmaker_id)
  - [ ] Add timestamps and audit trail fields

- [ ] Task 2: Build BookmakerBalanceService Core Logic
  - [ ] Implement BookmakerBalance dataclass with all balance comparison fields
  - [ ] Build get_bookmaker_balances method with SQL JOINs
  - [ ] Add calculate_difference method with threshold-based status logic
  - [ ] Implement update_reported_balance method with UPSERT

- [ ] Task 3: Create Bookmaker Drilldown Component
  - [ ] Build bookmaker_drilldown component for balance comparison display
  - [ ] Implement color-coded difference values (ðŸŸ¢ðŸŸ¡ðŸ”´)
  - [ ] Add bookmaker-specific detail breakdown with currency conversion
  - [ ] Implement collapsible associate rows with bookmaker listings

- [ ] Task 4: Build Manual Balance Entry Interface
  - [ ] Create inline balance entry form with associate/bookmaker selectors
  - [ ] Add native currency balance input with validation
  - [ ] Implement "Update Balance" button with form submission
  - [ ] Add timestamp display for "Last checked X hours ago"

- [ ] Task 5: Integrate Correction Pre-fill Workflow
  - [ ] Build get_correction_prefill method with Story 5.1 integration
  - [ ] Add "Apply Correction" buttons to each bookmaker row
  - [ ] Pre-fill correction form with difference amount and note
  - [ ] Ensure correction integration preserves forward-only principles

- [ ] Task 6: Add Filtering and Sorting Features
  - [ ] Implement sortable table by difference magnitude (largest first)
  - [ ] Add "show only mismatches" filter option
  - [ ] Create search/filter by associate or bookmaker
  - [ ] Add export functionality for bookmaker-level reports

- [ ] Task 7: Implement Performance and Validation
  - [ ] Add performance monitoring for large bookmaker datasets
  - [ ] Validate Decimal precision in all currency conversions
  - [ ] Handle edge cases (no balance checks, missing bookmakers)
  - [ ] Add error handling and user feedback for failed operations

## Testing

### Testing Standards

**Test Framework** [Source: docs/architecture/testing-strategy.md#Unit-Testing]:
- Use pytest 7.0+ as testing framework
- Test file naming: `test_` prefix
- Test function naming: descriptive names (e.g., `test_calculate_bookmaker_balance_difference()`)

**Test Structure** [Source: docs/architecture/testing-strategy.md#Test-Organization]:
```
tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ test_bookmaker_balance_service.py     # Core balance service tests
â”‚   â”œâ”€â”€ test_balance_check_repository.py      # Repository UPSERT operation tests
â”‚   â””â”€â”€ test_correction_prefill_integration.py # Pre-fill workflow integration tests
â””â”€â”€ integration/
    â””â”€â”€ test_bookmaker_drilldown_workflow.py   # End-to-end bookmaker reconciliation
```

**Key Test Scenarios**:
```python
def test_calculate_modeled_balance_from_ledger():
    """Test modeled balance calculation from ledger_entries aggregation"""
    
def test_update_reported_balance_upsert():
    """Test UPSERT operation for balance checks (INSERT or UPDATE)"""
    
def test_calculate_difference_major_mismatch():
    """Test difference calculation triggering major mismatch status"""
    
def test_calculate_difference_balanced():
    """Test difference calculation within balanced threshold"""
    
def test_correction_prefill_generation():
    """Test pre-filled correction form data generation"""
    
def test_status_determination_thresholds():
    """Test color coding determination based on difference magnitude"""
    
def test_currency_conversion_accuracy():
    """Test native to EUR conversion with proper FX rates"""
    
def test_bookmaker_balance_table_joins():
    """Test SQL JOINs between ledger_entries, associates, and bookmakers"""
    
def test_integration_with_correction_service():
    """Test integration with Story 5.1 correction interface"""
```

**UI Testing Approach** [Source: docs/architecture/testing-strategy.md#Integration-Testing]:
For Streamlit bookmaker drilldown interface:
1. **Unit tests** for bookmaker balance service business logic
2. **Unit tests** for balance check repository operations
3. **Integration tests** for complete bookmaker reconciliation workflow
4. **Manual testing** for drilldown display and correction pre-fill

### Test Data Requirements

**Required Test Fixtures**:
- Associates with multiple bookmakers each
- Various ledger entry scenarios: bets on different bookmakers, corrections
- Balance checks with different timestamps and values
- Multiple currencies with corresponding FX rates
- Edge cases: bookmakers with no entries, missing balance checks
- Validation scenarios: malformed data, missing foreign keys

**Balance Check Test Scenarios**:
- New balance check (INSERT operation)
- Existing balance check update (UPDATE operation via UNIQUE constraint)
- Balance checks with different currencies than bookmaker default
- Stale balance checks (older than expected threshold)

## Dev Agent Record

### Agent Model Used

- Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

- None required - implementation pending

### Completion Notes List

- Implementation in progress

### File List

**Source Files**:
- src/services/bookmaker_balance_service.py - BookmakerBalanceService with balance comparison logic
- src/repositories/bookmaker_balance_check_repository.py - Repository for balance checks table operations
- src/ui/components/reconciliation/bookmaker_drilldown.py - Streamlit bookmaker drilldown interface

**Test Files**:
- tests/unit/test_bookmaker_balance_service.py - Core balance service tests
- tests/unit/test_balance_check_repository.py - Repository operation tests
- tests/integration/test_bookmaker_drilldown_workflow.py - End-to-end workflow tests

**Modified Files**:
## Change Log

### 2025-11-03T15:10:00Z - Initial Draft

- Created story 5.3 with comprehensive acceptance criteria for bookmaker balance drilldown
- Integrated with existing reconciliation dashboard (Story 5.2) and correction interface (Story 5.1)
- Defined BookmakerBalanceService with difference calculation and threshold-based status logic
- Established bookmaker_balance_checks table schema with UPSERT operations
- Added correction pre-fill integration for seamless workflow
- Comprehensive test coverage plan for balance comparison and reconciliation workflows