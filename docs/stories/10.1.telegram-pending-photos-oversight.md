# Story 10.1: Telegram Pending Photos Oversight

## Status
Draft

## Story
As an operator, I need a dedicated Pending Photos oversight table so I can see every TTL-limited confirm-before-ingest item and triage it with discard or force ingest actions that mirror the Telegram bot behavior described in `docs/front-end-spec.md:1`.

## Acceptance Criteria

1. The table lists chat_id, message_id, associate alias, bookmaker, and a TTL countdown (seconds until auto-discard) sourced from `pending_photos` (`src/core/schema.py:275`).
2. Countdown updates every second, highlights entries approaching expiry, and greys them out when the same auto-discard path kicks in (`src/integrations/telegram_bot.py:2209`).
3. Discard button is always visible, logs the operator and reason, reuses `src/integrations/telegram_bot.py:2209`, and removes the row and TTL clock once confirmed.
4. Force Ingest button is hidden/off by default, mandates a justification modal, and calls `src/integrations/telegram_bot.py:1947` with the same approval flow plus `1998` and `2086` to mimic the bot while still logging the human override.
5. Every action appends a structured event to the existing Telegram audit trail (message_id, operator, reason, outcome).

## Tasks / Subtasks

- [ ] Data Layer Implementation (AC: #1)
  - [ ] Query active rows from `pending_photos` table
  - [ ] Surface TTL along with photo metadata (chat_id, message_id, associate alias, bookmaker)
  - [ ] Implement TTL calculation logic aligned with backend
- [ ] UI Table Development (AC: #1, #2)
  - [ ] Create oversight table with required columns
  - [ ] Implement real-time countdown display (updates every second)
  - [ ] Add highlighting for entries approaching expiry
  - [ ] Implement grey-out state for auto-discarded items
- [ ] Discard Functionality (AC: #3)
  - [ ] Add Discard button to table rows
  - [ ] Implement operator and reason logging
  - [ ] Integrate with `src/integrations/telegram_bot.py:2209` discard logic
  - [ ] Remove row and TTL clock upon confirmation
- [ ] Force Ingest Implementation (AC: #4)
  - [ ] Add Force Ingest button (hidden/off by default)
  - [ ] Build justification modal for operator input
  - [ ] Integrate with `src/integrations/telegram_bot.py:1947` approval flow
  - [ ] Include calls to `1998` and `2086` to mimic bot behavior
  - [ ] Ensure same admin gate respect as bot implementation
- [ ] Audit Trail Integration (AC: #5)
  - [ ] Extend existing Telegram audit trail for UI actions
  - [ ] Log structured events (message_id, operator, reason, outcome)
  - [ ] Ensure audit consistency between bot and UI actions
- [ ] Real-time Synchronization (AC: #2)
  - [ ] Keep pending list in sync via fragments or short polling
  - [ ] Ensure TTL countdown never drifts from backend
  - [ ] Reuse TTL logic from `src/integrations/telegram_bot.py`
- [ ] Testing Implementation
  - [ ] Unit tests for TTL formatting and state transitions
  - [ ] Integration tests for discard and force ingest flows
  - [ ] Extend existing telegram approval workflow tests

## Dev Notes

### Relevant Source Tree Information
- `src/core/schema.py:275` - Contains `pending_photos` table schema
- `src/integrations/telegram_bot.py:2209` - Auto-discard logic to reuse
- `src/integrations/telegram_bot.py:1947` - Force ingest approval flow to mimic
- `src/integrations/telegram_bot.py:1998` - Additional approval flow component
- `src/integrations/telegram_bot.py:2086` - Additional approval flow component
- `docs/front-end-spec.md:1` - Front-end specifications for UI behavior
- `tests/integration/test_telegram_approval_workflow.py:1` - Existing test file to extend

### Key Implementation Details
- Force Ingest must respect the same admin gate as `src/integrations/telegram_bot.py:1947` so the UI cannot override policy
- Keep the pending list in sync via fragments or short polling so the TTL countdown never drifts
- Reuse TTL logic from `src/integrations/telegram_bot.py` to keep the UI countdown in sync with the backend
- Build an accessible justification modal for Force Ingest that captures operator name and reason
- Every action must append structured events to existing Telegram audit trail

### TTL Management
- Countdown updates every second in real-time
- Highlights entries approaching expiry (visual warning)
- Greys out entries when auto-discard path activates
- Synchronization with backend TTL logic to prevent drift
- Remove row and TTL clock upon successful discard

### UI State Management
- Discard button always visible for all entries
- Force Ingest button hidden/off by default (admin gate)
- Real-time table updates without full page refresh
- Modal dialog for justification input (Force Ingest)
- Visual feedback for all action outcomes

### Testing

**Test File Locations:**
- `tests/integration/test_telegram_approval_workflow.py` - Extend existing tests
- `tests/unit/test_pending_photos_oversight.py` - New unit tests for UI logic
- `tests/unit/test_ttl_management.py` - TTL formatting and state transition tests
- `tests/integration/test_telegram_audit_trail.py` - Audit trail integration tests

**Testing Standards:**
- Follow existing pytest patterns in the codebase
- Use factory pattern for test data creation
- Mock Telegram bot dependencies for isolated UI testing
- Test real-time TTL countdown behavior with time manipulation
- Include both positive and negative test scenarios

**Testing Requirements:**
- Verify TTL formatting accuracy and visual state transitions
- Test Discard action integration with existing bot logic
- Validate Force Ingest justification modal and admin gate enforcement
- Ensure audit trail consistency between bot and UI actions
- Test real-time synchronization and countdown accuracy
- Verify table updates and row removal upon actions
- Test edge cases (concurrent actions, network delays, etc.)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-10 | 1.0 | Initial story creation with template format | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent after implementation*
