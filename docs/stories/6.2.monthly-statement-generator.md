# Story 6.2: Monthly Statement Generator

**Status:**Ready for Review

**As a** system operator,
**I want** to generate per-associate statements showing funding, entitlement, and 50/50 split,
**so that** I can share profit reports with partners.

## Acceptance Criteria

1. **"Monthly Statements" page with input panel:**
   - Associate selector: Dropdown from `associates.display_alias`
   - Cutoff date picker: Default to end of current month (e.g., "2025-10-31 23:59:59 UTC")
   - Note: "All transactions up to and including this date"
   - "Generate Statement" button

2. **Output Panel with Statement Header:**
   - Monthly Statement for [Associate Name]
   - Period ending: [Cutoff Date]
   - Generated: [Current Timestamp]

3. **Partner-Facing Section (Shareable):**
   - Funding Summary: `NET_DEPOSITS_EUR = SUM(DEPOSIT.amount_eur) - SUM(WITHDRAWAL.amount_eur)` up to cutoff
   - Display: "You funded: â‚¬X,XXX.XX total" with explanation
   - Entitlement Summary: `SHOULD_HOLD_EUR = SUM(principal_returned_eur + per_surebet_share_eur)` from all BET_RESULT rows up to cutoff
   - Display: "You're entitled to: â‚¬X,XXX.XX" with explanation
   - Profit/Loss Summary: `RAW_PROFIT_EUR = SHOULD_HOLD_EUR - NET_DEPOSITS_EUR`
   - Display profit (green) or loss (red) with explanation
   - 50/50 Split Calculation showing your share and admin share with explanatory note

4. **Internal-Only Section (NOT for partners):**
   - Current Holdings: `CURRENT_HOLDING_EUR = SUM(all ledger entries)` up to cutoff
   - Display: "Currently holding: â‚¬X,XXX.XX" with explanation
   - Reconciliation Delta: `DELTA = CURRENT_HOLDING_EUR - SHOULD_HOLD_EUR`
   - Display delta status with color coding: ðŸ”´ Holding more, ðŸŸ¢ Balanced, ðŸŸ  Short

5. **Export Options:**
   - "Copy to Clipboard" button (partner-facing section only)
   - "Export to PDF" button (future, for now just text)
   - "Export to CSV" button (detailed transaction list for this associate)

6. **Validation:**
   - Cutoff date cannot be in future
   - Associate required

7. **CRITICAL: Monthly statements are presentation ONLY**
   - Do NOT create ledger entries
   - Do NOT modify entitlement math
   - Read-only queries

## Tasks / Subtasks

- [x] Create Monthly Statements page UI structure (AC: 1)
  - [x] Add new page file: `src/ui/pages/6_statements.py`
  - [x] Implement associate selector dropdown from database
  - [x] Add cutoff date picker with default to end of current month
  - [x] Implement "Generate Statement" button with proper styling
  - [x] Add page to main navigation in `src/ui/app.py`
  - [x] Apply consistent UI patterns from existing pages

- [x] Implement statement calculation service logic (AC: 2, 3, 4)
  - [x] Create `src/services/statement_service.py`
  - [x] Implement NET_DEPOSITS_EUR calculation (DEPOSIT - WITHDRAWAL)
  - [x] Implement SHOULD_HOLD_EUR calculation (principal_returned_eur + per_surebet_share_eur)
  - [x] Implement CURRENT_HOLDING_EUR calculation (all ledger entries)
  - [x] Implement RAW_PROFIT_EUR and DELTA calculations
  - [x] Add cutoff date filtering to all queries (WHERE created_at_utc <= cutoff)

- [x] Format and display statement sections (AC: 2, 3, 4)
  - [x] Create statement header with associate name, cutoff date, generated timestamp
  - [x] Format currency values with commas (e.g., "â‚¬1,234.56")
  - [x] Round to 2 decimal places for display
  - [x] Implement profit/loss color coding (green for profit, red for loss)
  - [x] Implement delta status indicators (ðŸ”´ðŸŸ¢ðŸŸ ) with explanations
  - [x] Add explanatory text for each calculation as specified

- [x] Add export functionality (AC: 5)
  - [x] Implement "Copy to Clipboard" for partner-facing section
  - [x] Add "Export to CSV" for detailed transaction list
  - [x] Prepare foundation for future "Export to PDF" functionality
  - [x] Implement proper CSV formatting for associate-specific transactions

- [x] Add validation and error handling (AC: 6, 7)
  - [x] Validate cutoff date is not in future
  - [x] Ensure associate is selected before generation
  - [x] Add read-only constraint enforcement (no ledger writes)
  - [x] Handle database errors gracefully
  - [x] Log statement generation for audit trail

- [x] Add comprehensive testing (Backend & UI)
  - [x] Unit tests for statement service calculation logic
  - [x] Integration tests for complete statement generation workflow
  - [x] Test with various associate scenarios (profitable, loss, balanced)
  - [x] Test cutoff date filtering and edge cases
  - [x] UI testing for form interactions and display formatting

## Dev Notes

### Database Schema Context
**Source:** `docs/architecture/data-architecture.md` [Source: architecture/data-architecture.md#ledger_entries]

The `ledger_entries` table structure for statement calculations:
```sql
CREATE TABLE ledger_entries (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    type TEXT NOT NULL CHECK (type IN ('BET_RESULT', 'DEPOSIT', 'WITHDRAWAL', 'BOOKMAKER_CORRECTION')),
    associate_id INTEGER NOT NULL REFERENCES associates(id),
    bookmaker_id INTEGER REFERENCES bookmakers(id),
    amount_native TEXT NOT NULL,
    native_currency TEXT NOT NULL,
    fx_rate_snapshot TEXT NOT NULL,
    amount_eur TEXT NOT NULL,
    settlement_state TEXT CHECK (settlement_state IN ('WON', 'LOST', 'VOID') OR settlement_state IS NULL),
    principal_returned_eur TEXT,
    per_surebet_share_eur TEXT,
    surebet_id INTEGER REFERENCES surebets(id),
    bet_id INTEGER REFERENCES bets(id),
    settlement_batch_id TEXT,
    created_at_utc TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ', 'now')),
    created_by TEXT NOT NULL DEFAULT 'local_user',
    note TEXT
);
```

### Reconciliation Query Patterns
**Source:** `docs/architecture/data-architecture.md` [Source: architecture/data-architecture.md#reconciliation-queries-fr-8]

#### NET_DEPOSITS_EUR
```sql
SELECT
    SUM(
        CASE
            WHEN type = 'DEPOSIT' THEN CAST(amount_eur AS REAL)
            WHEN type = 'WITHDRAWAL' THEN -CAST(amount_eur AS REAL)
            ELSE 0
        END
    ) AS net_deposits_eur
FROM ledger_entries
WHERE associate_id = ?
AND type IN ('DEPOSIT', 'WITHDRAWAL')
AND created_at_utc <= ?;
```

#### SHOULD_HOLD_EUR (Entitlement)
```sql
SELECT
    SUM(
        CAST(principal_returned_eur AS REAL) +
        CAST(per_surebet_share_eur AS REAL)
    ) AS should_hold_eur
FROM ledger_entries
WHERE associate_id = ?
AND type = 'BET_RESULT'
AND created_at_utc <= ?;
```

#### CURRENT_HOLDING_EUR
```sql
SELECT
    SUM(CAST(amount_eur AS REAL)) AS current_holding_eur
FROM ledger_entries
WHERE associate_id = ?
AND created_at_utc <= ?;
```

### File Location and Structure
**Source:** Project structure from `docs/architecture/source-tree.md` [Source: architecture/source-tree.md#src-ui-directory]

- New page: `src/ui/pages/6_statements.py`
- Service: `src/services/statement_service.py`
- Unit tests: `tests/unit/test_statement_service.py`
- Integration tests: `tests/integration/test_statement_flow.py`
- Update main navigation in `src/ui/app.py`

### Technology Stack
**Source:** `docs/architecture/tech-stack.md` [Source: architecture/tech-stack.md#core-libraries]

Key libraries to use:
- `streamlit>=1.30.0` for UI components
- `pandas>=2.1.0` for CSV export and data manipulation
- `python-dotenv>=1.0.0` for environment configuration
- `structlog>=23.0.0` for structured logging

### Decimal Handling Requirements
**Source:** `docs/architecture/coding-standards.md` [Source: architecture/coding-standards.md#decimal-usage-critical]

- All currency values stored as TEXT in SQLite to preserve Decimal precision
- Convert Decimal to string for display to maintain precision
- Format with commas for display: "â‚¬1,234.56"
- Round to 2 decimal places for UI display
- Never use float for currency calculations

### Database Connection Pattern
**Source:** `docs/architecture/backend-architecture.md` [Source: architecture/backend-architecture.md#core-services]

```python
# Standard connection pattern
from src.core.database import get_db_connection

def generate_statement(associate_id: int, cutoff_date: str):
    conn = get_db_connection()
    try:
        # Query and calculation logic
        pass
    finally:
        conn.close()
```

### UI Standards and Modern Features
**Source:** `docs/architecture/frontend-architecture.md` [Source: architecture/frontend-architecture.md#page-6-monthly-statements-fr-10]

- Use `@st.fragment` for statement generation to avoid full page reruns
- Use `st.status` for generation progress display
- Implement "Export to PDF" placeholder (future feature)
- Use `st.data_editor` for transaction details display
- Apply modern UI patterns with cards and proper layout
- Use `st.toast` for success notifications

### Error Handling Standards
**Source:** `docs/architecture/coding-standards.md` [Source: architecture/coding-standards.md#error-handling]

Use specific exceptions and structured logging:
```python
import structlog
logger = structlog.get_logger()

try:
    # Statement generation logic
    pass
except ValueError as e:
    logger.error("statement_validation_failed", associate_id=associate_id, error=str(e))
    raise
except Exception as e:
    logger.error("statement_generation_failed", associate_id=associate_id, error=str(e))
    raise
```

### Currency Formatting Standards
**Source:** `docs/architecture/coding-standards.md` [Source: architecture/coding-standards.md#decimal-usage-critical]

```python
from decimal import Decimal

def format_currency(amount: Decimal) -> str:
    """Format Decimal as Euro currency with commas"""
    return f"â‚¬{amount:,.2f}"

# Example: format_currency(Decimal("1234.56")) -> "â‚¬1,234.56"
```

### Testing Standards
**Source:** `docs/architecture/coding-standards.md` [Source: architecture/coding-standards.md#testing-standards]

Test file naming and structure:
- Unit tests: `tests/unit/test_statement_service.py`
- Integration tests: `tests/integration/test_statement_flow.py`
- Use AAA pattern (Arrange, Act, Assert)
- Test with various scenarios: profitable associate, loss position, balanced case
- Test cutoff date edge cases and validation

### Previous Story Context
**Source:** Story 6.1 completion notes [Source: docs/stories/6.1.ledger-csv-export.md#dev-agent-record]

Story 6.1 successfully implemented ledger CSV export functionality with:
- Robust SQL query patterns for ledger data extraction
- Proper decimal precision handling and UTF-8 encoding
- Export history functionality and file management
- Comprehensive test coverage and validation logic
- UI patterns for export functionality that can be adapted for statements

### Critical Constraints from Epic 6
**Source:** Epic 6 technical notes [Source: docs/prd/epic-6-reporting-audit.md#monthly-statement-semantics]

- **Statements are snapshots, not transactions** - Do NOT create ledger entries
- **Do NOT modify entitlement math** - Presentation layer only
- **50/50 split is explanatory** - System already does equal-split through per_surebet_share_eur
- **Use same formulas as Epic 5** reconciliation math
- **Filter by cutoff date** - All queries use `WHERE created_at_utc <= cutoff`

### Performance Considerations
**Source:** Epic 6 technical notes [Source: docs/prd/epic-6-reporting-audit.md#csv-export-performance]

- Handle large associate histories (10k+ transactions) efficiently
- Use streaming for CSV export to avoid memory issues
- Consider progress indicator for statements taking >5 seconds
- Optimize SQL queries with proper indexing on associate_id and created_at_utc

### File Locations for New Code
Based on source tree structure [Source: architecture/source-tree.md]:
- Service: `src/services/statement_service.py`
- UI Page: `src/ui/pages/6_statements.py`
- Unit tests: `tests/unit/test_statement_service.py`
- Integration tests: `tests/integration/test_statement_flow.py`

### Environment Configuration
**Source:** `docs/architecture/source-tree.md` [Source: architecture/source-tree.md#env-file]

Ensure proper database connection and logging configuration:
```python
import os
from src.core.config import Config
from src.core.database import get_db_connection
```

### UI Integration Requirements
**Source:** `docs/architecture/frontend-architecture.md` [Source: architecture/frontend-architecture.md#page-6-monthly-statements-fr-10]

- Add page to main navigation with icon ðŸ“Š
- Use consistent styling with existing pages
- Implement input validation and user feedback
- Use modern Streamlit features where available
- Follow the established page patterns for forms and results display

## Testing

### Unit Testing Requirements
- Test all reconciliation calculations (NET_DEPOSITS_EUR, SHOULD_HOLD_EUR, CURRENT_HOLDING_EUR)
- Test profit/loss and DELTA calculations with various scenarios
- Test cutoff date filtering logic
- Test currency formatting and rounding
- Test validation rules (future dates, missing associate)

### Integration Testing Requirements
- Test complete statement generation workflow from UI to display
- Test with realistic associate data including all entry types
- Test export functionality (clipboard, CSV)
- Test partner-facing vs internal-only section separation
- Test cutoff date edge cases (month boundaries, timezone handling)

### Scenario Testing
- **Profitable Associate**: Test with associate who has net profit
- **Loss Position**: Test with associate who has net loss
- **Balanced Case**: Test with associate at break-even
- **New Associate**: Test with minimal transaction history
- **Large History**: Test with associate having 1000+ transactions

### UI Testing
- Test associate selector population and selection
- Test cutoff date picker default values and validation
- Test "Generate Statement" button behavior
- Test export button functionality
- Test responsive design on different screen sizes

## Change Log

| Date | Version | Description | Author |
|------|--------|-------------|--------|
| 2025-11-05 | 1.0 | Initial story creation for Epic 6 | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Act Mode) - Full Stack Developer Agent

### Debug Log References
- Statement generation validation: All calculations validate correctly with test data
- Database query testing: All SQL queries execute properly with cutoff date filtering
- UI integration testing: Streamlit page loads and functions correctly
- Export functionality testing: Clipboard and CSV export work as expected

### Completion Notes List
- Successfully implemented complete monthly statement generation system with all acceptance criteria met
- Created robust calculation service with proper decimal precision handling
- Implemented both partner-facing and internal-only statement sections
- Added comprehensive export functionality (clipboard, CSV) with future PDF foundation
- Applied consistent UI patterns following existing page structure
- Ensured read-only operations with no ledger entry creation
- Added proper validation for cutoff dates and associate selection
- Implemented comprehensive test coverage (23 unit tests passing)
- All calculations follow Epic 6 reconciliation math patterns
- Currency formatting with proper comma separators and 2-decimal rounding
- Color-coded profit/loss and delta status indicators
- Structured logging for audit trail and debugging

### File List
**New Files Created:**
- `src/services/statement_service.py` - Core statement calculation service
- `src/ui/pages/6_statements.py` - Monthly statements UI page
- `tests/unit/test_statement_service.py` - Comprehensive unit tests (23 tests)
- `tests/integration/test_statement_flow.py` - Integration tests for complete workflow

**Modified Files:**
- `src/ui/app.py` - Added statements page to main navigation
- `docs/stories/6.2.monthly-statement-generator.md` - Updated with completion status

**Key Features Implemented:**
- Associate selector dropdown populated from database
- Cutoff date picker with default to end of current month
- Statement generation with progress indicators
- Partner-facing section with funding, entitlement, and 50/50 split
- Internal-only section with current holdings and reconciliation delta
- Export to clipboard (partner-facing section only)
- Export to CSV (detailed transaction list)
- Comprehensive validation and error handling
- Responsive UI design with modern Streamlit patterns

## QA Results

[To be populated by QA agent after implementation]
