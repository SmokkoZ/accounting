# Story 9.9: Admin Bookmaker Financial Snapshot

## Status
Approved

## Story
As an operations admin, I want the "Admin & Associates" bookmaker table to surface each bookmaker's cash position so I can see balances, pending exposure, and deposits without leaving the management surface.

## Acceptance Criteria

1. In the modern "Admin & Associates" page, the bookmaker editor hides the "Parsing Profile (JSON)", "Created", and "Updated" columns while keeping the existing editing experience for names, chats, and status.
2. The bookmaker editor shows three read-only numeric columns:
   - `Balance (CUR) and (EUR)`: latest reported bookmaker balance (or blank when no check exists).
   - `Pending Balance (CUR) and (EUR)`: sum of all verified/matched bet stakes for that bookmaker.
   - `Deposits (CUR) and (EUR)`: net deposits (deposits minus withdrawals) recorded against that bookmaker.
   - `Profits (CUR) and (EUR)`: profits (net earned from surebets after splitting revenues and subtracting deposits) recorded against that bookmaker.
3. Balance/pending/deposits/profits recalc automatically from the database so the table reflects the latest balance checks, bets, and funding transactions with no manual refresh.
4. Sorting works for the new numeric columns and no longer offers the removed Created/Updated sort options.

## Tasks / Subtasks

- [ ] Backend Data Enrichment (AC: #2, #3)
  - [ ] Extend `load_bookmakers_for_associate` to annotate each bookmaker with latest reported balance
  - [ ] Add pending stake sum calculation using `BookmakerBalanceService.get_pending_balance_summary` logic
  - [ ] Implement net deposits calculation from `ledger_entries` where `type IN ('DEPOSIT','WITHDRAWAL')`
  - [ ] Add profits calculation (surebet earnings minus deposits)
- [ ] UI Column Configuration (AC: #1, #2)
  - [ ] Update typed data editor dataframe/column config to drop parsing profile + timestamps
  - [ ] Add three new read-only numeric columns with CUR and EUR formatting
  - [ ] Implement appropriate tooltips for new financial columns
  - [ ] Ensure associate filtering/additions continue working
- [ ] Data Persistence (AC: #1)
  - [ ] Ensure bookmaker update/insert logic preserves existing parsing profiles
  - [ ] Keep older/legacy associate management components working by leaving raw SQL fields untouched
- [ ] Sorting and Refresh (AC: #3, #4)
  - [ ] Implement sorting functionality for new numeric columns
  - [ ] Remove Created/Updated sort options
  - [ ] Ensure automatic recalculation from database without manual refresh
- [ ] Testing Implementation
  - [ ] Unit tests for data enrichment functions
  - [ ] Integration tests for UI column updates
  - [ ] End-to-end tests for sorting and refresh functionality

## Dev Notes

### Relevant Source Tree Information
- `src/services/bookmaker_balance_service.py` - Contains `get_pending_balance_summary` logic to reuse
- `src/repositories/associate_hub_repository.py` - Contains `load_bookmakers_for_associate` function to extend
- `src/core/ledger_entries.py` - Ledger entries schema for deposit/withdrawal calculations
- `src/ui/admin/` - Admin UI components for bookmaker management
- `src/services/ledger_entry_service.py` - Ledger service for transaction calculations

### Key Implementation Details
- Pending balance should reuse the same logic as `BookmakerBalanceService.get_pending_balance_summary` (verified/matched stakes in EUR) to avoid disagreements
- Net deposits are derived from `ledger_entries` where `type IN ('DEPOSIT','WITHDRAWAL')` and `bookmaker_id` matches
- Keep the older/legacy associate management components working by leaving the raw SQL query fields (`parsing_profile`, timestamps) untouched for those flows
- Profits calculation: net earned from surebets after splitting revenues and subtracting deposits
- Automatic database recalculation ensures real-time financial visibility

### Data Calculation Logic
- **Balance**: Latest reported bookmaker balance from balance checks
- **Pending Balance**: Sum of verified/matched bet stakes for that bookmaker
- **Deposits**: Net deposits (deposits minus withdrawals) from ledger entries
- **Profits**: Surebet earnings minus deposits and revenue splits

### UI Considerations
- New columns should be read-only to prevent direct financial data manipulation
- Proper formatting for both native currency (CUR) and EUR equivalents
- Tooltips to explain calculation methods and data sources
- Maintain existing editing experience for names, chats, and status columns

### Testing

**Test File Locations:**
- `tests/unit/test_bookmaker_balance_service.py` - Tests for balance calculation logic
- `tests/unit/test_associate_hub_repository.py` - Tests for data enrichment functions
- `tests/integration/test_admin_bookmaker_ui.py` - Integration tests for UI updates
- `tests/e2e/test_bookmaker_financial_columns.py` - End-to-end tests for complete workflow

**Testing Standards:**
- Follow existing pytest patterns in the codebase
- Use factory pattern for test data creation
- Mock external dependencies for consistent test results
- Test both populated and empty bookmaker scenarios
- Include sorting and refresh functionality tests

**Testing Requirements:**
- Verify accurate calculation of all financial metrics
- Test UI column hiding/showing logic
- Validate sorting functionality for new columns
- Ensure automatic refresh works without manual intervention
- Test compatibility with existing bookmaker management flows
- Verify data persistence for parsing profiles

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-10 | 1.0 | Initial story creation with template format | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent after implementation*
