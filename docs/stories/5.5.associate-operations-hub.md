# Story 5.5: Associate Operations Hub

## Status: Draft

## Story

**As the operator**, I want a unified operations hub where I can review and update associates, their bookmakers, balances, and funding transactions from one screen so that daily administration does not require hopping between multiple pages.

## Acceptance Criteria

- [ ] **Navigation**: New "Associate Operations" page is available from the admin navigation and loads within two seconds with default filters applied.
- [ ] **Filter Bar**:
  - Persistent search box (alias, bookmaker, chat id) with debounce to avoid choppy reruns.
  - Multi-select filters for admin flag, associate active status, bookmaker active status, and currency.
  - Sort selector supporting alias A→Z/Z→A, DELTA high→low, and last-activity newest→oldest.
  - Filters are retained in `st.session_state` across reruns.
- [ ] **Associate Summary Rows**:
  - Each row displays admin badge, home currency, bookmaker count, NET_DEPOSITS_EUR, SHOULD_HOLD_EUR, CURRENT_HOLDING_EUR, DELTA, and a status pill (balanced / overholding / short) reusing Story 5.2 palette.
  - Rows support expand/collapse and collapse state persists while navigating the list.
- [ ] **Bookmaker Sub-table**:
  - Columns: name, active flag, parsing profile snippet, modeled balance, latest reported balance, delta badge, last balance check timestamp.
  - Inline action buttons: Edit Bookmaker, Manage Balance, Deposit, Withdraw.
- [ ] **Detail Drawer / Modal**:
  - Profile tab for editing associate alias, currency, admin flag, multibook chat id and editing bookmaker fields, reusing Story 7.1/7.2 validations.
  - Balances tab embedding Story 5.3 history table and forms (add/edit/delete balance check) scoped to the selected bookmaker.
  - Transactions tab for deposit/withdraw flows plus recent ledger history filtered to the current associate/bookmaker (last 30 days).
- [ ] **Funding Actions**:
  - Deposit/withdraw modals enforce positive numeric input, supported currency, optional bookmaker override, and optional note.
  - Submissions create new `ledger_entries` rows via a service wrapper, capture FX snapshot, emit success toast, and update metrics immediately.
- [ ] **UX Quality**:
  - Empty states for filters returning zero rows describe how to reset filters.
  - Error handling surfaces validation messages inline; unexpected exceptions go to structuredlog with user-visible alert.
  - Large rosters (>25 associates) paginate with sticky header row.
- [ ] **Audit & Activity**: Recent balance checks and funding transactions display entry id, timestamp (localised), operator, and note for traceability.

## Dev Notes

### Scope & Dependencies
- Builds on Story 5.1 (corrections), Story 5.2 (associate reconciliation tiles), Story 5.3 (balance history), and Story 5.4 (funding events).
- Reuses UI primitives introduced in Story 7.1-7.3 for associate/bookmaker management; lift them into `src/ui/components/associate_hub/`.
- Requires `BookmakerBalanceService` aggregates and ledger math to be performant for repeated refreshes.

### UI Architecture
- Page entry point: `src/ui/pages/8_associate_operations.py`.
- Extract reusable components:
  - `filters.py` for the sticky filter bar + session state.
  - `listing.py` for associate/bookmaker rendering with expandable rows and action buttons.
  - `drawer.py` for the multi-tab detail surface (Profile, Balances, Transactions).
- Use `st.session_state` to store filters and currently selected associate/bookmaker; avoid `st.experimental_memo` for stateful data.
- Prefer `st.tabs` inside the drawer to keep context visible while editing.

### Data & Services
- New `FundingTransactionService.record_transaction(...)` wraps ledger writes for DEPOSIT/WITHDRAWAL to keep business rules centralised.
- Introduce `AssociateHubRepository`:
  - `list_associates_with_metrics(filters)` returns NET_DEPOSITS_EUR, SHOULD_HOLD_EUR, CURRENT_HOLDING_EUR, DELTA, bookmaker counts, last activity timestamp.
  - `list_bookmakers_for_associate(associate_id)` fetches modeled vs reported balances plus latest balance check meta.
- Balance history and checks reuse Story 5.3 helpers; ensure conversions use Decimal with two decimal places.
- All DB operations must honour append-only ledger guarantees (no UPDATE on ledger entries).

### Validation & UX
- Validation helpers live in `src/ui/utils/validators.py`; extend only if new rules are required.
- Deposit/withdraw modals normalize sign conventions (store positive numbers for DEPOSIT, negative for WITHDRAWAL calculation handled in service).
- Provide toast feedback (`st.success` / `st.error`) and keep forms open when validation fails.
- Preserve scroll position using `st.container()` sections so updates do not snap users back to the top.

### Telemetry & Logging
- Emit `associate_hub_action` events via `structlog` with fields: action (`deposit`, `withdraw`, `balance_check_add`, `profile_update`), associate_id, bookmaker_id, amount_eur (if applicable).
- Capture latency metrics for fetching aggregates to monitor scaling pressure.

## Test Strategy

- **Unit Tests**: Cover `FundingTransactionService` (ledger rows, FX snapshot usage, validation errors) and repository methods (filtering, sorting, pagination).
- **Integration Tests**: Exercising the Streamlit components via `pytest` + `streamlit.testing` to validate filter persistence and action callbacks (happy path + validation failure).
- **Manual QA Scenarios**:
  1. Update balance check, add deposit, and edit profile without leaving the page (mirrors PRD Scenario 5).
  2. Filter by inactive bookmakers and confirm listing changes but drawer context remains.
  3. Attempt invalid deposit (zero amount) and verify inline error + no ledger write.

## Open Questions / Follow-ups

- Do we retire `7_admin_associates.py` / `balance_management.py` once the hub reaches parity, or leave them as fallback for early adopters?
- Should deposits/withdrawals optionally attach to specific bookmakers by default, or remain associate-level unless specified?
- Future enhancement: integrate Telegram bot feed so funding drafts auto-populate in the Transactions tab.

