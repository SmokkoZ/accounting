# Story 8.5: Data Editing Modernization

## Status
Approved

## Story
**As a** system administrator, **I want** typed, validated editors, **so that** CRUD is intuitive and safe.

## Acceptance Criteria

1. Associates: `st.data_editor` with `column_config`
2. Bookmakers: typed selects + validation
3. Master-detail (bookmakers filtered by selected associate)
4. Bulk selection for associate deactivation
5. `num_rows="fixed"` where strict CRUD is required
6. Read-only ID columns, disabled editing
7. Validate share percentages, currency codes, etc.

## Tasks / Subtasks

- [ ] Task 1: Create editor helper module with data_editor configurations (AC: 1, 2, 5, 6)
  - [ ] Create `src/ui/helpers/editor.py` with column configurations
  - [ ] Implement associate editor configuration with typed columns
  - [ ] Implement bookmaker editor configuration with validation
  - [ ] Add reusable editor wrapper functions
  - [ ] Add validation helpers for share percentages and currency codes

- [ ] Task 2: Implement master-detail associates page structure (AC: 3)
  - [ ] Create top-level associates data editor with selection capability
  - [ ] Create filtered bookmakers data editor below associates
  - [ ] Implement associate selection â†’ bookmaker filtering logic
  - [ ] Add session state management for selected associate
  - [ ] Test master-detail interaction and data flow

- [ ] Task 3: Replace associate CRUD with data_editor (AC: 1, 5, 6, 7)
  - [ ] Update `src/ui/pages/7_admin_associates.py` associates section
  - [ ] Replace current forms with `st.data_editor` using editor helpers
  - [ ] Configure read-only ID columns and required field validation
  - [ ] Implement add/remove row functionality where appropriate
  - [ ] Add validation for alias uniqueness and currency codes
  - [ ] Test associate CRUD operations through data_editor

- [ ] Task 4: Replace bookmaker CRUD with data_editor (AC: 2, 5, 6, 7)
  - [ ] Update bookmakers section to use `st.data_editor`
  - [ ] Configure typed selects for parsing profiles and status
  - [ ] Implement bookmaker name validation and associate filtering
  - [ ] Add parsing profile JSON validation in editor
  - [ ] Test bookmaker CRUD operations through data_editor

- [ ] Task 5: Implement bulk associate selection and deactivation (AC: 4)
  - [ ] Add selection column to associates data_editor
  - [ ] Implement bulk deactivation functionality
  - [ ] Add confirmation dialog for bulk operations
  - [ ] Test bulk selection and deactivation workflow
  - [ ] Add proper error handling and rollback capabilities

- [ ] Task 6: Add comprehensive validation and error handling (AC: 7)
  - [ ] Implement share percentage validation (0-100% with decimal precision)
  - [ ] Add currency code validation against supported currencies
  - [ ] Implement alias uniqueness checking in real-time
  - [ ] Add JSON schema validation for parsing profiles
  - [ ] Test all validation scenarios and error messages

## Dev Notes

### Previous Story Insights
From Story 8.4 (Performance - Fragments & Partial Reruns):
- Feature flags utility is available and working [Source: docs/stories/8.4.performance-fragments-partial-reruns.md#Dev Notes]
- Fragment implementation provides selective reruns for better performance
- Performance timer and debug toggle functionality available
- Global theme and styling foundation established [Source: docs/stories/8.1.foundation-theme-global-styling.md#Dev Agent Record]
- Navigation modernization complete with consistent page structure [Source: docs/stories/8.2.navigation-modernization.md#Dev Agent Record]

From Story 8.3 (Interaction Patterns - Dialogs and Popovers):
- Dialog helpers available for confirmations [Source: docs/stories/8.3.interaction-patterns-dialogs-popovers.md#Dev Notes]
- Popover implementation for compact action menus
- Feature flag integration established for Streamlit version compatibility

From Story 8.2 (Navigation Modernization):
- All pages follow consistent structure and feature flag integration
- Feature flag detection patterns established
- Page shell and navigation patterns modernized

From Story 8.1 (Foundation Theme):
- Global CSS loading integrated across all pages [Source: docs/stories/8.1.foundation-theme-global-styling.md#Dev Agent Record]
- All pages use `st.set_page_config(layout="wide")` consistently

### Data Editor Architecture Requirements

**Streamlit Data Editor Configuration** [Source: docs/architecture/frontend-architecture.md#Tables & CRUD (Typed, Safe)]:
```python
import streamlit as st
import pandas as pd

df = pd.DataFrame([{
    "id":"a1",
    "name":"Alice",
    "default_ccy":"EUR",
    "share_pct":50.0,
    "active":True
}])

edited = st.data_editor(
    df, 
    use_container_width=True, 
    hide_index=True, 
    num_rows="fixed",
    column_config={
        "id": st.column_config.TextColumn("ID", disabled=True),
        "name": st.column_config.TextColumn("Name", required=True),
        "default_ccy": st.column_config.SelectboxColumn("CCY", options=["EUR","AUD","GBP","RON"]),
        "share_pct": st.column_config.NumberColumn("Share %", min_value=0, max_value=100, step=0.5, format="%.1f"),
        "active": st.column_config.CheckboxColumn("Active"),
    }
)
```

**Editor Helper Structure** [Source: docs/architecture/frontend-architecture.md#src/ui/helpers/]:
```
src/ui/helpers/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ nav.py                  # Navigation helpers (exists from 8.2)
â”œâ”€â”€ dialogs.py              # @st.dialog wrappers (exists from 8.3)
â”œâ”€â”€ fragments.py            # @st.fragment decorators (exists from 8.4)
â””â”€â”€ editor.py               # data_editor configs & selection helpers (NEW)
```

**Master-Detail Pattern Implementation** [Source: docs/architecture/frontend-architecture.md#Page 7: Admin â€“ Associates & Bookmakers (FRâ€‘11)]:
- Associates (master) above; Bookmakers (detail) filtered by selection
- `st.data_editor` with typed `column_config` and read-only IDs
- `num_rows="fixed"` for strict CRUD control
- Selection events for bulk operations (or checkbox column fallback)

### Current Admin Page Analysis

**Existing Structure** [Source: src/ui/pages/7_admin_associates.py]:
- Associates table with manual form-based CRUD operations
- Bookmakers nested within associate expanders
- Manual validation and error handling
- Session state management for modal forms
- Separate add/edit/delete workflows

**Key Functions to Refactor**:
- `load_associates()` - Load associates with bookmaker count
- `load_bookmakers_for_associate()` - Load bookmakers for selected associate
- `insert_associate()`, `update_associate()`, `delete_associate()` - CRUD operations
- `insert_bookmaker()`, `update_bookmaker()`, `delete_bookmaker()` - CRUD operations
- Form rendering functions (`render_add_associate_form()`, `render_edit_associate_modal()`, etc.)

### Data Model Requirements

**Associate Entity Schema** [Source: docs/architecture/data-architecture.md#Associates Table]:
```sql
CREATE TABLE associates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    display_alias TEXT UNIQUE NOT NULL,
    home_currency TEXT NOT NULL,
    is_admin INTEGER DEFAULT 0,
    multibook_chat_id TEXT,
    created_at_utc TEXT NOT NULL,
    updated_at_utc TEXT NOT NULL
);
```

**Bookmaker Entity Schema** [Source: docs/architecture/data-architecture.md#Bookmakers Table]:
```sql
CREATE TABLE bookmakers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    associate_id INTEGER NOT NULL,
    bookmaker_name TEXT NOT NULL,
    parsing_profile TEXT,
    is_active INTEGER DEFAULT 1,
    created_at_utc TEXT NOT NULL,
    updated_at_utc TEXT NOT NULL,
    FOREIGN KEY (associate_id) REFERENCES associates(id) ON DELETE CASCADE,
    UNIQUE(associate_id, bookmaker_name)
);
```

### Editor Configuration Specifications

**Associate Editor Configuration**:
- ID column: `st.column_config.TextColumn("ID", disabled=True, width="small")`
- Display Alias: `st.column_config.TextColumn("Display Alias", required=True, width="medium")`
- Home Currency: `st.column_config.SelectboxColumn("Currency", options=VALID_CURRENCIES, width="small")`
- Admin Status: `st.column_config.CheckboxColumn("Admin", width="small")`
- Chat ID: `st.column_config.TextColumn("Multibook Chat ID", width="medium")`
- Created/Updated: `st.column_config.DatetimeColumn("Created", disabled=True, width="medium")`

**Bookmaker Editor Configuration**:
- ID column: `st.column_config.TextColumn("ID", disabled=True, width="small")`
- Bookmaker Name: `st.column_config.TextColumn("Name", required=True, width="medium")`
- Parsing Profile: `st.column_config.TextColumn("Parsing Profile", width="large")`
- Active Status: `st.column_config.CheckboxColumn("Active", width="small")`
- Associate ID: Hidden/disabled for detail view, visible for master view

### Validation Requirements

**Currency Validation** [Source: src/ui/utils/validators.py]:
```python
VALID_CURRENCIES = ["EUR", "AUD", "GBP", "RON", "USD"]

def validate_currency(currency: str) -> Tuple[bool, str]:
    if not currency or len(currency.strip()) != 3:
        return False, "Currency must be 3-character ISO code"
    if currency.upper() not in VALID_CURRENCIES:
        return False, f"Currency must be one of: {', '.join(VALID_CURRENCIES)}"
    return True, ""
```

**Share Percentage Validation**:
- Must be between 0 and 100 inclusive
- Maximum 1 decimal place precision
- Must be numeric
- Optional field with default None

**Alias Validation** [Source: src/ui/utils/validators.py]:
```python
def validate_alias(alias: str, exclude_id: Optional[int] = None, db_connection=None) -> Tuple[bool, str]:
    if not alias or len(alias.strip()) < 2:
        return False, "Alias must be at least 2 characters"
    if len(alias.strip()) > 50:
        return False, "Alias cannot exceed 50 characters"
    # Check uniqueness in database
    # Return False if duplicate found (excluding current record for updates)
```

### Master-Detail Implementation Requirements

**Associate Selection Logic**:
```python
# Top editor shows associates with selection capability
associates_df = load_associates()
selected_associates = st.data_editor(
    associates_df,
    column_config=associate_config,
    num_rows="dynamic",  # Allow adding new associates
    key="associates_editor"
)

# Extract selected associate IDs
if "selection" in selected_associates:
    selected_ids = selected_associates["selection"]["rows"]
    selected_associate_ids = associates_df.iloc[selected_ids]["id"].tolist()
else:
    selected_associate_ids = []
```

**Bookmaker Filtering Logic**:
```python
# Bottom editor shows bookmakers filtered by selected associates
if selected_associate_ids:
    bookmakers_df = load_bookmakers_for_associates(selected_associate_ids)
    edited_bookmakers = st.data_editor(
        bookmakers_df,
        column_config=bookmaker_config,
        num_rows="dynamic",
        key="bookmakers_editor"
    )
else:
    st.info("Select associates above to edit their bookmakers")
```

### Bulk Operations Implementation

**Bulk Deactivation Workflow** [Source: docs/architecture/frontend-architecture.md#Bulk actions]:
```python
if selected_associate_ids:
    if st.button("ðŸ”´ Deactivate Selected", type="secondary"):
        # Use dialog for confirmation
        confirm_bulk_deactivate(selected_associate_ids)
        
def confirm_bulk_deactivate(associate_ids: List[int]):
    """Show confirmation dialog for bulk deactivation"""
    if hasattr(st, "dialog"):
        @st.dialog("Confirm Bulk Deactivation")
        def modal():
            st.warning(f"This will deactivate {len(associate_ids)} associate(s).")
            st.write("All their bookmakers will also be deactivated.")
            if st.button("Confirm Deactivation", type="primary"):
                # Execute bulk deactivation
                success = bulk_deactivate_associates(associate_ids)
                if success:
                    st.success(f"Deactivated {len(associate_ids)} associate(s)")
                    st.rerun()
                else:
                    st.error("Failed to deactivate some associates")
        modal()
    else:
        # Fallback confirmation
        st.warning(f"About to deactivate {len(associate_ids)} associate(s).")
        if st.button("Confirm", type="primary"):
            bulk_deactivate_associates(associate_ids)
```

### File Structure Requirements

**New Editor Helper Module** [Source: docs/architecture/source-tree.md#src/ui/]:
```
src/ui/helpers/editor.py              # NEW: data_editor configurations
```

**Updated Admin Page** [Source: docs/architecture/source-tree.md#src/ui/pages/]:
```
src/ui/pages/7_admin_associates.py    # MODIFIED: use data_editor instead of forms
```

**Import Dependencies** [Source: docs/architecture/source-tree.md#Import Conventions]:
```python
# Standard library
from typing import List, Dict, Optional, Tuple

# Third-party libraries
import streamlit as st
import pandas as pd

# Local imports
from src.core.database import get_db_connection
from src.ui.utils.validators import validate_currency, validate_alias
from src.ui.helpers.dialogs import render_confirmation_dialog
```

### Performance and UX Considerations

**Fragment Integration** [Source: docs/stories/8.4.performance-fragments-partial-reruns.md#Dev Notes]:
- Wrap associates and bookmakers editors in separate fragments for independent reruns
- Use performance timers to monitor editor rendering times
- Add debug toggle for editor performance metrics

**Form vs Editor Migration**:
- Gradual migration: keep forms as fallback for older Streamlit versions
- Use feature flags to detect `st.data_editor` availability
- Provide clear upgrade messaging for users on older versions

**Validation Feedback**:
- Real-time validation feedback in data_editor cells
- Clear error messages for validation failures
- Prevent saving invalid data with proper error handling

### Feature Flag Integration

**Editor Feature Detection** [Source: docs/architecture/frontend-architecture.md#Streamlit Version Targets & Feature Flags]:
```python
# src/ui/utils/feature_flags.py
FEATURES = {
    "data_editor": hasattr(st, "data_editor"),
    "column_config": hasattr(st.column_config, "TextColumn"),
    "selection_events": hasattr(st.data_editor, "__code__").find("selection") > 0,
}

def has_feature(feature: str) -> bool:
    return bool(FEATURES.get(feature, False))
```

**Fallback Implementation**:
- Use traditional forms when `st.data_editor` not available
- Maintain backward compatibility with Streamlit 1.30+
- Provide clear messaging about upgrade benefits

### Testing Requirements

**Testing Standards** [Source: docs/architecture/testing-strategy.md#L34-L41]:
- Use pytest 7.0+ as testing framework
- Test file naming: `test_` prefix
- Test function naming: descriptive names
- Follow AAA pattern (Arrange, Act, Assert)

**Test Structure** [Source: docs/architecture/testing-strategy.md#L54-L77]:
```
tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ test_editor_helpers.py           # Unit tests for editor configurations
â”‚   â”œâ”€â”€ test_data_editor_validators.py   # Tests for validation logic
â”‚   â””â”€â”€ test_master_detail_logic.py     # Tests for master-detail filtering
â””â”€â”€ integration/
    â””â”€â”€ test_admin_editor_workflows.py   # Integration tests for editor workflows
```

**Editor Testing Approach** [Source: docs/architecture/testing-strategy.md#L543-L557]:
For data editor implementation, focus on:
1. **Unit tests** for editor helper functions and validation logic
2. **Integration tests** for end-to-end editor workflows
3. **Manual testing** for editor UX and data integrity

**Example Unit Tests**:
```python
# tests/unit/test_editor_helpers.py
def test_associate_column_config():
    """Test associate editor column configuration"""
    from src.ui.helpers.editor import get_associate_editor_config
    
    config = get_associate_editor_config()
    
    # Verify required columns exist
    assert "id" in config
    assert "display_alias" in config
    assert "home_currency" in config
    
    # Verify ID column is disabled
    assert config["id"].disabled is True
    assert config["display_alias"].disabled is False
    assert config["display_alias"].required is True

def test_bookmaker_validation():
    """Test bookmaker editor validation logic"""
    from src.ui.helpers.editor import validate_bookmaker_data
    
    # Test valid data
    valid_data = {"name": "Bet365", "active": True}
    is_valid, error = validate_bookmaker_data(valid_data)
    assert is_valid is True
    assert error == ""
    
    # Test invalid data
    invalid_data = {"name": "", "active": True}
    is_valid, error = validate_bookmaker_data(invalid_data)
    assert is_valid is False
    assert "name" in error.lower()

def test_master_detail_filtering():
    """Test master-detail filtering logic"""
    from src.ui.helpers.editor import filter_bookmakers_by_associates
    
    # Mock data
    bookmakers = [
        {"id": 1, "associate_id": 1, "name": "BM1"},
        {"id": 2, "associate_id": 2, "name": "BM2"},
        {"id": 3, "associate_id": 1, "name": "BM3"},
    ]
    
    # Test filtering
    filtered = filter_bookmakers_by_associates(bookmakers, [1])
    assert len(filtered) == 2
    assert all(b["associate_id"] == 1 for b in filtered)
```

**Manual Testing Checklist**:
- [ ] Associates data_editor renders correctly with all columns configured
- [ ] Bookmaker filtering works based on associate selection
- [ ] Validation prevents invalid data entry (empty names, invalid currencies)
- [ ] Bulk selection and deactivation functions correctly
- [ ] Master-detail interaction maintains data consistency
- [ ] Fallback forms work on older Streamlit versions
- [ ] Performance remains acceptable with large datasets
- [ ] Error handling gracefully manages edge cases
- [ ] UI remains responsive during editor operations
- [ ] Data persistence works correctly after editor changes
- [ ] Real-time validation provides immediate feedback
- [ ] Column configurations enforce proper data types

**Coverage Target** [Source: docs/architecture/testing-strategy.md#L482-L492]:
- Unit tests for editor helpers and validation: 90%+
- Integration tests for editor workflows: 80%+
- Manual testing coverage: All editor types and interactions validated

### Technical Constraints

**Streamlit Version Requirements** [Source: docs/architecture/frontend-architecture.md#Streamlit Version Targets]:
- Recommended: Streamlit â‰¥ 1.46 for full data_editor support
- Baseline: Streamlit â‰¥ 1.30 with form fallbacks
- Feature detection must be robust for version compatibility

**Data Integrity Rules** [Source: docs/architecture/data-architecture.md#Data Validation]:
- Associate display_alias must be unique within system
- Bookmaker names must be unique within associate
- Foreign key relationships must be maintained
- All required fields must have valid data

**Performance Considerations** [Source: docs/architecture/frontend-architecture.md#Performance & Reliability]:
- Data_editor rendering should not impact page loading performance
- Master-detail filtering should be efficient with database queries
- Validation should be lightweight and responsive
- Bulk operations should handle large selections efficiently

**Security Considerations** [Source: docs/architecture/security-architecture.md]:
- Input validation must prevent SQL injection
- Admin operations should require proper authorization
- Sensitive operations (bulk deactivation) should require confirmation
- Audit logging should track all data modifications

### Styling and Theming

**Editor Styling** [Source: docs/architecture/frontend-architecture.md#Modern UI & Streamlit Features Addendum]:
- Use global CSS variables defined in `src/ui/ui_styles.css`
- Apply consistent styling to editor containers
- Add visual indicators for validation errors
- Ensure editor content fits within viewport on mobile devices
- Add loading indicators for slow validation operations

**Validation Feedback Styling**:
- Use consistent error messaging format from existing forms
- Apply appropriate color coding for validation states
- Ensure error messages are readable and actionable
- Add visual feedback for successful operations

## Testing

### Testing Standards

**Test Framework** [Source: docs/architecture/testing-strategy.md#L34-L41]:
- Use pytest 7.0+ as testing framework
- Test file naming: `test_` prefix
- Test function naming: descriptive names
- Follow AAA pattern (Arrange, Act, Assert)

**Test Structure** [Source: docs/architecture/testing-strategy.md#L54-L77]:
```
tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ test_editor_helpers.py           # Unit tests for editor configurations
â”‚   â”œâ”€â”€ test_data_editor_validators.py   # Tests for validation logic
â”‚   â””â”€â”€ test_master_detail_logic.py     # Tests for master-detail filtering
â””â”€â”€ integration/
    â””â”€â”€ test_admin_editor_workflows.py   # Integration tests for editor workflows
```

**Data Editor Implementation Testing Approach** [Source: docs/architecture/testing-strategy.md#L543-L557]:
For data editor implementation, focus on:
1. **Unit tests** for editor helper functions, validation logic, and master-detail filtering
2. **Integration tests** for end-to-end editor workflows
3. **Manual testing** for editor UX, data integrity, and performance

**Example Unit Tests**:
```python
# tests/unit/test_editor_helpers.py
def test_associate_editor_column_configuration():
    """Test associate editor column configuration setup"""
    from src.ui.helpers.editor import get_associate_editor_config
    
    config = get_associate_editor_config()
    
    # Verify all expected columns are present
    required_columns = ["id", "display_alias", "home_currency", "is_admin", "multibook_chat_id"]
    for col in required_columns:
        assert col in config, f"Missing column configuration: {col}"
    
    # Verify ID column is properly configured
    assert config["id"].disabled is True
    assert config["id"].width == "small"
    
    # Verify required field configuration
    assert config["display_alias"].required is True
    assert config["home_currency"].required is True
    
    # Verify currency options
    assert "EUR" in config["home_currency"].options
    assert "AUD" in config["home_currency"].options

def test_bookmaker_editor_validation():
    """Test bookmaker editor validation logic"""
    from src.ui.helpers.editor import validate_bookmaker_row
    
    # Test valid bookmaker data
    valid_row = {
        "bookmaker_name": "Bet365",
        "parsing_profile": '{"ocr_hints": ["bet365"]}',
        "is_active": True
    }
    is_valid, errors = validate_bookmaker_row(valid_row)
    assert is_valid is True
    assert len(errors) == 0
    
    # Test invalid bookmaker name
    invalid_row = {
        "bookmaker_name": "",
        "parsing_profile": None,
        "is_active": True
    }
    is_valid, errors = validate_bookmaker_row(invalid_row)
    assert is_valid is False
    assert "bookmaker_name" in errors

def test_master_detail_filtering_logic():
    """Test master-detail filtering between associates and bookmakers"""
    from src.ui.helpers.editor import filter_bookmakers_by_associates
    
    # Mock bookmakers data
    bookmakers = pd.DataFrame([
        {"id": 1, "associate_id": 1, "bookmaker_name": "BM1", "is_active": True},
        {"id": 2, "associate_id": 2, "bookmaker_name": "BM2", "is_active": True},
        {"id": 3, "associate_id": 1, "bookmaker_name": "BM3", "is_active": False},
    ])
    
    # Test filtering by single associate
    filtered = filter_bookmakers_by_associates(bookmakers, [1])
    assert len(filtered) == 2
    assert all(filtered["associate_id"] == 1)
    
    # Test filtering by multiple associates
    filtered = filter_bookmakers_by_associates(bookmakers, [1, 2])
    assert len(filtered) == 3
    
    # Test filtering with no associates
    filtered = filter_bookmakers_by_associates(bookmakers, [])
    assert len(filtered) == 0

def test_bulk_deactivation_validation():
    """Test bulk deactivation safety checks"""
    from src.ui.helpers.editor import validate_bulk_deactivate
    
    # Mock associates with different states
    associates = pd.DataFrame([
        {"id": 1, "display_alias": "Alice", "has_bets": False},
        {"id": 2, "display_alias": "Bob", "has_bets": True},
        {"id": 3, "display_alias": "Charlie", "has_bets": False},
    ])
    
    # Test deactivation validation
    can_deactivate, warnings = validate_bulk_deactivate(associates, [1, 3])
    assert can_deactivate is True
    assert len(warnings) == 0
    
    # Test deactivation with associate that has bets
    can_deactivate, warnings = validate_bulk_deactivate(associates, [2])
    assert can_deactivate is False
    assert "bets" in warnings[0].lower()
```

**Example Integration Tests**:
```python
# tests/integration/test_admin_editor_workflows.py
def test_associate_crud_workflow():
    """Test complete associate CRUD workflow through data_editor"""
    from src.ui.pages.7_admin_associates import main
    import streamlit as st
    
    # Mock initial data
    initial_associates = [
        {"id": 1, "display_alias": "Alice", "home_currency": "EUR", "is_admin": False}
    ]
    
    with patch('src.ui.pages.7_admin_associates.load_associates') as mock_load:
        mock_load.return_value = pd.DataFrame(initial_associates)
        
        # Simulate adding new associate through editor
        new_associate = {
            "id": None,  # New record
            "display_alias": "Bob",
            "home_currency": "AUD",
            "is_admin": False,
            "multibook_chat_id": None
        }
        
        # Test editor returns new data
        edited_data = pd.DataFrame(initial_associates + [new_associate])
        
        # Verify new associate is added to database
        with patch('src.ui.pages.7_admin_associates.insert_associate') as mock_insert:
            mock_insert.return_value = (True, "Success")
            
            # Simulate save operation
            result = save_associate_changes(edited_data)
            assert result is True
            mock_insert.assert_called_once()

def test_master_detail_interaction():
    """Test master-detail interaction between associates and bookmakers"""
    from src.ui.helpers.editor import get_filtered_bookmakers_for_selection
    
    # Mock data
    associates = pd.DataFrame([
        {"id": 1, "display_alias": "Alice"},
        {"id": 2, "display_alias": "Bob"},
    ])
    
    bookmakers = pd.DataFrame([
        {"id": 1, "associate_id": 1, "bookmaker_name": "BM1"},
        {"id": 2, "associate_id": 1, "bookmaker_name": "BM2"},
        {"id": 3, "associate_id": 2, "bookmaker_name": "BM3"},
    ])
    
    # Test selection filtering
    selection = {"rows": [0]}  # Select Alice (id=1)
    filtered_bookmakers = get_filtered_bookmakers_for_selection(
        bookmakers, associates, selection
    )
    
    assert len(filtered_bookmakers) == 2
    assert all(filtered_bookmakers["associate_id"] == 1)

def test_bulk_operations_workflow():
    """Test bulk deactivation workflow end-to-end"""
    from src.ui.helpers.editor import process_bulk_deactivation
    
    # Mock selected associates
    selected_ids = [1, 2, 3]
    
    # Mock safety checks
    with patch('src.ui.helpers.editor.can_deactivate_associates') as mock_can:
        mock_can.return_value = (True, [])
        
        # Mock deactivation
        with patch('src.ui.helpers.editor.bulk_deactivate_associates') as mock_deactivate:
            mock_deactivate.return_value = (True, "Success")
            
            success, message = process_bulk_deactivation(selected_ids)
            assert success is True
            mock_deactivate.assert_called_once_with(selected_ids)
```

**Manual Testing Checklist**:
- [ ] Associates data_editor renders with proper column configurations
- [ ] Bookmaker filtering updates correctly based on associate selection
- [ ] Real-time validation prevents invalid data entry
- [ ] Bulk selection works for multiple associates
- [ ] Bulk deactivation requires proper confirmation
- [ ] Data changes persist correctly after editor operations
- [ ] Master-detail relationship maintains referential integrity
- [ ] Performance remains acceptable with large datasets (>1000 records)
- [ ] Error handling provides clear feedback for invalid operations
- [ ] Feature flags properly enable/disable editor functionality
- [ ] Fallback forms work on older Streamlit versions
- [ ] Mobile compatibility: editors work correctly on mobile devices
- [ ] Accessibility: editor controls are properly labeled and keyboard navigable
- [ ] Undo/redo functionality works where supported
- [ ] Data export/import functions correctly from editors

**Coverage Target** [Source: docs/architecture/testing-strategy.md#L482-L492]:
- Unit tests for editor helpers and validation: 90%+
- Integration tests for editor workflows: 80%+
- Manual testing coverage: All editor types and interactions validated

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
- [To be populated by development agent]

### Debug Log References
- [To be populated by development agent]

### Completion Notes List
- [To be populated by development agent]

### File List
- [To be populated by development agent]

## QA Results

### Review Date
[To be populated by QA agent]

### Reviewed By
[To be populated by QA agent]

### Code Quality Assessment
[To be populated by QA agent]

### Improvements Checklist
- [ ] Editor helper module with typed column configurations
- [ ] Master-detail associates page structure implemented
- [ ] Associate CRUD replaced with data_editor
- [ ] Bookmaker CRUD replaced with data_editor
- [ ] Bulk associate selection and deactivation implemented
- [ ] Comprehensive validation and error handling added
- [ ] Feature flag integration for backward compatibility
- [ ] Performance optimization with fragment integration
- [ ] Comprehensive test coverage for editor functionality
- [ ] Manual testing validation completed

### Gate Status
[To be populated by QA agent]

### Recommended Status
[To be populated by QA agent]
