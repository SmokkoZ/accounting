# Story 3.2: Worst-Case EUR Profit Calculation

## Status
Done

## Story
**As an operator**, I want to see worst-case profit and ROI for each surebet to identify risky bets before settlement.

## Acceptance Criteria
- [ ] Calculation function: `calculate_surebet_risk(surebet_id) -> dict`
  - Query all bets linked to surebet via `surebet_bets`
  - For each bet, convert to EUR using cached FX:
    - `stake_eur = bet.stake * get_fx_rate(bet.currency, today)`
    - `payout_eur = bet.payout * get_fx_rate(bet.currency, today)`
  - Calculate Side A wins scenario:
    - `profit_if_A_wins = (sum of Side A payouts in EUR) - (sum of ALL stakes in EUR)`
    - Calculate Side B wins scenario:
    - `profit_if_B_wins = (sum of Side B payouts in EUR) - (sum of ALL stakes in EUR)`
    - `worst_case_profit_eur = min(profit_if_A_wins, profit_if_B_wins)`
    - `total_staked_eur = sum(all stakes in EUR)`
    - `roi = worst_case_profit_eur / total_staked_eur * 100`  # as percentage
- [ ] ROI classification thresholds (configurable):
  - **Safe (âœ…)**: `worst_case_profit_eur >= 0` AND `roi >= 1.0%`
  - **Low ROI (ðŸŸ¡)**: `worst_case_profit_eur >= 0` BUT `roi < 1.0%`
  - **Unsafe (âŒ)**: `worst_case_profit_eur < 0` (guaranteed loss)
- [ ] Storage options:
  - **Option A**: Store calculated values in `surebets` table:
    - Add columns: `worst_case_profit_eur`, `total_staked_eur`, `roi`, `risk_classification`
    - Recalculate on bet addition/removal
  - **Option B**: Calculate on-demand in UI (no storage)
  - **Recommendation**: Option A for performance (cached calculations)
- [ ] Trigger recalculation:
  - When new bet added to surebet
  - When bet removed (e.g., operator corrects match)
  - When FX rates updated (daily)

## Tasks / Subtasks
- [x] Task 1: Create SurebetRiskCalculator service class (AC: 1)
  - [x] Create `src/services/surebet_calculator.py` with SurebetRiskCalculator class
  - [x] Implement `calculate_surebet_risk(surebet_id: int) -> dict` method
  - [x] Add database connection initialization
  - [x] Add FX rate integration using existing FX manager
- [x] Task 2: Implement EUR conversion logic (AC: 1)
  - [x] Add method to convert stake and payout to EUR using cached FX rates
  - [x] Handle missing FX rates with fallback to last known rate with warning
  - [x] Ensure all currency calculations use Decimal type
- [x] Task 3: Implement profit/ROI calculation (AC: 1)
  - [x] Add logic to calculate Side A wins scenario profit
  - [x] Add logic to calculate Side B wins scenario profit
  - [x] Calculate worst-case profit (minimum of both scenarios)
  - [x] Calculate total staked in EUR
  - [x] Calculate ROI as percentage with proper Decimal division
- [x] Task 4: Implement risk classification (AC: 1)
  - [x] Add configurable thresholds for Safe/Low ROI/Unsafe classification
  - [x] Implement classification logic based on profit and ROI thresholds
  - [x] Return classification string and color code for UI display
- [x] Task 5: Add database schema updates (AC: 1)
  - [x] Update `surebets` table schema to include risk calculation columns
  - [x] Add migration script to update existing surebets with calculated values
  - [x] Update schema validation to include new columns
- [x] Task 6: Integrate with SurebetMatcher (AC: 1)
  - [x] Modify SurebetMatcher to trigger risk calculation after bet matching
  - [x] Add method to recalculate risk when surebet composition changes
  - [x] Ensure risk calculation runs on new bet addition to existing surebet
- [x] Task 7: Add unit tests (Testing Requirements)
  - [x] Test EUR conversion with various currencies
  - [x] Test profit/ROI calculation with different scenarios
  - [x] Test risk classification thresholds
  - [x] Test missing FX rate handling
  - [x] Test integration with SurebetMatcher service

## Dev Notes

### Previous Story Insights
From story 3.1, we have:
- SurebetMatcher service in `src/services/surebet_matcher.py` with matching functionality
- Database schema with `surebets` and `surebet_bets` tables for storing matched bets
- FX Manager service in `src/services/fx_manager.py` for currency conversion
- Formatters utility in `src/ui/utils/formatters.py` for EUR display formatting
- All currency values must use Decimal type [Source: docs/architecture/coding-standards.md#155-170]

### Data Models
Risk calculator will interact with these tables [Source: docs/architecture/data-architecture.md#246-296]:

**surebets table** - Source of surebets to analyze:
- `id` - Primary key
- `canonical_event_id` - Foreign key to canonical_events table
- `market_code` - Market type from canonical_markets
- `period_scope` - Period of bet
- `line_value` - Line value for markets
- `status` - Current status (open, settled)
- **New columns to add**:
  - `worst_case_profit_eur` - Calculated worst-case profit in EUR
  - `total_staked_eur` - Total amount staked in EUR
  - `roi` - Return on investment percentage
  - `risk_classification` - Safe/Low ROI/Unsafe classification

**surebet_bets table** - Junction table linking bets to surebets:
- `surebet_id` - Links to surebets table
- `bet_id` - Links to bets table
- `side` - A or B assignment (immutable)

**bets table** - Individual bet details:
- `stake` - Bet amount in native currency
- `payout` - Potential payout in native currency
- `currency` - Native currency of bet (AUD, GBP, EUR, etc.)

**fx_rates_daily table** - Currency conversion rates:
- `currency` - Currency code (AUD, GBP, etc.)
- `eur_per_unit` - EUR conversion rate for the date

### Component Specifications
SurebetRiskCalculator service implementation [Source: docs/architecture/backend-architecture.md#207-309]:

```python
# src/services/surebet_calculator.py
class SurebetRiskCalculator:
    def __init__(self, db=None):
        self.db = db or get_db_connection()
        self.fx_manager = FXManager(db)
    
    def calculate_surebet_risk(self, surebet_id: int) -> dict:
        """
        Calculate worst-case profit and ROI for a surebet:
        1. Query all bets linked to surebet via surebet_bets
        2. Convert all stakes/payouts to EUR using cached FX rates
        3. Calculate profit scenarios for Side A wins vs Side B wins
        4. Determine worst-case profit (minimum of both scenarios)
        5. Calculate ROI percentage
        6. Classify risk level (Safe/Low ROI/Unsafe)
        7. Return comprehensive risk analysis dict
        """
        # Implementation details...
    
    def _convert_to_eur(self, amount: Decimal, currency: str, date: str) -> Decimal:
        """Convert amount to EUR using FX manager with fallback handling"""
        # Implementation details...
    
    def _calculate_profit_scenarios(self, side_a_bets: list, side_b_bets: list) -> tuple:
        """Calculate profit for both Side A wins and Side B wins scenarios"""
        # Implementation details...
    
    def _classify_risk(self, worst_profit: Decimal, roi: Decimal) -> dict:
        """Classify surebet risk based on profit and ROI thresholds"""
        # Implementation details...
```

### File Locations
Based on architecture documentation:
- `src/services/surebet_calculator.py` - Create new risk calculator service [Source: docs/architecture/source-tree.md#280]
- `src/services/surebet_matcher.py` - Update to trigger risk calculation [Source: docs/architecture/source-tree.md#279]
- `src/core/schema.py` - Update surebets table schema [Source: docs/architecture/source-tree.md#237]
- `src/core/schema_validation.py` - Update validation for new schema columns [Source: docs/architecture/source-tree.md#237]
- `tests/unit/test_surebet_calculator.py` - Unit tests for risk calculator [Source: docs/architecture/source-tree.md#452]

### Testing Requirements
From testing strategy:
- Create unit tests for surebet risk calculator service [Source: docs/architecture/testing-strategy.md#175-219]
- Test EUR conversion with various currencies and edge cases
- Test profit/ROI calculation accuracy with different bet combinations
- Test risk classification thresholds and boundary conditions
- Test missing FX rate fallback behavior
- Test integration with SurebetMatcher service
- Target coverage: 95%+ for risk calculation logic [Source: docs/architecture/testing-strategy.md#468]

### Technical Constraints
- Use Python 3.12+ with type hints [Source: docs/architecture/tech-stack.md#19]
- All currency values must use Decimal type, never float [Source: docs/architecture/coding-standards.md#155-170]
- All timestamps in UTC ISO8601 with "Z" suffix [Source: docs/architecture/coding-standards.md#198-226]
- Use parameterized queries for all SQL operations [Source: docs/architecture/coding-standards.md#310-320]
- Follow existing code patterns from story 3.1 implementation
- Use existing FX Manager service for currency conversion [Source: docs/architecture/source-tree.md#286]

### Project Structure Notes
The risk calculation functionality should follow documented source tree:
- Create new risk calculator service in `src/services/surebet_calculator.py`
- Update surebet matcher service in `src/services/surebet_matcher.py`
- Update database schema in `src/core/schema.py`
- Update schema validation in `src/core/schema_validation.py`
- Create unit tests in `tests/unit/test_surebet_calculator.py`
- Integration tests in `tests/integration/test_risk_calculation_flow.py`

## Testing

### Testing Standards
- Use pytest 7.0+ as testing framework [Source: docs/architecture/testing-strategy.md#36]
- Test file naming: `test_` prefix [Source: docs/architecture/coding-standards.md#452-464]
- Test function naming: descriptive names [Source: docs/architecture/coding-standards.md#467-483]
- Follow AAA pattern (Arrange, Act, Assert) [Source: docs/architecture/coding-standards.md#487-501]
- Mock database connections and FX rates in unit tests
- Test risk calculation with various scenarios (Safe, Low ROI, Unsafe)
- Test currency conversion edge cases (missing rates, zero rates)
- Target coverage: 95%+ for risk calculation logic [Source: docs/architecture/testing-strategy.md#468]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
N/A - No blocking issues encountered

### Completion Notes List
- Implemented SurebetRiskCalculator service class with comprehensive risk analysis functionality
- Added FX rate querying directly in calculator to support in-memory test databases
- Updated database schema to include worst_case_profit_eur, total_staked_eur, roi, and risk_classification columns
- Created migration script for existing databases (scripts/migrate_add_risk_columns.py)
- Integrated risk calculation into SurebetMatcher to automatically calculate risk after matching
- All 9 unit tests pass with 100% coverage of risk calculation scenarios
- Full regression test suite passes (187 tests total)
- Code formatted with Black to meet coding standards

### File List
**Created:**
- src/services/surebet_calculator.py - Risk calculator service (new)
- tests/unit/test_surebet_calculator.py - Comprehensive unit tests (new)
- scripts/migrate_add_risk_columns.py - Database migration script (new)

**Modified:**
- src/core/schema.py - Updated surebets table schema with risk columns
- src/core/schema_validation.py - Updated validation for new columns
- src/services/surebet_matcher.py - Integrated risk calculation after matching

## QA Results

### Recommended Status