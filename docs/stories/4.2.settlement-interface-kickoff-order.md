# Story 4.2: Settlement Interface (Kickoff Order)

## Status
Ready for Review

## Story

**As the operator**, I want to settle surebets in chronological kickoff order with WON/LOST/VOID grading so I process events as they complete.

## Acceptance Criteria

- [ ] "Settle" tab on Surebets page
  - Query: `SELECT * FROM surebets WHERE status='open' ORDER BY kickoff_time_utc ASC`
  - Display as list: oldest first
- [ ] Each surebet shows:
  - Event name, market, line
  - Kickoff time (past events highlighted: "Completed X hours ago")
  - Side A bets:
    - Associate alias, bookmaker name
    - Stake @ odds (e.g., "€100 @ 1.95")
    - Screenshot link (click to open)
  - Side B bets (same format)
- [ ] Select surebet → opens settlement panel:
  - **Base outcome selection** (radio buttons):
    - ⚪ "Side A WON / Side B LOST"
    - ⚪ "Side B WON / Side A LOST"
  - **Individual bet overrides** (checkboxes):
    - For each bet: dropdown "WON | LOST | VOID"
    - Default: matches base outcome
    - Example: If "Side A WON" selected, all Side A bets default to WON, Side B to LOST
    - Operator can override: "Bet #5 (Side B) actually VOID (late cancel)"
- [ ] Validation:
  - At least one outcome selected (prevent empty submission)
  - Warn if all bets VOID: "All bets VOID - proceed?"
- [ ] Counters at bottom:
  - "Settled today: C"
  - "Still open (unsettled): D"

## Dev Notes

### Previous Story Insights

From Story 4.1 (Manual Coverage Proof Distribution):
- Surebets dashboard structure and display patterns established [Source: docs/stories/4.1.manual-coverage-proof-distribution.md#L170]
- Database queries for surebet data and bet relationships understood [Source: docs/stories/4.1.manual-coverage-proof-distribution.md#L142-L166]
- Screenshot link display and interaction patterns [Source: docs/stories/4.1.manual-coverage-proof-distribution.md#L135-L140]
- Streamlit UI patterns for surebet management workflows [Source: docs/stories/4.1.manual-coverage-proof-distribution.md#L173-L177]

### Data Models

**surebets table** [Source: docs/architecture/data-architecture.md#L248-L270]:
```sql
CREATE TABLE surebets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    canonical_event_id INTEGER NOT NULL REFERENCES canonical_events(id),
    market_code TEXT NOT NULL,
    period_scope TEXT NOT NULL,
    line_value TEXT,
    status TEXT NOT NULL CHECK (status IN ('open', 'settled')),
    created_at_utc TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ', 'now')),
    settled_at_utc TEXT,
    coverage_proof_sent_at_utc TEXT
);
```

**Key Fields for Settlement Interface:**
- `id`: Unique surebet identifier
- `canonical_event_id`: Links to event for display name
- `market_code`: Market type for display
- `line_value`: Line/handicap value
- `status`: Must be 'open' to appear in settlement list
- `coverage_proof_sent_at_utc`: From Story 4.1, tracks if coverage proof sent

**surebet_bets table** [Source: docs/architecture/data-architecture.md#L275-L288]:
```sql
CREATE TABLE surebet_bets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    surebet_id INTEGER NOT NULL REFERENCES surebets(id),
    bet_id INTEGER NOT NULL REFERENCES bets(id),
    side TEXT NOT NULL CHECK (side IN ('A', 'B')),
    UNIQUE (surebet_id, bet_id)
);
```

**bets table** [Source: docs/architecture/data-architecture.md#L194-L226]:
```sql
CREATE TABLE bets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    associate_id INTEGER NOT NULL REFERENCES associates(id),
    bookmaker_id INTEGER REFERENCES bookmakers(id),
    status TEXT NOT NULL CHECK (status IN ('incoming', 'verified', 'matched', 'settled', 'rejected')),
    screenshot_path TEXT NOT NULL,
    canonical_event_id INTEGER REFERENCES canonical_events(id),
    market_code TEXT NOT NULL,
    period_scope TEXT NOT NULL CHECK (period_scope IN ('FULL_MATCH', 'FIRST_HALF', 'SECOND_HALF')),
    line_value TEXT,
    side TEXT NOT NULL CHECK (side IN ('OVER', 'UNDER', 'YES', 'NO', 'TEAM_A', 'TEAM_B')),
    stake TEXT NOT NULL,
    odds TEXT NOT NULL,
    payout TEXT NOT NULL,
    currency TEXT NOT NULL,
    ...
);
```

**Key Fields for Settlement Display:**
- `associate_id`: Links to associate for display alias
- `bookmaker_id`: Links to bookmaker for display name
- `screenshot_path`: Path to screenshot file for clickable link
- `stake`, `odds`, `payout`, `currency`: Bet details for display
- `side`: Used for default outcome assignment (A vs B)

**associates table** [Source: docs/architecture/data-architecture.md#L154-L174]:
```sql
CREATE TABLE associates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    display_alias TEXT NOT NULL,
    telegram_chat_id INTEGER,
    telegram_username TEXT,
    ...
);
```

**Key Fields for Display:**
- `display_alias`: Associate name to display in interface
- `telegram_chat_id`: Links to multibook chat for notifications

**canonical_events table** [Source: docs/architecture/data-architecture.md#L130-L152]:
```sql
CREATE TABLE canonical_events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    external_event_id TEXT,
    sport TEXT NOT NULL,
    event_name TEXT NOT NULL,
    kickoff_time_utc TEXT NOT NULL,
    home_team TEXT,
    away_team TEXT,
    ...
);
```

**Key Fields for Display:**
- `event_name`: Full event name for display
- `kickoff_time_utc`: Used for chronological sorting
- `home_team`, `away_team`: For human-readable event display

### UI Component Specifications

**Page Location**: Extend existing Surebets Dashboard page [Source: docs/architecture/frontend-architecture.md#L27]
- Add "Settle" tab to existing surebet management interface
- Display open surebets sorted by kickoff time

**Streamlit Widgets to Use** [Source: docs/architecture/tech-stack.md#L55-L70]:
- `st.tabs()` - For "Settle" tab navigation
- `st.radio()` - For base outcome selection
- `st.selectbox()` - For individual bet outcome overrides
- `st.dataframe()` - For displaying surebets list with sortable columns
- `st.columns()` - For side-by-side bet display
- `st.success()` / `st.error()` - For validation messages
- `st.expander()` - For detailed bet information

### File Locations

Based on architecture documentation:
- `src/ui/pages/2_verified_bets.py` - Extend existing Surebets Dashboard with settlement tab [Source: docs/architecture/frontend-architecture.md#L27]
- `src/services/` - Settlement interface service for bet outcome logic [Source: docs/architecture/backend-architecture.md#L75]
- `src/ui/components/` - Reusable settlement UI components [Source: docs/architecture/frontend-architecture.md#L45]

### Technical Constraints

**Python Standards** [Source: docs/architecture/coding-standards.md]:
- Use Python 3.12+ with type hints for all functions [Line 99-109]
- Use Decimal type for all currency values [Line 155-195]
- All timestamps in UTC ISO8601 with "Z" suffix [Line 198-226]
- Use parameterized queries for all SQL operations [Line 310-320]

**Streamlit Behavior** [Source: docs/architecture/frontend-architecture.md#L56-L70]:
- Streamlit reruns entire script on every interaction
- Minimize session state usage (only for modal open/closed state)
- Always query fresh data from database on page load (no caching)

**Database Operations**:
- Use `datetime('now') || 'Z'` for UTC timestamps in SQL INSERT/UPDATE [Source: docs/architecture/data-architecture.md#L58-L62]
- Store Decimal as TEXT in SQLite (convert to/from string) [Source: docs/architecture/data-architecture.md#L50-L55]
- Enforce foreign keys with PRAGMA foreign_keys = ON [Source: docs/architecture/data-architecture.md#L26-L39]

### Validation Rules

**Kickoff Time Sorting** [Source: docs/prd/epic-4-coverage-settlement.md#L126-L142]:
- Sort surebets by `kickoff_time_utc ASC` (oldest first)
- Highlight past kickoff times with visual indicators
- Show "Completed X hours ago" for overdue settlements

**Outcome Validation** [Source: docs/prd/epic-4-coverage-settlement.md#L142-L150]:
- Base outcome required (A_WON or B_WON radio selection)
- Individual overrides default to base outcome
- Warn if all bets marked VOID before submission
- Prevent submission with no outcome selected

**Data Integrity**:
- Only show surebets with `status='open'`
- Validate surebet has associated bets before settlement
- Ensure all bet IDs in overrides exist in the surebet

### UI Layout Reference

**Settlement Interface Layout** [Source: docs/prd/epic-4-coverage-settlement.md#L134-L157]:
```
┌─────────────────────────────────────────────────┐
│ Surebets Dashboard                                │
│ ┌─────────────────────────────────────────────┐ │
│ │ [Overview] [Settle] [History]                │ │
│ ├─────────────────────────────────────────────┤ │
│ │ Sort: Kickoff Time (Oldest First) ↓         │ │
│ ├─────────────────────────────────────────────┤ │
│ │ Event: Man Utd vs Arsenal (O/U 2.5)         │ │
│ │ Status: Open | Kickoff: 2 hours ago         │ │
│ │ ┌─────────────────────────────────────────┐ │ │
│ │ │ [Select for Settlement]                    │ │ │
│ │ └─────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────┐ │
│ │ Settlement Panel (when surebet selected)     │ │
│ │ Base Outcome: ○ Side A WON / Side B LOST    │ │
│ │                 ○ Side B WON / Side A LOST  │ │
│ │ ┌─────────────────────────────────────────┐ │ │
│ │ │ Side A Bets                               │ │ │
│ │ │ Bet #1: Alice @ Bet365, €100 @ 1.95      │ │ │
│ │ │   [WON ▼] (default from base outcome)    │ │ │
│ │ │ Bet #2: Admin @ Pinnacle, €50 @ 2.10     │ │ │
│ │ │   [WON ▼] (default from base outcome)    │ │ │
│ │ └─────────────────────────────────────────┘ │ │
│ │ ┌─────────────────────────────────────────┐ │ │
│ │ │ Side B Bets                               │ │ │
│ │ │ Bet #3: Bob @ Sportsbet, €75 @ 1.90      │ │ │
│ │ │   [LOST ▼] (default from base outcome)   │ │ │
│ │ │ Bet #4: Carol @ Unibet, €25 @ 2.05       │ │ │
│ │ │   [VOID ▼] (override by operator)        │ │ │
│ │ └─────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────┐ │
│ │ Settled today: 3 | Still open: 8            │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

### Integration Points

**Upstream Dependencies**:
- Story 4.1 (Coverage Proof): Settlement tab should show coverage proof status
- Epic 3 (Surebet Matching): Only surebets with `status='open'` appear
- Phase 0 FX system: FX rates needed for currency conversion display

**Downstream Consumers**:
- Story 4.3 (Equal-Split Preview): Selected outcomes passed to preview calculation
- Story 4.4 (Ledger Entry Generation): Final outcome data for permanent ledger writes

## Tasks / Subtasks

- [x] Task 1: Add Settlement Tab to Surebets Dashboard (AC: 1)
  - [x] Extend existing surebets page with tabbed interface
  - [x] Implement "Settle" tab navigation
  - [x] Add kickoff time sorting to surebets query
  - [x] Display chronological list with visual time indicators

- [x] Task 2: Implement Kickoff Time Display and Highlighting (AC: 1)
  - [x] Calculate time elapsed since kickoff for each surebet
  - [x] Show "Completed X hours ago" for past events
  - [x] Add visual highlighting for overdue settlements
  - [x] Implement responsive time formatting (hours/days)

- [x] Task 3: Create Settlement Panel UI Components (AC: 2)
  - [x] Build base outcome selection radio buttons (A_WON / B_WON)
  - [x] Implement individual bet override dropdowns (WON/LOST/VOID)
  - [x] Create side-by-side bet display (Side A vs Side B)
  - [x] Add bet details display (associate, bookmaker, stake, odds)
  - [x] Implement screenshot link display and click-to-open functionality

- [x] Task 4: Implement Outcome Selection Logic (AC: 2)
  - [x] Create function to set default outcomes based on base selection
  - [x] Allow individual bet overrides from defaults
  - [x] Validate outcome consistency (A vs B bets handled correctly)
  - [x] Add visual feedback for modified vs default outcomes

- [x] Task 5: Add Validation and Error Handling (AC: 3)
  - [x] Validate at least one base outcome selected before submission
  - [x] Add warning modal for all-bets-VOID scenarios
  - [x] Prevent submission with no outcome selected
  - [x] Provide clear error messages for validation failures

- [x] Task 6: Implement Settlement Counters (AC: 4)
  - [x] Query count of settled surebets today
  - [x] Query count of open (unsettled) surebets
  - [x] Update counters in real-time after settlements
  - [x] Add counters to bottom of settlement interface

- [x] Task 7: Create Data Query Functions for Settlement Display (AC: 1-4)
  - [x] Function to get open surebets sorted by kickoff time
  - [x] Function to get bet details for selected surebet
  - [x] Function to calculate elapsed time since kickoff
  - [x] Function to validate surebet settlement readiness

## Testing

### Testing Standards

**Test Framework** [Source: docs/architecture/testing-strategy.md#L34-L41]:
- Use pytest 7.0+ as testing framework
- Test file naming: `test_` prefix
- Test function naming: descriptive names (e.g., `test_settlement_interface_sorting_by_kickoff()`)

**Test Structure** [Source: docs/architecture/testing-strategy.md#L54-L77]:
```
tests/
├── unit/
│   ├── test_settlement_interface.py     # Unit tests for settlement UI logic
│   ├── test_kickoff_time_sorting.py     # Unit tests for chronological sorting
│   └── test_outcome_selection.py        # Unit tests for outcome validation
└── integration/
    └── test_settlement_interface_flow.py  # Integration tests for full workflow
```

**UI Testing Approach** [Source: docs/architecture/testing-strategy.md#L559-L564]:
For Streamlit pages, focus on:
1. **Unit tests** for settlement interface logic functions
2. **Unit tests** for kickoff time calculation and sorting
3. **Integration tests** for end-to-end settlement interface workflow
4. **Manual testing** for visual layout and interaction patterns

**Example Unit Tests**:
```python
# tests/unit/test_settlement_interface.py
def test_get_open_surebets_sorted_by_kickoff(test_db):
    """Test querying open surebets in chronological order"""
    surebet_id_1 = create_test_surebet_with_past_kickoff(test_db, hours_ago=2)
    surebet_id_2 = create_test_surebet_with_future_kickoff(test_db, hours_ahead=1)
    
    surebets = get_open_surebets_sorted_by_kickoff()
    assert len(surebets) == 2
    assert surebets[0]['id'] == surebet_id_1  # Past event first
    assert surebets[1]['id'] == surebet_id_2  # Future event second

def test_outcome_selection_default_behavior(test_db):
    """Test default outcome assignment based on base selection"""
    bets = create_test_surebet_bets(test_db)
    base_outcome = "A_WON"
    
    outcomes = get_default_outcomes(bets, base_outcome)
    assert outcomes[0] == "WON"  # Side A bets default to WON
    assert outcomes[1] == "LOST"  # Side B bets default to LOST

def test_validate_settlement_readiness(test_db):
    """Test validation of surebet before settlement"""
    surebet_id = create_test_surebet(test_db)
    open_surebet = get_surebet_with_status(surebet_id, "open")
    
    assert validate_settlement_readiness(open_surebet) is True
    
    settled_surebet = get_surebet_with_status(surebet_id, "settled")
    assert validate_settlement_readiness(settled_surebet) is False
```

## QA Results

### QA Assessment Summary
**Date**: 2025-11-03
**Reviewer**: Quinn (Test Architect)
**Status**: CONDITIONAL PASS

### Key Findings
- **Implementation Quality**: EXCELLENT - Code demonstrates exceptional maturity beyond initial story scope
- **Functional Coverage**: 100% - All acceptance criteria fully implemented with robust error handling
- **Risk Mitigation**: CRITICAL RISKS MITIGATED - Financial calculation logic well-protected
- **Test Architecture**: GOOD (85%) - Comprehensive test design created, implementation gap remains

### Risk Assessment
- **Critical Risks**: 2 identified, 2 mitigated (Financial calculation errors, Database performance)
- **High Risks**: 2 identified, 2 partially mitigated (Input validation, UI performance)
- **Overall Risk Score**: 68/100 - Manageable with conditions

### Test Coverage Analysis
- **Designed Tests**: 28 scenarios (18 unit, 8 integration, 2 E2E)
- **Current Coverage**: 65% (below 80% target)
- **Traceability**: 100% requirement coverage achieved
- **Quality**: Risk-based testing strategy comprehensive

### Non-Functional Requirements
- **Security**: CONCERNS - Input validation gaps, needs rate limiting
- **Performance**: PASS - Meets targets, pagination recommended for scale
- **Reliability**: PASS - Excellent error handling and recovery
- **Maintainability**: CONCERNS - Good code quality, test coverage needed

### Integration Assessment
- **Upstream Dependencies**: EXCELLENT - Perfect compatibility with Stories 4.1, Epic 3
- **Downstream Consumers**: READY - Interface contracts ready for Stories 4.3, 4.4

### Gate Decision
**CONDITIONAL PASS** - Production deployment approved with conditions:
1. Increase test coverage to 80%+ (add 15% coverage)
2. Implement pagination for large surebet lists
3. Enhance input validation for security
4. Add rate limiting for settlement operations

### Detailed Assessment Available
- **Risk Profile**: `docs/qa/assessments/4.2.settlement-interface-kickoff-order-risk-20251103.md`
- **Test Design**: `docs/qa/assessments/4.2.settlement-interface-kickoff-order-test-design-20251103.md`
- **Traceability**: `docs/qa/assessments/4.2.settlement-interface-kickoff-order-trace-20251103.md`
- **NFR Assessment**: `docs/qa/assessments/4.2.settlement-interface-kickoff-order-nfr-20251103.md`
- **Comprehensive Review**: `docs/qa/assessments/4.2.settlement-interface-comprehensive-qa-review-20251103.md`

### Immediate Action Items
1. **Add missing unit tests** (8 hours) - Critical for financial system validation
2. **Implement pagination** (4 hours) - Essential for production scale
3. **Enhance input validation** (6 hours) - Security and data integrity
4. **Security hardening** (4 hours) - Rate limiting and SQL injection prevention

### Quality Metrics Achieved
- ✅ 100% acceptance criteria coverage
- ✅ Complete business logic implementation
- ✅ Robust financial calculation safety
- ✅ Multi-currency support operational
- ⚠️ 65% test coverage (needs improvement)
- ✅ Sub-200ms query performance
- ✅ Comprehensive error recovery

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-03 | 1.0 | Initial story creation with comprehensive technical context | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
- Story created from Epic 4.2 requirements
- Technical context gathered from Story 4.1, architecture documents, and coding standards
- All acceptance criteria mapped to implementable tasks
- Integration points with Stories 4.1, 4.3, and 4.4 documented
- Implementation completed: Added tabbed interface with "Settle" tab to Surebets Dashboard
- All 7 tasks and subtasks completed successfully
- Unit tests: 14 tests passing (time calculations, outcome assignment, validation)
- Integration tests: 4 tests passing (full settlement workflow)

### Completion Notes List
- ✅ Added tabbed navigation to [2_verified_bets.py](src/ui/pages/2_verified_bets.py:830) with "Overview" and "Settle" tabs
- ✅ Implemented kickoff time calculation and highlighting in [2_verified_bets.py:40-74](src/ui/pages/2_verified_bets.py:40-74)
- ✅ Created settlement panel UI with base outcome selection (radio buttons) and individual bet overrides (dropdowns)
- ✅ Implemented default outcome assignment logic based on Side A/B selection
- ✅ Added validation for base outcome selection and all-VOID warnings
- ✅ Created settlement counters showing "Settled Today" and "Still Open"
- ✅ Implemented query functions for loading surebets sorted by kickoff time
- ✅ Settlement button shows validation and will integrate with Story 4.3 (Equal-Split Preview)
- ✅ All functions follow coding standards: type hints, Decimal for currency, UTC timestamps
- ✅ 18 total tests passing (14 unit + 4 integration)
- ✅ Code formatted with Black, follows PEP 8

### File List

**Modified files:**
- [src/ui/pages/2_verified_bets.py](src/ui/pages/2_verified_bets.py) - Added settlement tab with full interface

**Test files created:**
- [tests/unit/test_settlement_interface.py](tests/unit/test_settlement_interface.py) - 14 unit tests for settlement functions
- [tests/integration/test_settlement_interface_flow.py](tests/integration/test_settlement_interface_flow.py) - 4 integration tests for settlement workflow