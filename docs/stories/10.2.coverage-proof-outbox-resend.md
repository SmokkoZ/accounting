# Story 10.2: Coverage Proof Outbox & Resend

## Status
Ready for Review

## Story
**As a** operator,
**I want** a Coverage Proof outbox so I can see the status of each delivery, resend when needed, and observe rate-limit cooldowns without spamming Telegram,
**so that** I can manage message delivery effectively and follow the UX guidance in `docs/front-end-spec.md:1`.

## Acceptance Criteria
1. The outbox table lists every row from `multibook_message_log` with associate_alias, chat_id, message_id, status, last_attempt, and the seconds until the next allowed send, matching the logging surface at `src/services/coverage_proof_service.py:47`.
2. Each row exposes a Resend button that calls `CoverageProofService.send` with `resend=True`, honors the cooldown at `src/services/coverage_proof_service.py:520`, disables during the wait, and surfaces success/failure toasts.
3. The UI surfaces per-chat rate-limit health (queued/blocked) and logs scrape events for analytics.
4. Inline guidance explains safe Telegram caps and why the button may be disabled (per `docs/front-end-spec.md:1`).

## Tasks / Subtasks
- [x] Create outbox table component to display `multibook_message_log` data (AC: #1)
  - [x] Implement table columns: associate_alias, chat_id, message_id, status, last_attempt, cooldown_timer
  - [x] Connect to existing service that writes to `multibook_message_log`
- [x] Implement Resend functionality with rate-limit handling (AC: #2)
  - [x] Add Resend button to each row with disabled state during cooldown
  - [x] Integrate with `CoverageProofService.send` using `resend=True` parameter
  - [x] Implement spinner/toast feedback during resend operations
- [x] Add rate-limit health indicators and analytics logging (AC: #3)
  - [x] Display per-chat rate-limit status (queued/blocked)
  - [x] Implement analytics logging for scrape events
- [x] Add inline guidance and help text (AC: #4)
  - [x] Create help section explaining Telegram rate limits
  - [x] Add tooltips for disabled button states
  - [x] Pull rate-limit constants from existing configuration

## Dev Notes
- Rate-limit copy should pull from existing constants so warnings stay accurate if values change
- The service layer already handles message logging to `multibook_message_log`
- Telegram section will host new tables near existing thumbnail rows
- Reference `src/services/coverage_proof_service.py` for existing cooldown logic at line 520

### Testing
- Test file location: `tests/unit/test_coverage_proof_service.py`
- Test standards: Follow existing unit test patterns in the codebase
- Testing frameworks: pytest with mock for external service calls
- Add unit tests for `src/services/coverage_proof_service.py` asserting `resend=True` uses the cooldown state
- Confirm `tests/unit/test_media_thumbnails.py:1` continues to pass even though the Telegram section will host new tables near thumbnail rows

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-10 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
- GPT-5 (Codex)

### Debug Log References
- 2025-11-10: `pytest tests/unit/test_coverage_proof_service.py`

### Completion Notes List
- Added coverage-proof outbox query + analytics logging to `CoverageProofService`, including cooldown math and `send` wrapper expected by the story.
- Implemented Streamlit outbox table with rate-limit badges, inline guidance from the UX spec, and cooldown-aware resend controls wired into the existing send flow.
- Introduced focused unit coverage for the new cooldown behaviour and ensured the service obeys waits when `resend=True`.

### File List
- src/services/coverage_proof_service.py
- src/ui/pages/2_verified_bets.py
- tests/unit/test_coverage_proof_service.py

## QA Results

### Risk Assessment
- **Complexity**: 3/5 - Moderate complexity involving UI components, service integration, and rate-limiting logic
- **Data Sensitivity**: Medium - Handles Telegram message delivery and associate communication data
- **Integration Risk**: 3/5 - Integrates with Telegram API, database logging, and existing service layer
- **Overall Risk Score**: 12 (Medium)

### NFR Analysis
- **Security**: PASS - No sensitive data exposure, proper Telegram token handling via existing config
- **Performance**: PASS - Efficient database queries with pagination, cooldown calculations are lightweight
- **Reliability**: CONCERNS - Rate-limiting logic is solid but error handling for Telegram API failures could be more robust
- **Usability**: PASS - Clear UI with helpful tooltips and disabled state explanations
- **Maintainability**: PASS - Well-structured code following existing patterns, good separation of concerns

### Test Strategy
- **Unit Tests**: Excellent coverage (21 test functions) covering all major service methods, edge cases, and error conditions
- **Integration Tests**: Need E2E tests for the complete UI workflow (outbox display → resend → success/failure feedback)
- **E2E Tests**: Required for testing actual Telegram integration with rate limiting behavior
- **Edge Cases**: Well covered - missing chat IDs, no screenshots, Telegram API errors, rate limit scenarios

### Requirements Traceability
- **AC1**: ✅ Mapped to `get_outbox_entries()` method and UI table rendering in `render_coverage_proof_outbox()`
- **AC2**: ✅ Mapped to `send()` method with `resend=True` parameter and UI button with cooldown disabled state
- **AC3**: ✅ Mapped to rate-limit health indicators and analytics logging in `get_outbox_entries()`
- **AC4**: ✅ Mapped to inline guidance and tooltips in UI implementation

### Quality Gate Decision
- **Decision**: CONCERNS
- **Risk Score**: 12 (Medium)
- **Rationale**: The implementation is solid and meets all acceptance criteria with excellent unit test coverage. However, there are some concerns that should be addressed:
  1. **Error Recovery**: While Telegram API errors are caught and logged, the UI could provide better user feedback for retry scenarios
  2. **E2E Testing Gap**: Missing end-to-end tests for the complete user workflow
  3. **Rate Limit Edge Cases**: Some edge cases around cooldown calculations could benefit from additional testing
  4. **Accessibility**: UI components need verification for keyboard navigation and screen reader support

### Recommendations
1. **Add E2E Tests**: Implement automated tests covering the full resend workflow from UI button click to Telegram delivery
2. **Enhanced Error UI**: Improve user feedback for failed sends with clearer retry instructions and error categorization
3. **Accessibility Audit**: Verify keyboard navigation and screen reader compatibility for the outbox table and resend controls
4. **Load Testing**: Test rate-limiting behavior under high concurrent load scenarios
5. **Monitoring**: Add metrics tracking for resend success rates and average cooldown times

**QA Engineer**: Quinn - Test Architect
**Date**: 2025-11-10T11:36:00Z
