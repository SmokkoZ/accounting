# Story 12.2: Replace CSV with Styled XLSX Exports

## Status
Approved

## Story
**As an** operations lead,  
**I want** every ledger export entry point to deliver a styled Excel workbook instead of a raw CSV,  
**so that** I can review, filter, and share statements without performing manual formatting in Excel.

## Acceptance Criteria
1. All existing "Export CSV/Download CSV" controls are relabeled to "Export Excel/Download Excel" and now return `.xlsx` files across the export page, statements, and any job-triggered downloads. [Source: docs/prd/epic-12-signal-broadcaster-and-styled-excel-exports.md]
2. Each Excel workbook preserves the exact rows, columns, and ordering from the current CSV output so downstream consumers remain backward compatible. [Source: docs/prd/epic-12-signal-broadcaster-and-styled-excel-exports.md]
3. The worksheet header row is bold with a light background tint and columns auto-fit for readability. [Source: docs/prd/epic-12-signal-broadcaster-and-styled-excel-exports.md]
4. Deposits display with a positive (green) row tint and withdrawals with a negative (red) tint so transaction types are scannable at a glance. [Source: docs/prd/epic-12-signal-broadcaster-and-styled-excel-exports.md]
5. Numeric columns (amounts, FX rates, balances) are typed as numbers instead of text so Excel formulas and filters work immediately. [Source: docs/prd/epic-12-signal-broadcaster-and-styled-excel-exports.md]
6. Export errors surface inline feedback (status block + toast) instead of failing silently, giving the operator actionable guidance. [Source: docs/prd/epic-12-signal-broadcaster-and-styled-excel-exports.md]

## Tasks / Subtasks
- [ ] Task 1: Update UI export entry points (AC: 1, 6)
  - [ ] Rename the export buttons in `src/ui/pages/5_export.py` (and any related `st.page_link` helpers) to "Export Excel/Download Excel" so navigation and labeling match the documented UI tree. [Source: docs/architecture/source-tree.md#srcui--streamlit-ui]
  - [ ] Keep the Page 5 pattern: trigger the export through a button that kicks off the job, stream progress, and expose the download button with success/error messaging once the `.xlsx` is ready. [Source: docs/architecture/frontend-architecture.md#page-patterns-updated]
  - [ ] Ensure statements and any other inline export controls reuse the same `st.status` + toast pattern so failures are obvious across every entry point. [Source: docs/architecture/frontend-architecture.md#e-streaming-progress-and-documents]
- [ ] Task 2: Build XLSX exporter inside LedgerService (AC: 2, 3, 4, 5)
  - [ ] Read the ledger dataset with the documented SQL (joins to associates/bookmakers) so Excel rows and ordering match the CSV baseline exactly. [Source: docs/architecture/data-architecture.md#export-full-ledger]
  - [ ] Extend `src/services/ledger_service.py` to transform the query into a pandas DataFrame and write via `ExcelWriter`/`xlsxwriter`, applying bold/shaded headers plus auto-fit numeric columns. [Source: docs/architecture/source-tree.md#src/services--business-logic][Source: docs/architecture/tech-stack.md#backend-stack]
  - [ ] Convert Decimal fields carefully so numeric columns keep precision, and style deposits vs withdrawals with the required row tinting to meet the AC. [Source: docs/architecture/tech-stack.md#currency-math][Source: docs/prd/epic-12-signal-broadcaster-and-styled-excel-exports.md]
  - [ ] Return structured metadata (path, file size, row count, error details) so the UI/status block can present meaningful success/failure summaries. [Source: docs/architecture/frontend-architecture.md#e-streaming-progress-and-documents]
- [ ] Task 3: Refresh scheduled exports and storage (AC: 1, 2)
  - [ ] Update `src/jobs/export_ledger_daily.py` (and any CLI helpers) to call the XLSX writer so automated jobs generate the same styled workbook as the UI. [Source: docs/architecture/source-tree.md#src/jobs--background-jobs]
  - [ ] Continue saving artifacts under `data/exports/` with the new `.xlsx` suffix and document any rotation or retention adjustments. [Source: docs/architecture/source-tree.md#data-directory-git-ignored]
  - [ ] Reflect the new file extension anywhere operator docs or help text describe the export outputs. [Source: docs/architecture/source-tree.md#docs-directory]
- [ ] Task 4: Testing and operator validation (AC: 1-6)
  - [ ] Add unit tests that open the generated workbook in memory and assert header formatting, column typing, and deposit/withdrawal tinting. [Source: docs/architecture/testing-strategy.md#testing-pyramid]
  - [ ] Expand the integration/e2e coverage that previously asserted CSV creation (LedgerService export + export page flow) to confirm `.xlsx` files are generated, saved, and downloadable without corruption. [Source: docs/architecture/testing-strategy.md#end-to-end-tests-5]
  - [ ] Add UI smoke coverage (or scripted regression) that triggers an export and validates the `st.status` lifecycle plus toast/error outputs. [Source: docs/architecture/frontend-architecture.md#e-streaming-progress-and-documents]

## Dev Notes

### Previous Story Insights
- Story 12.1 focused exclusively on the Signal Broadcaster UI and Telegram delivery, so no shared code paths or dependencies block the ledger export refactor. [Source: docs/stories/12.1.signal-broadcaster-page.md#story]

### Data Models & Queries
- Ledger exports already rely on the documented SQL that joins `ledger_entries` to associates and bookmakers; keep the same ordering and projected columns when feeding the Excel writer. [Source: docs/architecture/data-architecture.md#export-full-ledger]
- Maintain `Decimal`-accurate balances and FX values when loading data and only coerce to floats at the final Excel cell assignment to avoid rounding drift. [Source: docs/architecture/tech-stack.md#currency-math]

### Service Layer Guidance
- `src/services/ledger_service.py` houses the export logic and should stay single-responsibility: fetch data, hydrate a DataFrame, and emit files while being callable from UI and jobs. [Source: docs/architecture/source-tree.md#src/services--business-logic][Source: docs/architecture/coding-standards.md#single-responsibility-principle]
- Scheduled backups live in `src/jobs/export_ledger_daily.py`; refactor them to reuse the XLSX helper so automated and manual exports stay consistent. [Source: docs/architecture/source-tree.md#src/jobs--background-jobs]
- Pandas is the sanctioned data-manipulation/export library, so use it (and its Excel writer engines) rather than adding a new dependency. [Source: docs/architecture/tech-stack.md#backend-stack]

### UI Workflow & Operator Feedback
- Page 5 (Export) must keep the button + streaming log + download pattern so operators see progress before receiving the file. [Source: docs/architecture/frontend-architecture.md#page-patterns-updated]
- Use the documented status/toast workflow (status block for long-running exports, toast for completion) to surface both success counts and any errors. [Source: docs/architecture/frontend-architecture.md#e-streaming-progress-and-documents]
- Navigation is code-defined via `st.navigation`/`st.Page`, so retain the same structure when renaming buttons or adding Excel-specific help links. [Source: docs/architecture/frontend-architecture.md#page-patterns-updated]

### File Locations & Storage
- UI files live under `src/ui/pages/5_export.py` and `src/ui/pages/6_statements.py`, while exported artifacts live under `data/exports/`; keep using those paths when introducing `.xlsx`. [Source: docs/architecture/source-tree.md#srcui--streamlit-ui][Source: docs/architecture/source-tree.md#data-directory-git-ignored]
- Automated jobs and supporting scripts stay in `src/jobs/`, and all new tests should land in the existing `tests/unit`, `tests/integration`, or `tests/e2e` folders. [Source: docs/architecture/source-tree.md#src/jobs--background-jobs][Source: docs/architecture/source-tree.md#tests]

### Testing Requirements
- Follow the documented pyramid: unit tests for the Excel formatter, integration tests hitting SQLite/pandas to assert file integrity, and the existing e2e flow that exports the ledger should now expect `.xlsx`. [Source: docs/architecture/testing-strategy.md#testing-pyramid][Source: docs/architecture/testing-strategy.md#end-to-end-tests-5]
- Reuse the shared pytest fixtures (`test_db`, `test_screenshots`) so export tests stay deterministic and cover regression scenarios around ledger data volume. [Source: docs/architecture/testing-strategy.md#test-fixtures]

### Technical Constraints
- Streamlit features such as fragments, status blocks, and navigation require runtime ≥1.30 (1.46 recommended), so keep compatibility guards in place while updating the export UI. [Source: docs/architecture/tech-stack.md#frontend-stack]
- Keep all monetary values as `Decimal` objects until the last possible moment to avoid rounding errors in Excel. [Source: docs/architecture/tech-stack.md#currency-math]
- Stick with pandas for file generation per the approved backend stack—no new Excel libraries unless explicitly approved. [Source: docs/architecture/tech-stack.md#backend-stack]

## Testing
- Unit: add workbook-format tests under `tests/unit/` to assert header styling, numeric typing, and deposit/withdrawal colors for the Excel helper. [Source: docs/architecture/testing-strategy.md#testing-pyramid]
- Integration: extend the ledger export integration test to run against the SQLite fixture and confirm the `.xlsx` file is created in `data/exports/` with expected metadata. [Source: docs/architecture/testing-strategy.md#end-to-end-tests-5]
- End-to-end: update `tests/e2e/test_full_surebet_lifecycle.py` step 7 to download the Excel export instead of CSV and verify Excel opens without corruption. [Source: docs/architecture/testing-strategy.md#end-to-end-tests-5]
- Manual/UX: trigger the Export page in Streamlit and confirm the `st.status` lifecycle plus toasts cover both success and failure cases. [Source: docs/architecture/frontend-architecture.md#e-streaming-progress-and-documents]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-15 | 1.0 | Initial draft for XLSX export story | Bob (Scrum Master) |

## Dev Agent Record
  ### Agent Model Used
  - Pending (filled during implementation)

  ### Debug Log References
  - Pending

  ### Completion Notes List
  - Pending

  ### File List
  - Pending

## QA Results

### Risk Assessment
- **Complexity**: 3/5 – touches UI, background jobs, and a new Excel formatter but follows existing export patterns.
- **Data Sensitivity**: High – ledger exports contain financial history used for reconciliation and operator reporting.
- **Integration Risk**: 3/5 – UI export entry points, `LedgerService`, and scheduled jobs must all stay in lockstep.
- **Overall Risk Score**: 12 (Medium) – dominated by the risk of regressions in export parity and Excel formatting.

### NFR Analysis
- **Security**: PASS – reuses existing export flows and storage locations; no new external surface beyond current file downloads.
- **Performance**: PASS – XLSX generation is heavier than CSV but is constrained to operator-triggered or scheduled exports; recommend a large-ledger regression fixture to watch for timeouts.
- **Reliability**: PASS – tasks require a single XLSX writer in `LedgerService` plus integration tests for UI and jobs, reducing divergence risk.
- **Usability**: PASS – “Export Excel/Download Excel” labels, styled headers, and tinted rows make statements more scannable; inline status + toast patterns keep errors visible.
- **Maintainability**: PASS – centralized Excel generation in the service layer with explicit tests keeps styling/typing behavior change-controlled.

### Test Strategy
- **Unit Tests**: Workbook-format tests for header styling, numeric typing, and deposit/withdrawal tinting in the Excel helper (per `tests/unit` plan).
- **Integration Tests**: Ledger export integration tests that hit SQLite/pandas and assert `.xlsx` creation in `data/exports/` with expected metadata and row/column parity versus the CSV baseline.
- **End-to-End Tests**: Updated e2e flow (e.g., `tests/e2e/test_full_surebet_lifecycle.py`) to download the Excel export instead of CSV and confirm files open without corruption.
- **Manual/UX Validation**: Streamlit export flows exercised to verify the `st.status` lifecycle, toast messaging, and error surfacing across all entry points (export page, statements, scheduled exports where observable).

### Requirements Traceability
- **AC1 (Excel labels and `.xlsx` everywhere)**: UI task 1 plus scheduled-export task 3 ensure all “Export CSV/Download CSV” controls are relabeled and wired to the XLSX writer for both interactive and job-triggered flows.
- **AC2 (Parity with current CSV)**: Ledger SQL reuse and DataFrame-based export in task 2 keep rows, columns, and ordering identical to the CSV baseline; integration tests compare structure and sample content.
- **AC3 (Header styling + auto-fit)**: Excel writer responsibilities in task 2 explicitly include bold/shaded headers and column auto-fit, validated by unit tests.
- **AC4 (Tinted deposits/withdrawals)**: Styling logic in the Excel writer tints rows based on deterministic transaction type fields; unit tests cover positive/negative scenarios.
- **AC5 (Numeric typing)**: Careful Decimal-to-numeric conversion in task 2, plus unit assertions on column dtypes, ensure amounts/FX/balances are exported as numbers.
- **AC6 (Inline error feedback)**: UI task 1 and testing/UX tasks require `st.status` + toast patterns for export errors so operators receive actionable feedback instead of silent failures.

### Quality Gate Decision
- **Decision**: PASS
- **Risk Score**: 12 (Medium)
- **Rationale**: Story 12.2 provides clear, testable acceptance criteria that fully replace CSV exports with styled `.xlsx` workbooks while preserving data parity; tasks and testing notes cover UI, service, and scheduled-job touchpoints with an explicit plan for unit, integration, e2e, and manual validation.
- **Recommendations**:
  1. Introduce at least one large-ledger test fixture to exercise XLSX generation performance and file size under realistic load.
  2. Keep a short-term CSV fallback or feature flag during rollout in case Excel handling issues arise in operator environments.

**QA Engineer**: Quinn - Test Architect  
**Date**: 2025-11-14
