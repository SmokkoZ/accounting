# Story 0.2: Core Database Schema

## Status
Ready for Done

## Story
**As a** system,
**I want** all 11 core tables created with proper constraints so data integrity is enforced.

## Acceptance Criteria
- [x] SQLite database created at `data/surebet.db` with WAL mode enabled
- [x] Schema script (`schema.sql` or Python migration) creates tables:
  - `associates` (trusted partners including admin)
  - `bookmakers` (accounts per associate)
  - `canonical_events` (normalized sporting events)
  - `canonical_markets` (market type definitions)
  - `bets` (individual bet records with status state machine)
  - `surebets` (grouped opposing bets)
  - `surebet_bets` (junction table with side assignment)
  - `ledger_entries` (append-only financial ledger)
  - `verification_audit` (bet approval history)
  - `multibook_message_log` (coverage proof delivery)
  - `bookmaker_balance_checks` (associate-reported balances)
  - `fx_rates_daily` (currency conversion cache)
- [x] Key constraints enforced:
  - `ledger_entries` has NO UPDATE/DELETE triggers (append-only enforced)
  - `surebet_bets.side` immutable after INSERT
  - All currency fields stored as TEXT (Decimal serialization)
  - All timestamps stored as TEXT in ISO8601 format with "Z"
- [x] Seed data inserted:
  - 2 associates: "Admin" (you) and "Partner A"
  - 4 bookmakers: 2 per associate (e.g., Bet365, Pinnacle)
  - 2 canonical markets: "TOTAL_GOALS_OVER_UNDER", "ASIAN_HANDICAP"
- [x] Schema validation script confirms all tables exist with correct columns
  
- [x] (New) Canonical event pair-key columns and index
  - `canonical_events` includes: `team1_slug`, `team2_slug`, `pair_key`
  - Index on `(sport, pair_key)` for fast normalized lookups

## Tasks / Subtasks
- [x] Task 1: Create database initialization script (AC: 1)
  - [x] Create `src/core/database.py` with connection setup
  - [x] Configure SQLite with WAL mode and foreign keys
  - [x] Create database directory if it doesn't exist
- [x] Task 2: Implement schema creation script (AC: 2)
  - [x] Create `src/core/schema.py` with all 11 table definitions
  - [x] Implement proper constraints and indexes
  - [x] Add triggers for append-only ledger enforcement
- [x] Task 3: Implement data validation constraints (AC: 3)
  - [x] Add trigger to prevent UPDATE/DELETE on ledger_entries
  - [x] Add trigger to prevent changes to surebet_bets.side
  - [x] Ensure all currency fields use TEXT type
  - [x] Ensure all timestamp fields use TEXT with ISO8601 format
- [x] Task 4: Create seed data script (AC: 4)
  - [x] Create `src/core/seed_data.py` with initial data
  - [x] Insert 2 associates with proper attributes
  - [x] Insert 4 bookmakers linked to associates
  - [x] Insert 2 canonical markets
- [x] Task 5: Implement schema validation script (AC: 5)
  - [x] Create `src/core/schema_validation.py`
  - [x] Verify all tables exist with correct columns
  - [x] Verify all constraints are properly enforced
  - [x] Add unit tests for schema validation

## Dev Notes

### Previous Story Insights
From story 0.1, we have:
- Project structure established with src/ directory
- Database location defined as `data/surebet.db`
- SQLite with WAL mode configuration established
- Python environment with required dependencies set up

### Data Models
All 11 tables must be created according to the data model specification [Source: docs/prd/data-model.md]:

1. **associates** - Trusted partners including admin
   - Key fields: id, display_alias, home_currency, multibook_chat_id
   - Admin is also an associate with special privileges

2. **bookmakers** - Bookmaker accounts per associate
   - Key fields: id, associate_id, bookmaker_name, parsing_profile
   - Unique constraint on (associate_id, bookmaker_name)

3. **canonical_events** - Normalized sporting events
   - Key fields: id, normalized_event_name, league, sport, kickoff_time_utc
   - Normalized matching fields: team1_slug, team2_slug, pair_key (sorted slug pair)
   - Used for matching and settlement ordering

4. **canonical_markets** - Market type definitions
   - Key fields: id, market_code, description
   - Pre-populate with common market types

5. **bets** - Individual bet records
   - Complex table with OCR, normalization, and financial fields
   - Status state machine: incoming → verified → matched → settled

6. **surebets** - Grouped opposing bets
   - Key fields: id, canonical_event_id, market_code, status
   - Unique constraint on event/market combination

7. **surebet_bets** - Junction table with deterministic side assignment
   - Key fields: surebet_id, bet_id, side
   - Side mapping: A=OVER/YES/TEAM_A, B=UNDER/NO/TEAM_B

8. **ledger_entries** - Append-only financial ledger
   - Key fields: associate_id, type, amount_eur, fx_rate_snapshot
   - System Law #1: Never UPDATE/DELETE rows

9. **verification_audit** - Bet approval history
   - Key fields: bet_id, diff_before_after, actor
   - Tracks all changes during bet approval

10. **multibook_message_log** - Coverage proof delivery
    - Key fields: associate_id, surebet_id, delivery_status
    - Tracks message delivery to multibook chats

11. **fx_rates_daily** - Currency conversion cache
    - Key fields: currency_code, rate_to_eur, fetched_at_utc
    - One rate per currency per day

### API Specifications
No API endpoints required for this story.

### Component Specifications
No UI components required for this story.

### File Locations
Based on architecture documentation:
- `src/core/database.py` - Database connection and initialization [Source: docs/architecture/source-tree.md#240-257]
- `src/core/schema.py` - Table definitions and creation [Source: docs/architecture/source-tree.md#254-256]
- `src/core/seed_data.py` - Initial data population [Source: docs/architecture/source-tree.md#254-256]
- `src/core/schema_validation.py` - Schema verification [Source: docs/architecture/source-tree.md#254-256]
- `data/surebet.db` - SQLite database file location [Source: docs/architecture/source-tree.md#140-159]

### Testing Requirements
From testing strategy:
- Create unit tests for schema creation [Source: docs/architecture/testing-strategy.md#54-77]
- Test all constraints are properly enforced
- Test seed data insertion
- Test schema validation script
- Test database initialization with WAL mode

### Technical Constraints
- SQLite 3.40+ with WAL mode enabled [Source: docs/architecture/tech-stack.md#120-138]
- All currency values stored as TEXT (Decimal serialization) [Source: docs/architecture/tech-stack.md#96-113]
- All timestamps in UTC ISO8601 with "Z" suffix [Source: docs/architecture/coding-standards.md#198-226]
- Use parameterized queries for all SQL operations [Source: docs/architecture/coding-standards.md#310-320]
- Append-only ledger (System Law #1) [Source: docs/prd/data-model.md#289-291]
- Frozen FX snapshots (System Law #2) [Source: docs/prd/data-model.md#293-296]

### Project Structure Notes
The database schema implementation should follow the documented source tree:
- Core database functionality in `src/core/` directory
- Database file in `data/` directory (git-ignored)
- Tests in `tests/unit/test_core_database.py`

## Testing
### Testing Standards
- Use pytest 7.0+ as testing framework [Source: docs/architecture/testing-strategy.md#36]
- Test file naming: `test_` prefix [Source: docs/architecture/coding-standards.md#452-464]
- Test function naming: descriptive names [Source: docs/architecture/coding-standards.md#467-483]
- Follow AAA pattern (Arrange, Act, Assert) [Source: docs/architecture/coding-standards.md#487-501]
- Test database constraints are enforced
- Test seed data insertion
- Test schema validation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-01 | 1.1 | Added canonical_events pair-key columns (team1_slug, team2_slug, pair_key) + index | Codex Agent |
| 2025-10-29 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
### Agent Model Used
glm-4.6

### Debug Log References
No debug logs required for this story.

### Completion Notes List
- All 11 core tables created with proper constraints and indexes
- SQLite configured with WAL mode and foreign keys enabled
- Append-only ledger enforcement implemented via triggers
- Seed data inserted for 2 associates, 4 bookmakers, and 2 canonical markets
- Comprehensive schema validation script created with unit tests
- All currency fields stored as TEXT for Decimal serialization
- All timestamps stored as TEXT in ISO8601 format with "Z" suffix
- All unit tests passing (10/10)
- Schema validation handles SQLite BOOLEAN type correctly
- Database initialization and validation working correctly
- Minor issue encountered with BOOLEAN type validation in schema validation script
- Fixed BOOLEAN type handling to work with SQLite's internal storage
- Created temporary debug scripts to identify SQLite column type behavior
- Cleaned up temporary debug files after resolving validation issues

### File List
- src/core/config.py - Configuration management
- src/core/database.py - Database connection and initialization
- src/core/schema.py - Table definitions and creation
- src/core/seed_data.py - Initial data population
- src/core/schema_validation.py - Schema verification
- src/utils/datetime_helpers.py - Date/time utilities
- tests/unit/test_core_database.py - Unit tests for database functionality

## QA Results

### Review Date: 2025-10-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The database schema implementation is well-structured and follows the requirements specified in the story. All 11 core tables have been created with proper constraints, indexes, and triggers. The implementation correctly enforces the System Laws (append-only ledger and immutable surebet_bets.side) through database triggers. The code is well-documented with clear docstrings and follows the established coding standards.

### Refactoring Performed

No refactoring was required as the code quality is high and follows best practices.

### Compliance Check

- Coding Standards: ✓ All code follows the documented coding standards
- Project Structure: ✓ Files are placed in correct locations per source-tree documentation
- Testing Strategy: ✓ Comprehensive unit tests cover all critical functionality
- All ACs Met: ✓ All acceptance criteria have been fully implemented

### Improvements Checklist

- [x] All 11 core tables created with proper constraints
- [x] SQLite configured with WAL mode and foreign keys enabled
- [x] Append-only ledger enforcement implemented via triggers
- [x] Seed data inserted for 2 associates, 4 bookmakers, and 2 canonical markets
- [x] Comprehensive schema validation script created with unit tests
- [x] All currency fields stored as TEXT for Decimal serialization
- [x] All timestamps stored as TEXT in ISO8601 format with "Z" suffix
- [x] All unit tests passing (10/10)
- [x] Schema validation handles SQLite BOOLEAN type correctly
- [x] Database initialization and validation working correctly

### Security Review

The implementation includes proper security measures:
- Foreign key constraints are enforced to maintain referential integrity
- Append-only ledger prevents financial data tampering (System Law #1)
- Immutable surebet_bets.side prevents bet manipulation after creation
- Parameterized queries are used throughout to prevent SQL injection

### Performance Considerations

The implementation includes several performance optimizations:
- WAL mode enabled for better concurrent access
- Appropriate indexes created for common query patterns
- SQLite pragmas configured for optimal performance (cache_size, temp_store)
- Connection pooling is handled through the get_db_connection function

### Files Modified During Review

No files were modified during this review.

### Gate Status

Gate: PASS → docs/qa/gates/0.2.core-database-schema.yml
Risk profile: docs/qa/assessments/0.2.core-database-schema-risk-20251029.md
NFR assessment: docs/qa/assessments/0.2.core-database-schema-nfr-20251029.md

### Recommended Status

✓ Ready for Done
