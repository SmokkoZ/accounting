# Story 11.2: Exit Settlement Flow and Receipt

## Status
Ready for Review

## Story
As an operations user, I want a "Settle Associate Now" action that computes imbalance (I'') as of a cutoff date, posts a single balancing ledger entry, and generates a receipt, so that associates always exit with I'' = 0 and exports clearly reflect the payout.

## Acceptance Criteria
1. AC1: Provide an operation `settle_associate_now(associate_id, as_of_utc)` that computes I'' = TB - YF at cutoff and returns a receipt payload. [Source: docs/architecture/backend-architecture.md#change-notes-—-yf--exit-settlement-alignment-2025-11-13]
2. AC2: Post exactly one balancing ledger entry: `DEPOSIT` if I'' < 0, `WITHDRAWAL` if I'' > 0, using the signed amount convention (withdrawals negative, deposits positive). [Source: docs/architecture/backend-architecture.md#change-notes-—-yf--exit-settlement-alignment-2025-11-13]
3. AC3: After posting, recompute and assert I'' == 0 in read models and statements for the associate as of the cutoff. [Source: docs/prd/epic-11-fair-balance-exit-settlement.md]
4. AC4: Generate a human-readable receipt (markdown snippet) and include an "Exit Payout" row (−I'') in the exit CSV export with a versioned footnote (e.g., YF‑v1). [Source: docs/prd/epic-11-fair-balance-exit-settlement.md]
5. AC5: Streamlit UI exposes a "Settle Associate Now" action on Statements/Operations; action is idempotent per cutoff and validates no schema changes are introduced. [Source: docs/prd/epic-11-fair-balance-exit-settlement.md]

## Tasks / Subtasks
- [x] Task 1: Implement settlement operation (AC: 1, 2, 3)
  - [x] Add application function `settle_associate_now(associate_id: int, as_of_utc: str) -> dict` in `src/services/settlement_engine.py` or a new `exit_settlement_service.py` that:
    - [x] Computes YF (= ND + FS) and TB as of `as_of_utc` using existing read paths
    - [x] Computes I'' = TB - YF
    - [x] Creates a single balancing ledger entry with correct signed amount
    - [x] Returns a receipt DTO with fields needed by CSV/UX (amount, cutoff, entry id, notes)
    - [x] Unit tests for I'' sign cases and idempotency by cutoff
    - [x] [Source: docs/architecture/backend-architecture.md#change-notes-—-yf--exit-settlement-alignment-2025-11-13]
- [x] Task 2: Receipt generation and CSV integration (AC: 4)
  - [x] Extend export helpers in `src/services/statement_service.py` to:
    - [x] Include an "Exit Payout" row equal to −I'' at cutoff for exit exports
    - [x] Emit version stamp (e.g., YF‑v1) and definition footnote
    - [x] Provide a markdown receipt snippet saved under `data/exports/receipts/{associate_id}/{YYYYMMDD}_exit.md`
    - [x] Integration tests assert receipt content and CSV row presence
    - [x] [Source: docs/prd/epic-11-fair-balance-exit-settlement.md]
- [x] Task 3: UI action wiring in Streamlit (AC: 5)
  - [x] Add a "Settle Associate Now" button with date picker on Statements/Operations screen
  - [x] Call the backend operation and display confirmation plus receipt preview
  - [x] Ensure guardrails: confirm intent, show result amount and that I'' == 0
  - [x] UI smoke test to protect against regressions in labels and action wiring
  - [x] [Source: docs/architecture/frontend-architecture.md]
- [x] Task 4: Testing and identity assertions (AC: 1–5)
  - [x] Extend or add integration tests (e.g., `tests/integration/test_exit_settlement_flow.py`) to cover:
    - [x] Mixed ND scenarios and FS contributions (WON/LOST/VOID)
    - [x] Both signs of I'' with correct ledger polarity and final I'' == 0
    - [x] CSV includes "Exit Payout" row and versioned footnote
    - [x] Round-trip: running operation twice for same cutoff does not double-apply
  - [x] [Source: docs/architecture/testing-strategy.md]
- [x] Task 5: Docs and backward compatibility (AC: 4, 5)
  - [x] Update user-facing copy to use "Your Fair Balance (YF)" consistently
  - [x] Add release notes and tooltips clarifying YF and exit payout semantics
  - [x] Confirm no schema changes; continue mapping legacy `should_hold_eur` to `yf_eur`
  - [x] [Source: docs/architecture/backend-architecture.md#change-notes-—-yf--exit-settlement-alignment-2025-11-13]

## Dev Notes

### Previous Story Insights
- Story 11.1 normalized ND sign handling and adopted identity fields (ND, FS, YF, TB, I'') across reconciliation, statements, and bookmaker views without schema changes; CSV/exports already expose identity values. These are prerequisites leveraged here. [Source: docs/architecture/backend-architecture.md#change-notes-—-yf--exit-settlement-alignment-2025-11-13]

### Data Models
- No schema changes. Reuse existing `ledger_entries` and DTOs; continue mapping legacy `should_hold_eur` to `yf_eur` in API/UI layers. [Source: docs/architecture/backend-architecture.md#change-notes-—-yf--exit-settlement-alignment-2025-11-13]

### Service Logic
- Settlement operation computes YF (= ND + FS) and TB at cutoff, then posts a single balancing entry so I'' becomes 0. DEPOSIT if I'' < 0; WITHDRAWAL if I'' > 0. Use signed storage conventions already enforced by 11.1. [Source: docs/prd/epic-11-fair-balance-exit-settlement.md]

### Component / UI Specifications
- Add a Streamlit action on Statements/Operations with cutoff date selection; on success, display receipt preview and updated identity fields (ND, FS, YF, TB, I''). [Source: docs/architecture/frontend-architecture.md]

### File Locations
- Backend operation: `src/services/settlement_engine.py` (or `src/services/exit_settlement_service.py` if clearer)
- Export helpers and CSV: `src/services/statement_service.py`
- UI: `src/ui/statements.py` or equivalent Streamlit view
- Receipts: `data/exports/receipts/{associate_id}/{YYYYMMDD}_exit.md`

### Testing Requirements
- Unit: polarity rules for DEPOSIT/WITHDRAWAL, idempotency by cutoff, receipt DTO shape. [Source: docs/architecture/testing-strategy.md]
- Integration: end-to-end exit flow validating I'' == 0 and CSV/receipt artifacts. [Source: docs/prd/epic-11-fair-balance-exit-settlement.md]

### Technical Constraints
- Architecture version v4; follow existing service and DTO patterns.
- No schema changes; exports must remain backward compatible with versioned notes. [Source: docs/prd/epic-11-fair-balance-exit-settlement.md]

## Project Structure Notes
- Align with existing service layout under `src/services/` and export helpers in statement service. If introducing a new `exit_settlement_service.py`, ensure imports and dependency wiring mirror other services.

## QA Results

### Risk Assessment
- **Complexity**: 4/5
- **Data Sensitivity**: Medium
- **Integration Risk**: 3/5
- **Overall Risk Score**: 12 (Medium) - backend/CSV logic is complex but now shielded by targeted integration and UI tests.

### NFR Analysis
- **Security**: PASS - No new data paths; ledger writes still go through the vetted funding service.
- **Performance**: PASS - Settlement still issues a single ledger transaction and reruns statements only on demand.
- **Reliability**: PASS - Post-settlement recomputation asserts I'' == 0 and session state now preserves the refreshed snapshot until the operator explicitly reruns.
- **Usability**: PASS - Both Streamlit entry points keep the success panel and receipt expander visible, and operators control when (or if) the page reruns.
- **Maintainability**: PASS - Shared constants (model version, footnote) continue to live in `settlement_constants`, and the refresh-gate pattern is implemented identically in both surfaces.

### Findings
- **Receipt preview retained until the operator refreshes (PASS - AC4/AC5)**: `src/ui/pages/6_statements.py` (lines 599-635) and `src/ui/components/associate_hub/drawer.py` (lines 859-888) moved `safe_rerun()` behind a dedicated refresh button. The success block now renders metrics, the markdown snippet, and download controls before any rerun occurs, satisfying the UX half of AC4/AC5.
- **Anti-regression coverage added**: `tests/ui/test_exit_settlement_ui.py::test_settlement_success_shows_receipt_preview` drives the Streamlit page, asserts the receipt expander visibility, and confirms the refresh button label so future UI edits cannot hide the artifact again. Command: `pytest tests/ui/test_exit_settlement_ui.py` (2025-11-14).
- **Backend/CSV behavior unchanged and still verified**: `tests/integration/test_exit_settlement_flow.py` continues to cover DEPOSIT/WITHDRAWAL polarity, CSV footnotes, receipt persistence, and cutoff idempotency, so the UI-only fix did not compromise AC1-AC3.

### Test Strategy
- **Unit**: `tests/unit/test_exit_settlement_service.py` (polarity, receipt metadata, tolerance guard) - unchanged and still required.
- **Integration**: `tests/integration/test_exit_settlement_flow.py` (both signs, CSV "Exit Payout" row, footnote, idempotency) - PASS on latest commit.
- **UI**: `tests/ui/test_exit_settlement_ui.py` now validates the full success path, including the new refresh gating and expander contents (see execution above).

### Requirements Traceability
- **AC1**: PASS - `ExitSettlementService.settle_associate_now` returns the receipt payload and is exercised by unit/integration suites.
- **AC2**: PASS - A single DEPOSIT/WITHDRAWAL is posted per cutoff with signed amounts; verified in integration coverage.
- **AC3**: PASS - The service regenerates statements after posting and raises if I'' remains outside tolerance.
- **AC4**: PASS - Receipts render inline, include the "Exit Payout" row and footnote (CSV + markdown), and operators can download the file without filesystem access.
- **AC5**: PASS - Streamlit Statements and Operations UIs expose the "Settle Associate Now" action, keep the receipt visible, and gate reruns behind an explicit refresh button while smoke tests assert the path.

### Quality Gate Decision
- **Decision**: PASS
- **Risk Score**: 12
- **Rationale**: The original UX blocker has been removed, UI automation now guards receipt visibility, and backend/export behaviors remain fully exercised. Operators can verify the payout, download receipts, and rerun views only after reviewing the evidence.
- **Recommendations**:
  1. Keep the receipt expander's default collapsed state under review; consider auto-expanding it when the amount magnitude exceeds a configurable threshold so large payouts do not go unnoticed.
  2. Monitor Streamlit's session-state handling in CI; if reruns ever resume automatically, extend UI tests to assert download-button visibility explicitly.

**QA Engineer**: Quinn - Test Architect  
**Date**: 2025-11-14


## Change Log
| Date       | Version | Description                                          | Author |
|------------|---------|------------------------------------------------------|--------|
| 2025-11-13 | 0.1     | Story created and vetted by QA                        | SM     |
| 2025-11-13 | 0.2     | QA fixes for receipt visibility and manual rerun flow | James  |

## Dev Agent Record
### Agent Model Used

- GPT-5 / Codex CLI default stack (Python 3.12 runtime)

### Debug Log References

- `pytest tests/integration/test_statement_flow.py::TestSettlementWorkflow::test_settle_associate_now_zeroes_delta`
- `pytest tests/ui/test_exit_settlement_ui.py`

### Completion Notes List

- Manual refresh buttons now gate `safe_rerun()` on both the Statements page and the Operations drawer so the success panel, receipt expander, and download controls remain visible after settlement.
- Added a UI regression test that simulates the settling path, ensures the receipt expander renders, and verifies the new Refresh button label is present so receipts stay accessible.
- QA gate rerun requested so receipts and renewal flow can be confirmed with the refreshed UX.

### File List

- `src/ui/pages/6_statements.py`
- `src/ui/components/associate_hub/drawer.py`
- `tests/ui/test_exit_settlement_ui.py`
- `docs/stories/11.2.exit-settlement-flow-and-receipt.md`
