# Story 9.2: Streamlit Funding Approvals (Telegram Drafts)

## Status
Ready for Review

## Story
As an admin, I want to review and approve deposit/withdrawal drafts originating from Telegram chats, so associate funding is correctly reflected in the ledger per bookmaker.

## Acceptance Criteria

- [ ] Pending Funding (Telegram) panel in Admin area
  - Columns: Created At, Associate Alias, Bookmaker, Type, Amount (native), Currency, Source Chat ID, Note
  - Source badge: `telegram`
- [ ] Actions per draft
  - [ ] Accept → create `ledger_entries` row with `bookmaker_id`
  - [ ] Reject → remove draft, no ledger write
  - [ ] Optional toggle: “Notify sender” → on Accept, send confirmation to originating chat
- [ ] Ledger write on Accept
  - Type: `DEPOSIT` or `WITHDRAWAL`
  - Amount rules: withdrawals stored as negative native
  - FX snapshot captured at approval time
  - Created_by: `local_user` or operator name if available
- [ ] UX & Validation
  - Confirm dialog before Accept/Reject
  - Error banner on DB failure
  - Empty state when no drafts
- [ ] Observability
  - Log accept/reject events with draft id and resulting ledger id
  - If notify enabled, log Telegram message id / error

## Tasks / Subtasks

- [x] UI: Add approvals table to existing admin/operations page
- [x] Service: Provide list/accept/reject for `funding_drafts` (DB-backed preferred)
- [x] Integrate FX and ledger write using existing patterns
- [x] Telegram notifier helper (optional toggle)

## Dev Agent Record

- Agent Model Used: gpt-5-codex
- Debug Log References:
  - `pytest tests/unit/test_funding_service.py tests/unit/test_telegram_notifier.py tests/integration/test_telegram_approval_workflow.py`
  - Streamlit logs `telegram_draft_accepted_via_ui`, `telegram_draft_notification_sent`, `telegram_draft_notification_failed`
- Completion Notes:
  - Added a dedicated Pending Funding (Telegram) panel on the Associate Operations page showing per-draft details, source badge, chat id, and Notify toggle with confirmation dialogs for accept/reject.
  - Extended `FundingService.get_pending_drafts` with an optional source filter so UI layers can query only Telegram-originated drafts.
  - Created `TelegramNotifier` helper with structured logging/error handling; wired optional notifications into acceptance flow and surfaced success/failure alerts.
  - Captured operator identity for ledger writes, ensured safe reruns, and persisted alert feedback plus tests for funding service filtering and notifier behavior.
  - Shifted acceptance to a concurrency-safe `DELETE ... RETURNING` path so drafts are claimed atomically and double approvals throw a clear FundingError instead of duplicating ledger entries.
  - Introduced a Telegram approval workflow service + notification audit repository so every chat attempt (success/failure/missing chat id) is captured in `notification_audit` for manual follow-up.
  - Added integration coverage: a threaded race test around `accept_funding_draft` and a workflow test that simulates notifier failures to verify audit rows and error surfacing.
- File List:
  - src/ui/pages/8_associate_operations.py
  - src/services/funding_service.py
  - src/services/telegram_notifier.py
  - tests/unit/test_funding_service.py
  - tests/unit/test_telegram_notifier.py
  - src/services/telegram_approval_workflow.py
  - src/repositories/notification_audit_repository.py
  - src/core/schema.py
  - tests/integration/test_telegram_approval_workflow.py
- Change Log:
  - 2025-11-08: Implemented Telegram approvals panel with notify toggle, backend filtering support, notifier helper, and unit tests for new logic.
  - 2025-11-08: Hardened approvals with atomic draft claims, notification audit trail/workflow, and targeted integration tests closing QA CONCERNS.

## Dev Notes

- Reuse Story 5.4 patterns but extend to bookmaker‑scoped drafts and include `chat_id`
- Keep append‑only ledger invariant; no edits/deletes
- Consider persistence for drafts to avoid loss on restart
