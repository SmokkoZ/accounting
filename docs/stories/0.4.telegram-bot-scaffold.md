# Story 0.4: Telegram Bot Scaffold

## Status
Approved

## Story
**As an operator**, I want the Telegram bot to receive screenshots and save them locally so I can begin testing ingestion.

## Acceptance Criteria
- [x] Telegram bot token stored in `.env` as `TELEGRAM_BOT_TOKEN`
- [x] Bot runs in polling mode (not webhook) using `python-telegram-bot` v20+
- [x] Bot handles `/start` command: replies "Surebet Bot Ready"
- [x] Bot handles `/help` command: lists available commands
- [x] Bot registers bookmaker chat IDs (manual config or `/register` command)
- [x] Bot handles photo messages:
  - Saves screenshot to `data/screenshots/{timestamp}_{chat_id}.png`
  - Creates placeholder `bets` row with:
    - `status="incoming"`
    - `ingestion_source="telegram"`
    - `telegram_message_id=<message_id>`
    - `associate_id`, `bookmaker_id` (looked up via chat_id)
    - All extracted fields NULL (OCR added in Phase 1)
  - Replies to sender: "Screenshot received. Awaiting OCR processing."
- [x] Bot logs all errors to console
- [x] Bot can be stopped gracefully with Ctrl+C

## Tasks / Subtasks
- [x] Task 1: Set up Telegram bot foundation (AC: 1, 2, 3, 4, 8)
  - [x] Create `src/integrations/telegram_bot.py` with basic bot structure
  - [x] Implement token loading from environment variables
  - [x] Set up polling mode with proper error handling
  - [x] Implement `/start` command handler
  - [x] Implement `/help` command handler
  - [x] Add graceful shutdown handling (Ctrl+C)
- [x] Task 2: Implement chat ID registration system (AC: 5)
  - [x] Create chat ID to associate/bookmaker mapping mechanism
  - [x] Implement `/register` command for chat registration
  - [x] Add validation for registered chat IDs
- [x] Task 3: Implement photo message handling (AC: 6)
  - [x] Add photo message handler to bot
  - [x] Implement screenshot saving to `data/screenshots/` with proper naming
  - [x] Create placeholder `bets` row in database
  - [x] Add reply message to sender
- [x] Task 4: Add error handling and logging (AC: 7)
  - [x] Implement structured logging for bot operations
  - [x] Add error handling for API failures
  - [x] Add error handling for database operations
  - [x] Ensure all errors are logged to console

## Dev Notes

### Previous Story Insights
From story 0.3, we have:
- Database schema created with `bets` table
- SQLite database connection established in `src/core/database.py`
- Decimal precision requirements established for all currency values
- UTC timestamp formatting requirements established

### Data Models
Telegram bot will interact with the `bets` table [Source: docs/prd/data-model.md#406-433]:

Key fields to be populated:
- `associate_id` - Foreign key to associates table
- `bookmaker_id` - Foreign key to bookmakers table
- `status` - Set to "incoming" for new screenshots
- `ingestion_source` - Set to "telegram"
- `telegram_message_id` - Message ID from Telegram for traceability
- `screenshot_path` - Path to saved screenshot file
- `created_at_utc` - Current timestamp in ISO8601 format

All extracted bet fields (event, market, odds, etc.) will remain NULL until OCR is implemented in Epic 1.

### API Specifications
Telegram Bot API requirements [Source: docs/architecture/tech-stack.md#171-185]:

Framework: python-telegram-bot 20.0+
- Use polling mode (not webhook) for simplicity
- Async/await support built on asyncio
- Photo handling via `message.photo[-1].get_file()` for highest resolution
- Message ID available via `message.message_id`

### Component Specifications
No UI components required for this story.

### File Locations
Based on architecture documentation:
- `src/integrations/telegram_bot.py` - Telegram bot implementation [Source: docs/architecture/source-tree.md#310]
- `.env` - Environment variables for bot token [Source: docs/architecture/source-tree.md#35]
- `data/screenshots/` - Screenshot storage directory [Source: docs/architecture/source-tree.md#147]

### Testing Requirements
From testing strategy:
- Create unit tests for Telegram bot handlers [Source: docs/architecture/testing-strategy.md#65]
- Test command handlers (/start, /help, /register)
- Test photo message processing
- Test error handling for API failures
- Target coverage: 80%+ for Telegram bot [Source: docs/architecture/testing-strategy.md#470]

### Technical Constraints
- Use python-telegram-bot 20.0+ with async support [Source: docs/architecture/tech-stack.md#86]
- Store screenshots in `data/screenshots/` directory [Source: docs/architecture/source-tree.md#147]
- All timestamps in UTC ISO8601 with "Z" suffix [Source: docs/architecture/coding-standards.md#198-226]
- Use parameterized queries for all SQL operations [Source: docs/architecture/coding-standards.md#310-320]
- Bot token must be stored in environment variable, not hardcoded [Source: docs/architecture/coding-standards.md#603]

### Project Structure Notes
The Telegram bot implementation should follow the documented source tree:
- Bot implementation in `src/integrations/telegram_bot.py`
- Screenshots saved to `data/screenshots/` directory
- Environment variables in `.env` file
- Unit tests in `tests/unit/test_telegram_bot.py`

## Testing

### Testing Standards
- Use pytest 7.0+ as testing framework [Source: docs/architecture/testing-strategy.md#36]
- Test file naming: `test_` prefix [Source: docs/architecture/coding-standards.md#452-464]
- Test function naming: descriptive names [Source: docs/architecture/coding-standards.md#467-483]
- Follow AAA pattern (Arrange, Act, Assert) [Source: docs/architecture/coding-standards.md#487-501]
- Mock Telegram API calls in unit tests
- Test error handling for API failures
- Test database operations with test database

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Initial story creation | Scrum Master |
| 2025-10-29 | 1.1 | Applied QA fixes - rate limiting, registration storage, chat mapping | James (Dev Agent) |

## Dev Agent Record
### Agent Model Used
glm-4.6

### Debug Log References
- tests/unit/test_telegram_bot.py: Unit tests for Telegram bot functionality
- src/integrations/telegram_bot.py: Main Telegram bot implementation
- src/utils/logging_config.py: Structured logging configuration

### Completion Notes List
- Implemented Telegram bot foundation with python-telegram-bot v20+
- Added token loading from environment variables
- Set up polling mode with proper error handling
- Implemented /start, /help, and /register command handlers
- Added graceful shutdown handling (Ctrl+C)
- Implemented chat ID registration system with associate/bookmaker validation
- Implemented photo message handling with screenshot saving
- Created placeholder bet records in database
- Added comprehensive error handling and structured logging
- All acceptance criteria met

### QA Fixes Applied (2025-10-29)
- Implemented rate limiting for bot commands to prevent API abuse
- Added registration storage in database with new chat_registrations table
- Implemented chat ID to associate/bookmaker mapping functionality
- Updated tests to cover new rate limiting and registration features
- Fixed all TODO items identified in QA review

### Development Challenges and Solutions
1. **Database Schema Mismatch** - Initial tests failed because the bets table was missing telegram_message_id and ingestion_source columns
   - **Solution**: Updated src/core/schema.py to add these columns with proper constraints
   
2. **Test Mocking Issues** - Tests were using real database connection instead of mocks
   - **Solution**: Fixed test fixtures to properly patch get_db_connection function with mock objects
   
3. **Async/Await Pattern Issues** - Photo message handler had incorrect async patterns
   - **Solution**: Updated mock objects to properly simulate async behavior with AsyncMock

4. **Foreign Key Constraint Errors** - Tests failed due to missing seed data in database
   - **Solution**: Recreated database with updated schema to ensure proper foreign key relationships

### File List
- src/integrations/telegram_bot.py: Main Telegram bot implementation
- src/utils/logging_config.py: Structured logging configuration
- tests/unit/test_telegram_bot.py: Unit tests for Telegram bot functionality
- src/core/schema.py: Updated bets table schema with telegram_message_id and ingestion_source columns, added chat_registrations table

## QA Results

### Review Date: 2025-10-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The Telegram Bot implementation demonstrates excellent software engineering practices with well-structured code, proper error handling, and comprehensive logging. The implementation follows async/await patterns correctly and maintains proper database connection management. The code is well-documented with clear comments explaining the functionality. All previous concerns have been fully addressed.

### Refactoring Performed

No refactoring was performed during this review as the code quality is already high and follows best practices.

### Compliance Check

- Coding Standards: ✓ (Follows project standards with proper error handling and logging)
- Project Structure: ✓ (Files correctly placed in src/integrations/, tests/unit/, and src/utils/)
- Testing Strategy: ✓ (Comprehensive unit tests with 80%+ coverage)
- All ACs Met: ✓ (All acceptance criteria fully implemented)

### Improvements Checklist

- [x] Verified all acceptance criteria are implemented
- [x] Confirmed proper error handling throughout the codebase
- [x] Validated test coverage meets requirements
- [x] Implemented proper registration storage in database
- [x] Implemented chat ID to associate/bookmaker mapping
- [x] Added rate limiting for bot commands to prevent abuse
- [x] Removed hardcoded default values for associate_id and bookmaker_id

### Security Review

**Status: PASS**

- Rate limiting implemented for bot commands (2-second minimum between commands)
- Bot token is properly stored in environment variables ✓
- Input validation is implemented for command arguments ✓
- SQL injection protection through parameterized queries ✓

### Performance Considerations

**Status: PASS**

- Efficient async implementation prevents blocking operations
- Database connections are properly managed and closed
- File operations use appropriate streaming for downloads
- Rate limiting prevents resource exhaustion

### Files Modified During Review

No files were modified during this review.

### Gate Status

Gate: PASS (Updated from previous CONCERNS)
- Previous concerns about rate limiting, registration storage, and chat mapping have been fully addressed
- Implementation now includes comprehensive rate limiting (2-second minimum between commands)
- Registration system properly stores chat-to-associate/bookmaker mappings in database
- Default values are now handled through the registration system instead of hardcoding

Risk profile: docs/qa/assessments/0.4.telegram-bot-scaffold-risk-20251029.md
NFR assessment: docs/qa/assessments/0.4.telegram-bot-scaffold-nfr-20251029.md

Note: Gate file (docs/qa/gates/0.4.telegram-bot-scaffold.yml) should be updated to reflect PASS status

### Recommended Status

[✓ Ready for Done]

All QA concerns have been addressed:
- Rate limiting implemented for bot commands (2-second minimum between commands)
- Registration storage implemented in database with proper validation
- Chat ID to associate/bookmaker mapping implemented with fallback handling
- Tests updated to cover new functionality including rate limiting
- Default values properly handled through registration system