# Story 5.4: Pending Funding Events

## Status: Draft

## Story

**As the operator**, I want to review and approve deposit/withdrawal events so associate balances reflect cash movements.

## Acceptance Criteria

- [ ] "Pending Funding" section at top of Reconciliation page

  **Manual Entry Form** (for MVP, no Telegram auto-capture):
  - **Associate selector**: Dropdown
  - **Event type**: Radio buttons (DEPOSIT | WITHDRAWAL)
  - **Amount**: Number input (native currency, positive only)
  - **Currency selector**: Dropdown
  - **Note**: Optional text field (e.g., "Bank transfer from Partner A")
  - **"Add Funding Event" button**: Creates draft entry

- [ ] Pending funding list:
  - Shows draft entries (in-memory or separate `funding_drafts` table)
  - Display: timestamp, associate, type, amount, currency, note
  - Actions: **Accept** | **Reject** buttons

- [ ] On "Accept":
  - Get current FX rate: `fx_rate = get_fx_rate(currency, today)`
  - Insert `ledger_entries` row:
    ```sql
    INSERT INTO ledger_entries (
      entry_type,            -- 'DEPOSIT' or 'WITHDRAWAL'
      associate_id,
      bookmaker_id,          -- NULL (funding is associate-level, not bookmaker-specific)
      surebet_id,            -- NULL
      bet_id,                -- NULL
      settlement_state,      -- NULL
      amount_native,         -- from form (positive for DEPOSIT, negative for WITHDRAWAL)
      native_currency,       -- from form
      fx_rate_snapshot,      -- current rate
      amount_eur,            -- amount_native * fx_rate_snapshot
      principal_returned_eur,-- NULL
      per_surebet_share_eur, -- NULL
      settlement_batch_id,   -- NULL
      created_at_utc,        -- current timestamp
      created_by,            -- 'local_user'
      note                   -- from form
    ) VALUES (...)
    ```
  - Remove from drafts list
  - Success message: "Funding event accepted. Ledger entry created."
  - Reconciliation dashboard updates immediately (NET_DEPOSITS_EUR changes)

- [ ] On "Reject":
  - Remove from drafts list
  - No ledger write
  - Success message: "Funding event discarded."

- [ ] Funding history (below form):
  - Show recent accepted DEPOSIT/WITHDRAWAL rows (last 30 days)
  - Display: timestamp, associate, type, amount (native + EUR), note

## Dev Notes

### Previous Story Insights

From Story 5.2 (Reconciliation Dashboard Associate View):
- Reconciliation calculations for NET_DEPOSITS_EUR using DEPOSIT/WITHDRAWAL ledger entries [Source: docs/stories/5.2.reconciliation-dashboard-associate-view.md#NET_DEPOSITS_EUR-Calculation]
- ReconciliationService patterns for associate health calculations [Source: docs/stories/5.2.reconciliation-dashboard-associate-view.md#ReconciliationService-Class]
- DELTA calculations that will be affected by funding events [Source: docs/stories/5.2.reconciliation-dashboard-associate-view.md#DELTA-Calculation]

From Story 5.1 (Post-Settlement Correction Interface):
- Ledger entry creation patterns with FX rate snapshots [Source: docs/stories/5.1.post-settlement-correction-interface.md#FX-Rate-Management]
- Form validation and error handling patterns [Source: docs/stories/5.1.post-settlement-correction-interface.md#Form-Validation]
- Success message and UI feedback patterns [Source: docs/stories/5.1.post-settlement-correction-interface.md#UI-Feedback-Patterns]

### Data Models

**ledger_entries table** [Source: docs/architecture/data-architecture.md#ledger_entries-CRITICAL-TABLE]:
```sql
CREATE TABLE ledger_entries (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    type TEXT NOT NULL CHECK (type IN ('BET_RESULT', 'DEPOSIT', 'WITHDRAWAL', 'BOOKMAKER_CORRECTION')),
    associate_id INTEGER NOT NULL REFERENCES associates(id),
    bookmaker_id INTEGER REFERENCES bookmakers(id),  -- NULL for DEPOSIT/WITHDRAWAL
    amount_native TEXT NOT NULL,
    native_currency TEXT NOT NULL,
    fx_rate_snapshot TEXT NOT NULL,
    amount_eur TEXT NOT NULL,
    settlement_state TEXT CHECK (settlement_state IN ('WON', 'LOST', 'VOID') OR settlement_state IS NULL),
    principal_returned_eur TEXT,
    per_surebet_share_eur TEXT,
    surebet_id INTEGER REFERENCES surebets(id),
    bet_id INTEGER REFERENCES bets(id),
    settlement_batch_id TEXT,
    created_at_utc TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ', 'now')),
    created_by TEXT NOT NULL DEFAULT 'local_user',
    note TEXT
);
```

**associates table** [Source: docs/architecture/data-architecture.md#associates]:
```sql
CREATE TABLE associates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    display_alias TEXT NOT NULL UNIQUE,
    is_admin INTEGER NOT NULL DEFAULT 0,
    created_at_utc TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ', 'now')),
    note TEXT
);
```

### Funding Service

**FundingService Class** [Source: docs/prd/epic-5-implementation-guide.md#Task-5.4.1]:
```python
@dataclass
class FundingDraft:
    """Draft funding event awaiting approval."""
    draft_id: str  # UUID for in-memory tracking
    associate_id: int
    associate_alias: str
    event_type: str  # 'DEPOSIT' or 'WITHDRAWAL'
    amount_native: Decimal
    currency: str
    note: Optional[str]
    created_at_utc: str

class FundingService:
    """Service for managing funding events and draft approval workflow."""
    
    def __init__(self, ledger_repo: LedgerEntryRepository, fx_manager: FXManager):
        self.ledger_repo = ledger_repo
        self.fx_manager = fx_manager
        self._drafts: Dict[str, FundingDraft] = {}  # In-memory draft storage
    
    def create_funding_draft(self, associate_id: int, event_type: str, 
                           amount_native: Decimal, currency: str, 
                           note: Optional[str] = None) -> str:
        """Create a funding draft and return draft ID."""
        
    def get_pending_drafts(self) -> List[FundingDraft]:
        """Get all pending funding drafts."""
        
    def accept_funding_draft(self, draft_id: str) -> str:
        """Accept draft and create ledger entry. Returns ledger entry ID."""
        
    def reject_funding_draft(self, draft_id: str) -> None:
        """Remove draft without creating ledger entry."""
        
    def get_funding_history(self, days: int = 30) -> List[Dict]:
        """Get recent accepted funding events for history display."""
```

### File Locations

Based on architecture documentation:
- `src/services/funding_service.py` - Core funding event management logic [Source: docs/architecture/backend-architecture.md#Service-Layer]
- `src/ui/components/reconciliation/pending_funding.py` - Pending funding form and list component
- `src/ui/pages/6_reconciliation.py` - Extended reconciliation page with funding section [Source: docs/architecture/frontend-architecture.md#Streamlit-Pages]
- `src/repositories/ledger_entry_repository.py` - Repository for ledger_entries table operations [Source: docs/architecture/backend-architecture.md#Repository-Layer]

### Technical Constraints

**Funding Draft Storage** [Source: docs/prd/epic-5-implementation-guide.md#Task-5.4.1]:
```python
# In-memory draft storage (session-based)
class FundingService:
    def __init__(self):
        self._drafts: Dict[str, FundingDraft] = {}  # UUID -> draft
        
    def create_funding_draft(self, associate_id: int, event_type: str, 
                           amount_native: Decimal, currency: str, 
                           note: Optional[str] = None) -> str:
        """Create draft with UUID for tracking."""
        draft_id = str(uuid.uuid4())
        
        # Validate amount must be positive
        if amount_native <= 0:
            raise ValueError("Amount must be positive")
            
        # Validate event type
        if event_type not in ['DEPOSIT', 'WITHDRAWAL']:
            raise ValueError("Invalid event type")
            
        draft = FundingDraft(
            draft_id=draft_id,
            associate_id=associate_id,
            event_type=event_type,
            amount_native=amount_native,
            currency=currency,
            note=note,
            created_at_utc=utc_now_iso()
        )
        
        self._drafts[draft_id] = draft
        return draft_id
```

**Ledger Entry Creation for Funding** [Source: docs/prd/epic-5-implementation-guide.md#Task-5.4.2]:
```python
def accept_funding_draft(self, draft_id: str) -> str:
    """Accept draft and create ledger entry with FX snapshot."""
    draft = self._drafts.get(draft_id)
    if not draft:
        raise ValueError("Draft not found")
    
    # Get current FX rate
    fx_rate = self.fx_manager.get_fx_rate(draft.currency, date.today())
    
    # Calculate amount (negative for withdrawals)
    amount_native = draft.amount_native
    if draft.event_type == 'WITHDRAWAL':
        amount_native = -amount_native
    
    # Create ledger entry
    ledger_id = self.ledger_repo.insert_ledger_entry(
        entry_type=draft.event_type,
        associate_id=draft.associate_id,
        bookmaker_id=None,  # Funding is associate-level
        amount_native=amount_native,
        native_currency=draft.currency,
        fx_rate_snapshot=fx_rate,
        amount_eur=amount_native * fx_rate,
        note=draft.note
    )
    
    # Remove draft
    del self._drafts[draft_id]
    
    return ledger_id
```

**FX Rate Management** [Source: docs/architecture/data-architecture.md#fx_rates_daily-Cache-Strategy]:
```python
# Get current FX rate for funding events
def get_fx_rate(self, currency: str, date: date) -> Decimal:
    """Get FX rate for currency on specific date."""
    
    # Try to get today's rate from cache
    today_str = date.strftime('%Y-%m-%d')
    rate_row = self.db.execute(
        "SELECT eur_per_unit FROM fx_rates_daily WHERE currency = ? AND rate_date = ?",
        (currency, today_str)
    ).fetchone()
    
    if rate_row:
        return Decimal(rate_row['eur_per_unit'])
    
    # If no rate for today, fetch from API
    return self.fetch_fx_rate_from_api(currency)
```

### Integration Points

**Upstream Dependencies**:
- Epic 0 (Foundation): FX rate system for currency conversion
- Epic 7 (User Management): Associates reference data for dropdown

**Downstream Consumers**:
- Story 5.5 (Associate Operations Hub): May reuse funding service for inline deposits/withdrawals
- Epic 6 (Reporting): Uses funding history for monthly statements

**UI Integration**:
- Extension of existing reconciliation page (src/ui/pages/6_reconciliation.py)
- Integration with ReconciliationService for real-time NET_DEPOSITS_EUR updates
- Session state management for draft persistence across page reruns

### Calculation Examples

**Example 1: Deposit Event**
```
Associate: Partner A
Event Type: DEPOSIT
Amount: 1000 AUD
Current FX Rate: 1 AUD = 0.65 EUR
Ledger Entry:
- entry_type: 'DEPOSIT'
- amount_native: 1000.00
- native_currency: 'AUD'
- fx_rate_snapshot: 0.65
- amount_eur: 650.00
Impact on Reconciliation:
- NET_DEPOSITS_EUR: increases by +650.00
- CURRENT_HOLDING_EUR: increases by +650.00
- DELTA: becomes more negative (short) until funds placed as bets
```

**Example 2: Withdrawal Event**
```
Associate: Partner B
Event Type: WITHDRAWAL
Amount: 500 EUR
Ledger Entry:
- entry_type: 'WITHDRAWAL'
- amount_native: -500.00
- native_currency: 'EUR'
- fx_rate_snapshot: 1.00
- amount_eur: -500.00
Impact on Reconciliation:
- NET_DEPOSITS_EUR: decreases by -500.00
- CURRENT_HOLDING_EUR: decreases by -500.00
- DELTA: becomes more positive (overholding) if not balanced
```

## Tasks / Subtasks

- [ ] Task 1: Create FundingService Core Logic
  - [ ] Implement FundingDraft dataclass with all required fields
  - [ ] Build FundingService class with in-memory draft storage
  - [ ] Add create_funding_draft method with validation
  - [ ] Implement get_pending_drafts method for UI display
  - [ ] Add get_funding_history method for history display

- [ ] Task 2: Build Ledger Entry Integration
  - [ ] Implement accept_funding_draft method with FX rate fetching
  - [ ] Add proper amount sign handling (negative for withdrawals)
  - [ ] Create ledger entry with correct null fields (bookmaker_id, bet_id, etc.)
  - [ ] Implement reject_funding_draft method
  - [ ] Add error handling for invalid drafts

- [ ] Task 3: Create Pending Funding UI Component
  - [ ] Build pending_funding component with manual entry form
  - [ ] Implement associate dropdown populated from associates table
  - [ ] Add event type radio buttons (DEPOSIT/WITHDRAWAL)
  - [ ] Create amount and currency input fields with validation
  - [ ] Add optional note field and "Add Funding Event" button

- [ ] Task 4: Build Draft Management Interface
  - [ ] Create pending funding list display with draft details
  - [ ] Implement Accept/Reject buttons for each draft
  - [ ] Add confirmation dialogs for accept/reject actions
  - [ ] Show success/error messages for draft operations
  - [ ] Handle draft removal after action

- [ ] Task 5: Integrate with Reconciliation Page
  - [ ] Add "Pending Funding" section to reconciliation page
  - [ ] Integrate with ReconciliationService for real-time updates
  - [ ] Ensure NET_DEPOSITS_EUR recalculates after funding acceptance
  - [ ] Add funding history display below form
  - [ ] Test page refresh and session state persistence

- [ ] Task 6: Add Validation and Error Handling
  - [ ] Validate amount must be positive
  - [ ] Add associate and currency validation
  - [ ] Handle FX rate unavailable scenarios
  - [ ] Add database transaction rollback for ledger failures
  - [ ] Implement proper logging for funding operations

## Testing

### Testing Standards

**Test Framework** [Source: docs/architecture/testing-strategy.md#Unit-Testing]:
- Use pytest 7.0+ as testing framework
- Test file naming: `test_` prefix
- Test function naming: descriptive names (e.g., `test_funding_draft_creation()`)

**Test Structure** [Source: docs/architecture/testing-strategy.md#Test-Organization]:
```
tests/
├── unit/
│   ├── test_funding_service.py           # Core funding service tests
│   └── test_funding_validation.py       # Input validation tests
└── integration/
    └── test_funding_workflow.py         # End-to-end funding workflow
```

**Key Test Scenarios**:
```python
def test_funding_draft_creation():
    """Test draft creation with valid inputs"""
    
def test_funding_draft_validation_negative_amount():
    """Test draft creation rejects negative amounts"""
    
def test_accept_deposit_draft_creates_ledger_entry():
    """Test accepting deposit draft creates correct ledger entry"""
    
def test_accept_withdrawal_draft_creates_negative_ledger_entry():
    """Test accepting withdrawal draft creates negative ledger entry"""
    
def test_reject_funding_draft_removes_draft():
    """Test rejecting draft removes it without creating ledger entry"""
    
def test_fx_rate_fallback_for_funding():
    """Test funding uses current FX rate with API fallback"""
    
def test_funding_updates_reconciliation_calculations():
    """Test accepted funding updates NET_DEPOSITS_EUR correctly"""
    
def test_funding_history_display():
    """Test funding history shows correct recent entries"""
```

**UI Testing Approach** [Source: docs/architecture/testing-strategy.md#Integration-Testing]:
For Streamlit pending funding interface:
1. **Unit tests** for FundingService business logic
2. **Unit tests** for form validation and draft management
3. **Integration tests** for complete funding workflow
4. **Manual testing** for form interaction and reconciliation updates

### Test Data Requirements

**Required Test Fixtures**:
- Multiple associates with different currencies
- Various FX rates for different dates
- Existing ledger entries for reconciliation testing
- Edge cases: missing FX rates, invalid associates, negative amounts

**Funding Draft Test Scenarios**:
- Valid deposit and withdrawal drafts
- Invalid drafts (negative amounts, invalid event types)
- Draft acceptance with FX rate available/unavailable
- Draft rejection scenarios
- Multiple drafts for same associate

## Change Log

### 2025-11-04T08:18:00Z - Initial Draft

- Created story 5.4 with comprehensive acceptance criteria for pending funding events
- Integrated with existing reconciliation dashboard (Story 5.2) for real-time updates
- Defined FundingService with draft management and ledger integration
- Established funding-specific ledger entry patterns with FX rate snapshots
- Added form validation and error handling requirements
- Comprehensive test coverage plan for funding workflow and validation
