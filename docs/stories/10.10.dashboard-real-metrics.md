# Story 10.10: Dashboard Real Metrics

## Status
Ready for Review

## Story
**As a** operator,
**I want** the Dashboard to show real counts for waiting incoming bets, approved bets today, open surebets, and pending settlements instead of demo metrics,
**so that** I can see accurate operational status and make informed decisions.

## Acceptance Criteria
1. Dashboard cards replace demo data with actual counts for waiting incoming bets, approved bets today, open surebets, and pending settlements using the existing queries that feed the Incoming Bets and Surebets pages.
2. Cards refresh automatically when the fragments-supported auto-refresh fires, reusing the same interval as the incoming queue and showing when the last refresh occurred.
3. Metrics reference the renamed "Settlement" nav and link to the appropriate pages.
4. The dashboard hosts action buttons for operational starters (send global Telegram statements, fetch FX rates, and other high-value actions) so operators can trigger them immediately when triage begins.

## Tasks / Subtasks
- [x] Implement real metric queries for dashboard cards (AC: #1)
  - [x] Replace demo metric generator with real queries
  - [x] Create query for waiting incoming bets count
  - [x] Create query for approved bets today count
  - [x] Create query for open surebets count
  - [x] Create query for pending settlements count
  - [x] Use existing queries from Incoming Bets and Surebets pages
  - [x] Reference dashboard placeholder at `src/ui/pages/0_dashboard.py:26`
- [x] Implement automatic refresh functionality (AC: #2)
  - [x] Wire cards to incoming queue refresh signal
  - [x] Implement fragment-supported auto-refresh for dashboard
  - [x] Reuse same interval as incoming queue
  - [x] Add last refresh timestamp display in UI
  - [x] Reference incoming queue work at `src/ui/pages/1_incoming_bets.py`
  - [x] Ensure refresh occurs when fragments are supported
- [x] Update navigation references and links (AC: #3)
  - [x] Update metrics to reference renamed "Settlement" navigation
  - [x] Add links from dashboard cards to appropriate pages
  - [x] Ensure navigation consistency across dashboard
  - [x] Test navigation flows from dashboard metrics
- [x] Add operational action buttons (AC: #4)
  - [x] Implement send global Telegram statements button
  - [x] Add fetch FX rates action button
  - [x] Add other high-value operational actions
  - [x] Position action buttons for easy operator access during triage
  - [x] Add confirmation dialogs for critical actions

## Dev Notes
- Reference existing dashboard placeholder at `src/ui/pages/0_dashboard.py:26`
- Reference incoming queue implementation at `src/ui/pages/1_incoming_bets.py`
- Provide a fallback count display when the query fails to avoid blank cards
- Consider performance implications of real-time dashboard queries
- Ensure dashboard refresh doesn't conflict with other auto-refresh mechanisms
- Test dashboard behavior under various load conditions

### Testing
- Test file locations:
  - `tests/integration/test_telegram_approval_workflow.py`
  - `tests/unit/test_dashboard_real_metrics.py`
- Test standards: Follow existing unit test patterns in the codebase
- Testing frameworks: pytest with dashboard component testing
- Update `tests/integration/test_telegram_approval_workflow.py:1` or navigation tests to assert dashboard metric refresh after a bet is approved
- Test real-time metric updates when data changes
- Verify dashboard refresh functionality with fragment support
- Test navigation links from dashboard cards
- Test operational action buttons functionality
- Verify fallback display when queries fail
- Test dashboard performance with multiple concurrent queries

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-10 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-11-11 | 1.1 | Replaced demo dashboard with live metrics, auto-refresh, and operational starters | James (Dev) |

## Dev Agent Record
### Agent Model Used
Codex GPT-5 (dev)

### Debug Log References
- `pytest tests/unit/test_dashboard_real_metrics.py`
- `pytest tests/integration/test_telegram_approval_workflow.py`

### Completion Notes List
- Added `src/ui/services/dashboard_metrics.py` to centralize the incoming queue and surebet count queries reused by the dashboard.
- Rebuilt `src/ui/pages/0_dashboard.py` to render real metrics, link to Incoming/Surebets/Settlement nav targets, and show refresh cadence + timestamp.
- Added Streamlit fragment auto-refresh wiring that mirrors the incoming queue interval with graceful fallback when fragments are unavailable.
- Implemented operational action buttons (Telegram statements, FX rates fetch, surebet matcher sweep) with confirmation dialogs, spinners, and success/error feedback.
- Created targeted unit and integration tests to validate metric aggregation and live refresh behavior after bet approvals.

### File List
- `src/ui/pages/0_dashboard.py`
- `src/ui/services/__init__.py`
- `src/ui/services/dashboard_metrics.py`
- `tests/unit/test_dashboard_real_metrics.py`
- `tests/integration/test_telegram_approval_workflow.py`

## QA Results
<!-- To be populated by QA agent -->
