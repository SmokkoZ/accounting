# Story 9.3: Per‑Chat Balance & Pending Message Button

## Status
Draft

## Story
As an admin, I want a one‑click button in Streamlit to send the current bookmaker balance and pending balance to the registered Telegram chat so associates have clear visibility.

## Acceptance Criteria

- [ ] Button appears in bookmaker context (e.g., Bookmaker drilldown or Balance tab)
- [ ] Message format (exact):
  - `DD/MM/YY Balance: <balance_native> <CUR>, pending balance: <pending_native> <CUR>.`
  - Date based on server local date; use leading zeros; 2‑digit year
- [ ] Balance value
  - Latest `bookmaker_balance_checks` for `(associate_id, bookmaker_id)`
  - If none, send `Balance: N/A` but still include pending
- [ ] Pending balance definition
  - Sum of stake amounts for bets where `(associate_id, bookmaker_id)` and `status IN ('verified','matched')`
  - Exclude `incoming` and `settled`
  - Display in associate `home_currency`; convert from EUR if needed
- [ ] Delivery
  - Look up `chat_id` from `chat_registrations`
  - Send via Telegram; show success/failure toast in UI
- [ ] Observability
  - Log sent message with chat_id, associate_alias, bookmaker_name, amounts
  - Log and surface Telegram API errors

## Tasks / Subtasks

- [ ] Add service function to compute pending balance per bookmaker
- [ ] Add UI button in relevant page (Bookmaker/Balance)
- [ ] Add Telegram send helper (reuse bot application or HTTP API)
- [ ] Unit tests for calculation and message template

## Dev Notes

- `BookmakerBalanceService` already computes modeled balances; add a helper for pending stakes from `bets`
- Use `fx_manager` for conversions when needed
- Keep message short to reduce spam likelihood

