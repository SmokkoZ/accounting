# Story 9.3: Per‑Chat Balance & Pending Message Button

## Status
Ready for Review

## Story
As an admin, I want a one‑click button in Streamlit to send the current bookmaker balance and pending balance to the registered Telegram chat so associates have clear visibility.

## Acceptance Criteria

- [ ] Button appears in bookmaker context and dashboard (e.g., Bookmaker drilldown or Balance tab)
- [ ] Message format (exact):
  - `DD/MM/YY Balance: <balance_native> <CUR>, pending balance: <pending_native> <CUR>.`
  - Date based on server local date; use leading zeros; 2‑digit year
- [ ] Balance value
  - Latest `bookmaker_balance_checks` for `(associate_id, bookmaker_id)`
  - If none, send `Balance: N/A` but still include pending
- [ ] Pending balance definition
  - Sum of stake amounts for bets where `(associate_id, bookmaker_id)` and `status IN ('verified','matched')`
  - Exclude `incoming` and `settled`
  - Display in associate `home_currency`; convert from EUR if needed
- [ ] Delivery
  - Look up `chat_id` from `chat_registrations`
  - Send via Telegram; show success/failure toast in UI
- [ ] Observability
  - Log sent message with chat_id, associate_alias, bookmaker_name, amounts
  - Log and surface Telegram API errors

## Tasks / Subtasks

- [x] Add service function to compute pending balance per bookmaker
- [x] Add UI button in relevant page (Bookmaker/Balance)
- [x] Add Telegram send helper (reuse bot application or HTTP API)
- [x] Unit tests for calculation and message template

## Dev Notes

- `BookmakerBalanceService` already computes modeled balances; add a helper for pending stakes from `bets`
- Use `fx_manager` for conversions when needed
- Keep message short to reduce spam likelihood

## Dev Agent Record

- Agent Model Used: gpt-5-codex
- Debug Log References:
  - `pytest tests/unit/test_bookmaker_balance_service.py`
- Completion Notes:
  - Added pending-stake aggregation plus balance message builder to `BookmakerBalanceService`, sharing the active DB connection for FX lookups to keep conversions consistent in tests and runtime.
  - Implemented Streamlit button + helper to share balances via Telegram with chat lookup, toast feedback, and notifier error handling/logging.
  - Logged sent payloads (chat, associate, bookmaker, amounts) and surfaced API failures directly in the UI to meet observability requirements.
- File List:
  - src/services/bookmaker_balance_service.py
  - src/ui/components/associate_hub/drawer.py
  - tests/unit/test_bookmaker_balance_service.py
  - docs/stories/9.3.per-chat-balance-and-pending-message.md
- Change Log:
  - Added pending balance summary + Telegram message builder plus FX lookup reuse inside `BookmakerBalanceService` with accompanying unit tests.
  - Wired a `Send balance to Telegram` button into the Associate Operations balance tab with toast/logging workflow for chat-registered bookmakers.

## QA Results

### Risk Assessment
- **Complexity**: 3/5
- **Data Sensitivity**: Medium
- **Integration Risk**: 3/5
- **Overall Risk Score**: 9 (Medium)

### NFR Analysis
- **Security**: PASS
- **Performance**: PASS
- **Reliability**: CONCERNS
- **Usability**: PASS
- **Maintainability**: PASS

### Test Strategy
- **Unit Tests**: Comprehensive coverage implemented for balance calculations and message formatting
- **Integration Tests**: Critical paths identified for Telegram integration and FX conversion
- **E2E Tests**: Workflow validation needed for complete button-to-telegram flow
- **Edge Cases**: Boundary conditions for missing balances, FX rate failures, chat registration issues

### Requirements Traceability
- **AC1**: ✅ Mapped to UI button implementation in Associate Operations drawer
- **AC2**: ✅ Mapped to message formatting tests in BookmakerBalanceService
- **AC3**: ✅ Mapped to balance lookup logic and N/A handling
- **AC4**: ✅ Mapped to pending balance calculation with FX conversion
- **AC5**: ✅ Mapped to Telegram integration with toast feedback
- **AC6**: ✅ Mapped to comprehensive logging and error handling

### Quality Gate Decision
- **Decision**: CONCERNS
- **Risk Score**: 9
- **Rationale**: Implementation meets functional requirements with good unit test coverage, but reliability concerns exist due to external Telegram API dependency and potential FX rate lookup failures. Error handling is present but could be more robust for edge cases.
- **Recommendations**:
  1. Add integration tests for Telegram API failure scenarios
  2. Implement retry logic for transient Telegram failures
  3. Add validation for FX rate availability before message generation
  4. Consider fallback behavior when chat registration is missing
  5. Add E2E tests for complete user workflow

**QA Engineer**: Quinn - Test Architect
**Date**: 2025-11-08T11:12:00Z
