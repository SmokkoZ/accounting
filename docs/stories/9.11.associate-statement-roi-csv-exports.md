# Story 9.11: Associate Statement & ROI CSV Exports - Brownfield Addition

## User Story
As an operations admin,
I want to export “Statement” and “Per-Surebet ROI” CSVs per associate with an optional “As of” filter,
So that associates receive payout-oriented statements they can reconcile quickly without changing our accounting model.

## Story Context
**Existing System Integration:**

- Integrates with: `StatementService` (read-side calculations) and Streamlit `pages/6_statements.py`
- Technology: Python 3.11, SQLite (ledger), Streamlit UI, CSV exports stored under `data/exports/`
- Follows pattern: Existing per-associate statement calculations, ledger read queries, Streamlit download buttons
- Touch points: Ledger queries (`ledger_entries`), statement summary UI/export, docs/examples sample files

## Acceptance Criteria

**Functional Requirements:**
1. `StatementService.export_statement_csv(associate_id, as_of_utc)` produces Statement CSV with:
   - Header block (Associate / As of (UTC) / Generated / Note) where the note reads “Totals in EUR. Native shown for reference. FX frozen at posting time.”
   - Bookmaker table columns (in order): `Bookmaker, Balance Native, , CCY, Balance EUR, CCY_EUR` with title-case names, blank row between header and summary, and “EURO” fixed in the EUR currency column.
   - Summary block (EUR only) listing `LIQUIDITA - <REGION>`, `MULTIBOOK - <REGION>`, `BALANCE  - <REGION>`, and `UTILE A TESTA` rows (all two decimal EUR values).
2. `StatementService.export_surebet_roi_csv(associate_id, as_of_utc)` produces Per-Surebet ROI CSV with surebet_id, settled timestamp, associate stake/profit/ROI%, and group stake/profit/ROI% for fully settled surebets only.
3. Both exports accept optional `as_of_utc`; every aggregate (balances, should hold, deposits, stakes, results) filters on `created_at_utc <= as_of_utc` consistently; header block lists Associate, As-of UTC, Generated timestamp.

**Integration Requirements:**
4. Existing Statement math (raw profit, should-hold, net deposits) continues unchanged and is reused (no duplicate calculations); proportional targets default to 0 when total balance is 0.
5. New CSV buttons are wired into `pages/6_statements.py` without breaking existing summary export or daily statement actions; filenames follow `legacy_statement_{alias}_{YYYY-MM-DD}.csv` and `surebet_roi_{alias}_{YYYY-MM-DD}.csv`.
6. ROI CSV groups handle VOID legs and multi-leg surebets, skip/blank ROI when stake is zero, and exclude partially settled surebets (or mark them clearly per UX note).

**Quality Requirements:**
7. Rounding only happens on export (2 decimals, |x| < 0.01 displayed as 0.00, no “-0.00”); calculations keep Decimal precision internally.
8. Unit/integration tests cover VOID/WON/LOST mixes across multiple bookmakers and confirm profit == should_hold − net_deposits, sum(target_should_hold) ~= should_hold, and ROI percentages avoid division by zero.
9. Sample CSVs (`docs/examples/statement_A123_YYYY-MM-DD.csv`, `docs/examples/surebet_roi_A123_YYYY-MM-DD.csv`) checked in and documentation updated to mention the new exports and fees/taxes note.

## Technical Notes
- **Integration Approach:** Extend `StatementService` with two export helpers that reuse its existing calculators plus new ROI aggregation queries (BET_RESULT + BET_STAKE grouped by surebet_id) and return bytes for Streamlit download buttons; UI calls service methods and saves to `data/exports/statements`. Statement CSVs emit the new header copy (“Totals in EUR…”), list per-bookmaker balances in native + EUR with legacy CCY columns, and end with the LIQUIDITA/MULTIBOOK/BALANCE/UTILE summary rows (all EUR control totals).
- `multibook_eur` control line is derived from BET_STAKE rows across fully settled surebets (group-wide stakes minus the associate’s stake) up to the cutoff to highlight net counterpart funding.
- **Existing Pattern Reference:** Follow `generate_statement_summary_csv` + ledger CSV export patterns for filename slugging, download buttons, and `tests/integration/test_statement_flow.py`.
- **Key Constraints:** Read-only change; no schema edits; optional composite index `idx_ledger_assoc_type_date` may be added if query plans regress; ROI rows require all legs settled ≤ cutoff.

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Documentation updated if applicable

## Risk and Compatibility Check
- **Primary Risk:** Diverging math between CSV exports and on-screen statements leading to reconciliation mismatches.
- **Mitigation:** Reuse `StatementService` calculations, add regression tests asserting profit identities, and document any fee/tax interpretations directly in CSV headers.
- **Rollback:** Revert the new service methods/UI buttons and remove sample files; no schema or data mutations make rollback trivial.

**Compatibility Verification:**
- [ ] No breaking changes to existing APIs
- [ ] Database changes (if any) are additive only
- [ ] UI changes follow existing design patterns
- [ ] Performance impact is negligible

## Validation Checklist

**Scope Validation:**
- [ ] Story can be completed in one development session
- [ ] Integration approach is straightforward
- [ ] Follows existing patterns exactly
- [ ] No design or architecture work required

**Clarity Check:**
- [ ] Story requirements are unambiguous
- [ ] Integration points are clearly specified
- [ ] Success criteria are testable
- [ ] Rollback approach is simple

## Status
Ready for Review

## Tasks / Subtasks
- [x] Implement `StatementService.export_statement_csv`/`export_surebet_roi_csv` helpers that reuse existing calculators, add ROI aggregation queries, enforce cutoff filtering, and emit slugged filenames with export-only rounding.
- [x] Wire new Streamlit buttons plus ZIP flow reuse into `src/ui/pages/6_statements.py`, persisting downloads under `data/exports/statements` without regressing existing summary or daily statement actions.
- [x] Expand `tests/integration/test_statement_flow.py` to validate per-bookmaker target math, footer totals, and ROI CSV division/VOID handling; run the suite to cover regressions.
- [x] Check in sample CSVs under `docs/examples/` and update `README.md` to reference the new exports and fees/taxes note.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | 1.0 | Implemented CSV helpers, UI wiring, regression tests, and documentation/sample artifacts for exports | James (Developer) |
| 2025-11-13 | 1.1 | Added `% Over / Short` column, clarified header copy, labeled totals row, and refreshed sample CSV/tests accordingly | James (Developer) |
| 2025-11-13 | 1.2 | Redesigned statement CSV layout (header block, ordered columns, FX/target native/action fields, summary-only footer) per ops feedback | James (Developer) |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex)

### Debug Log References
- `pytest tests/integration/test_statement_flow.py`

### Completion Notes List
- Added CSV export helpers to `src/services/statement_service.py` that reuse statement math, aggregate BET_RESULT/BET_STAKE data for ROI, compute the new dual-currency bookmaker rows, derive the MULTIBOOK control value, and normalize rounding/legacy-style filenames per spec.
- Polished statement CSV headers/rows with the updated note copy, `Bookmaker/Balance Native//CCY/Balance EUR/CCY_EUR` layout, and LIQUIDITA/MULTIBOOK/BALANCE/UTILE summary lines to mirror the PO’s legacy export expectations.
- Updated `src/ui/pages/6_statements.py` to persist service-generated CSV payloads, provide the new ROI download button, and reuse helpers in the per-associate ZIP workflow while maintaining existing button behaviour.
- Extended `tests/integration/test_statement_flow.py` to assert target allocation sums, footer profit identities, and ROI percentage handling for zero stakes; introduced documentation samples in `docs/examples/` and referenced them in `README.md`.
- Verified changes via `pytest tests/integration/test_statement_flow.py`.

### File List
- docs/stories/9.11.associate-statement-roi-csv-exports.md
- src/services/statement_service.py
- src/ui/pages/6_statements.py
- tests/integration/test_statement_flow.py
- docs/examples/statement_A123_YYYY-MM-DD.csv
- docs/examples/surebet_roi_A123_YYYY-MM-DD.csv
- README.md

### Change Notes — YF & Exit Settlement Alignment (2025-11-13)

- Statement/ROI CSVs align to the YF identity: include `YF = ND + FS` in summaries and add an “Exit Payout” row (`−Δ`) when exporting at an exit cutoff.
- Add a CSV footer footnote: `Model: YF‑v1 (YF=ND+FS; Δ=TB−YF). Values exclude operator fees/taxes.`
- ND sign semantics: withdrawals stored negative, deposits positive. Tests should assert `YF − ND == FS` and confirm VOID/WON/LOST handling.
- No schema changes; implementation reuses the existing statement math; these updates are labels/notes/row additions.
