# Story 9.8: Ledger Stake Placement Refactor

## Status
Ready for Review

## Story
**As the** settlements owner  
**I want** stake movements to be logged at bet verification/matching time instead of waiting for settlement  
**So that** the ledger, bookmaker balances, and downstream statements reflect real "available vs pending" balances in near real time.

## Acceptance Criteria
1. `BET_STAKE` becomes a supported `ledger_entries.type` value (schema + migration) and is written on every verified/matched bet, capturing associate, bookmaker, bet, native stake (negative), and FX snapshot fields.
2. Settlement logic complements placement entries: WON rows write payout (stake + profit) as `BET_RESULT.amount`, LOST rows record `0`, and VOID rows return the stake.
3. Delta provenance links use profit (payout minus stake) so winner/loser ties continue to represent "who owes who".
4. Re-approval/edit/rejection flows are idempotent: duplicates are prevented and any stake/currency edits emit forward-only corrections that neutralize prior `BET_STAKE` rows.
5. Associate dashboards, Admin UI, and Telegram statements continue to net balances accurately for both pre-flag bets (no placement rows) and post-flag bets.
6. Surebet settlements no longer allocate implicit admin seats; ledger entries only track participating associates and statements rely on per-associate deltas for profit splits.
7. Statements surface, per associate, the name, total deposits, total withdrawals, per-bookmaker balance/deposit/withdraw totals, and the associate delta so profit can be derived as `(bookmaker balances - deposits + delta)`.

## Tasks / Subtasks
- [x] **Database Schema & Feature Flag (AC 1)**
  - [x] Add `BET_STAKE` to the `ledger_entries` type constraint plus associated indices/migrations.
  - [x] Introduce `STAKE_AT_PLACEMENT` feature flag in `Config` and `.env` templates.
  - [x] Provide migration/backfill utility for existing deployments.
- [x] **Stake Placement Capture (AC 1, 4)**
  - [x] Hook BetVerification approval/edit flows to write `BET_STAKE` rows with frozen FX snapshots.
  - [x] Hook Surebet matcher so auto-matched bets also record placement entries idempotently.
  - [x] Implement correction writer to offset previous stakes whenever rejections or stake/currency edits occur.
- [x] **Settlement & Provenance Adjustments (AC 2, 3, 6)**
  - [x] Update `_calculate_amount_native` and related helpers so WON = payout, LOST = 0, VOID = stake.
  - [x] Update `_ensure_delta_provenance_link` to use payout minus stake profit deltas.
  - [x] Remove admin seats from settlement participant lists and ensure statements pull deltas instead.
- [x] **Downstream Consumer Updates (AC 5, 7)**
  - [x] Update `AssociateHubRepository`, dashboards, and funding summaries to include `BET_STAKE`.
  - [x] Revise statement generation (monthly + Streamlit) to surface deposits, withdrawals, per-bookmaker balances, and associate delta.
  - [x] Confirm Telegram statements and exports stay accurate when both legacy/new bets coexist.
- [x] **Testing & Migration Validation**
  - [x] Unit tests for BetVerification hooks and settlement math.
  - [x] Integration tests for settlement, statements, and ledger migrations.
  - [x] Feature-flag regression tests (flag on/off) plus migration dry runs on sample DBs.

## Dev Notes

### Relevant Source Tree
- `src/core/schema.py` – ledger schema + migrations.
- `src/services/bet_verification.py` and `src/services/surebet_matcher.py` – approval/matching flows to hook placement writes.
- `src/services/ledger_entry_service.py` & `src/services/settlement_service.py` – settlement math and delta provenance.
- `src/repositories/associate_hub_repository.py`, `src/services/statement_service.py`, `src/ui/pages/6_statements.py` – downstream consumers that must understand `BET_STAKE`.

### Implementation Highlights
- Feature flag should short-circuit stake writes for legacy deployments; all new logic must be gated.
- Use FX helpers from `funding_transaction_service` to freeze rates when writing stake rows.
- Placement rows must be append-only; corrections are new `BET_STAKE` entries with opposite amounts (never updates).
- Ensure migrations add type + indexes idempotently to avoid restart flaps.

### Migration Strategy
1. Ship schema migration that adds `BET_STAKE` to `ledger_entries` plus any indices.
2. Deploy code with `STAKE_AT_PLACEMENT` defaulting false; enable per environment after verifying dashboards/statements.
3. No backfill: existing bets remain settlement-only; dashboards must handle mixed worlds.
4. Provide rollback instructions (disable flag) in case stake placement needs to be paused.

### Risks & Gotchas
- Double counting if settlement logic still subtracts stake for losers.
- Delta provenance overstatement if profit deltas ignore placement rows.
- Mixed historical data: dashboards/statements must branch on presence/absence of placement entries.
- Removing admin seats changes reconciliation assumptions; ensure finance tooling is notified.

### Testing
**Standards**
- Use pytest (unit + integration) with existing fixtures.
- Mock FX lookups where deterministic assertions required.
- Verify feature flag toggles by running suites with flag both true/false.

**Key Scenarios**
- Placement idempotency (approve twice, edit stakes, reject after approve).
- Settlement ledger output for WON/LOST/VOID combos with/without placement rows.
- Delta provenance link amounts (profit-based) with multi-associate surebets.
- Statement/bookmaker dashboards showing deposits, withdrawals, balances, and delta in mixed historical datasets.

## Change Log
| Date       | Version | Description                                   | Author           |
|------------|---------|-----------------------------------------------|------------------|
| 2025-11-10 | 1.1     | Re-formatted story to new template; content refreshed | Bob (Scrum Master) |
| 2025-11-10 | 1.0     | Initial story draft                           | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex

### Debug Log References
- `pytest tests/unit/test_bet_verification.py`
- `pytest tests/unit/test_statement_service.py`
- `pytest tests/integration/test_statement_flow.py`
- `pytest tests/integration/test_delta_provenance_integration.py`
- `pytest tests/integration/test_reconciliation_flow.py`

### Completion Notes List
- Added `BET_STAKE` ledger support, `STAKE_AT_PLACEMENT` flag, and placement capture service wired into BetVerification + matcher flows (`src/services/bet_verification.py`, `src/services/surebet_matcher.py`, `src/services/stake_ledger_service.py`, `src/core/schema.py`, `src/core/config.py`).
- Reworked settlement math/provenance to treat winners as payout rows, losers as zero, and profit-based provenance links (`src/services/ledger_entry_service.py`, `src/services/settlement_service.py`).
- Updated funding/associate repositories plus statement generation & Streamlit UI to read new entry types and expose deposits/withdrawals/bookmaker breakdowns (`src/repositories/associate_hub_repository.py`, `src/services/funding_transaction_service.py`, `src/services/statement_service.py`, `src/ui/pages/6_statements.py`).
- Refreshed regression suites covering stake capture, settlement changes, statements, and provenance to protect new flows (`tests/unit/test_bet_verification.py`, `tests/unit/test_statement_service.py`, `tests/integration/test_statement_flow.py`, `tests/integration/test_delta_provenance_integration.py`, `tests/integration/test_reconciliation_flow.py`).

### File List
- `src/core/config.py`
- `src/core/schema.py`
- `src/services/stake_ledger_service.py`
- `src/services/bet_verification.py`
- `src/services/surebet_matcher.py`
- `src/services/ledger_entry_service.py`
- `src/services/statement_service.py`
- `src/repositories/associate_hub_repository.py`
- `src/services/funding_transaction_service.py`
- `src/ui/pages/6_statements.py`
- `tests/unit/test_bet_verification.py`
- `tests/unit/test_statement_service.py`
- `tests/integration/test_statement_flow.py`
- `tests/integration/test_delta_provenance_integration.py`
- `tests/integration/test_reconciliation_flow.py`

## QA Results

### Risk Assessment
- **Complexity**: 5/5 (High)
- **Data Sensitivity**: High (Financial ledger data, stake movements)
- **Integration Risk**: 5/5 (Multiple service dependencies, migration complexity)
- **Overall Risk Score**: 25 (Critical)

### NFR Analysis
- **Security**: CONCERNS (Financial data access controls need validation)
- **Performance**: CONCERNS (Real-time ledger writes may impact settlement performance)
- **Reliability**: PASS (Feature flag and idempotent design provide safety)
- **Usability**: PASS (No direct UI changes, maintains existing interfaces)
- **Maintainability**: CONCERNS (Complex migration logic, mixed data handling)

### Test Strategy
- **Unit Tests**: ✅ Comprehensive coverage validated - 51/51 bet verification tests PASSED, 4/4 statement service tests PASSED
- **Integration Tests**: ✅ Critical paths validated - 12/12 statement flow tests PASSED, 8/8 delta provenance tests PASSED, 6/6 reconciliation flow tests PASSED
- **E2E Tests**: Workflow validation needed for mixed historical data scenarios
- **Edge Cases**: ✅ Identified and tested (double counting prevention, migration rollback, feature flag toggles)
- **Performance Tests**: Required for settlement throughput under stake placement load

### Requirements Traceability
- **AC1**: ✅ Mapped to unit tests for schema migration and stake placement capture
- **AC2**: ✅ Mapped to settlement service tests for WON/LOST/VOID logic
- **AC3**: ✅ Mapped to delta provenance integration tests
- **AC4**: ✅ Mapped to bet verification idempotency tests
- **AC5**: ✅ Mapped to associate hub repository and statement service tests
- **AC6**: ✅ Mapped to settlement service changes removing admin seats
- **AC7**: ✅ Mapped to statement generation tests for per-associate breakdowns

### Quality Gate Decision
- **Decision**: CONCERNS
- **Risk Score**: 25 (Critical)
- **Rationale**: While the implementation appears comprehensive with good test coverage, the critical risk level (25) due to high complexity, financial data sensitivity, and integration risk raises concerns. The migration strategy and mixed data handling require additional validation. Performance impact of real-time ledger writes needs benchmarking. Security validation for financial data access is required before production deployment.

- **Recommendations**:
  1. Conduct performance benchmarking of settlement flows with stake placement enabled
  2. Perform security audit of ledger entry access controls and financial data handling
  3. Validate migration rollback procedures on production-like dataset
  4. Add E2E tests covering mixed historical data scenarios across all dashboards
  5. Implement monitoring and alerting for ledger write failures during placement

**QA Engineer**: Quinn - Test Architect
**Date**: 2025-11-10T09:54:00Z
