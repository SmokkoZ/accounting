# Story 9.8: Ledger Stake Placement Refactor

## Status
Draft

## Story
As the settlements owner, I want stake movements to be logged when bets are verified/matched (instead of waiting for settlement) so that the ledger, bookmaker balances, and Telegram statements reflect real “available balance vs. pending” in near-real time.

## Acceptance Criteria

- [ ] A new `BET_STAKE` ledger entry type exists in `ledger_entries` (schema + backfill/migration) and is written whenever a bet is approved/matched, capturing `associate_id`, `bookmaker_id`, `bet_id`, stake amount (negative), and FX snapshot.
- [ ] Bet settlement logic is updated to complement the stake entry:
  - WON: ledger entry records payout (stake + profit) as the `BET_RESULT` amount.
  - LOST: `BET_RESULT` amount is zero (stake already captured).
  - VOID: `BET_RESULT` amount returns the stake.
- [ ] Delta provenance uses profit (payout − stake) when linking winner/loser so links continue representing “who owes who”.
- [ ] Re-approval/edit/rejection flows are idempotent: duplicate stake entries are prevented, and any stake/currency edits emit forward-only correction entries to neutralize prior `BET_STAKE` rows.
- [ ] Associate dashboards, Admin pages, and Telegram statements continue to net balances correctly whether bets were created before or after the feature flag activation (old bets have no placement entries, new bets do).
- [ ] Surebet settlements no longer allocate “admin shares”; profits (and losses/void refunds) are split only across participating associates. The admin/operator manually derives their cut from statements, so ledger entries for admin seats should be removed/zeroed.
- [ ] Statements surface, per associate: name, total deposits, total withdrawals, bookmaker list with balance/deposit/withdraw columns, and the associate delta so profit can be derived as `(bookmaker balances − deposits ± delta)`.

## What Must Change (Concretely)

1. **Schema**
   - Add `BET_STAKE` to `ledger_entries.type` constraint and ensure migrations rebuild legacy tables if needed (`src/core/schema.py:404`).

2. **Placement Flow**
   - Hook bet approval/matching (BetVerification + matcher) so each bet writes a `BET_STAKE` entry with the native stake, FX snapshot, `bookmaker_id`, and `bet_id`.

3. **Settlement Writer**
   - `src/services/ledger_entry_service.py:390` (`_calculate_amount_native`): return payout on WON, `0` on LOST, stake on VOID.
   - `src/services/ledger_entry_service.py:322` (`_ensure_delta_provenance_link`): compute link amount as profit (payout − stake) since winner ledger entries now contain payout.
   - Remove the implicit admin seat: settlement participants should only include associates. Update statement/export builders to rely on the per-associate deltas instead of an admin share.

4. **Idempotency & Reversals**
   - Prevent duplicate stake entries on re-approval.
   - If a verified bet is later rejected or stake/currency edits occur, record a forward-only correction to offset the previous `BET_STAKE`.

5. **Downstream Consumers**
   - Update `AssociateHubRepository` filters (it currently assumes `BET_RESULT`, `DEPOSIT`, `WITHDRAWAL`, `BOOKMAKER_CORRECTION`) so delta and holdings stay accurate with the new type.
   - Update statement generation (monthly/global daily) and any Streamlit dashboards that referenced admin per-share rows so they now compute the requested columns: associate info, total deposits/withdrawals, per-bookmaker balance/deposit/withdraw totals, and associate delta.

## Risks & Gotchas

- Double counting if settlement logic still subtracts stake for losers.
- Delta provenance links will overstate if they rely on ledger entry amount (now payout) instead of profit.
- Historical bets (pre-flag) lack placement entries; dashboards must tolerate a mixed world via feature flag/date guard.
- Removing the admin seat changes reconciliations/export assumptions; ensure any tooling that previously expected an admin ledger row (e.g., coverage proofs, statement templates) is updated.

## Effort Estimate

- Schema + migration + feature flag work: **0.5 day**
- Placement hook, idempotency, and reversal handling: **0.5–1 day**
- Settlement + provenance adjustments: **0.5 day**
- QA/regression across reconciliation, Telegram statements, and admin dashboards: **0.5 day**
- **Total:** ~2–3 engineer-days including tests.

## Migration Strategy

1. Add `BET_STAKE` to the schema; run migration automatically on startup for existing DBs.
2. Gate behavior with a config flag (e.g., `STAKE_AT_PLACEMENT=true`).
3. Apply only to bets verified/matched after the flag is enabled (no backfill).
4. Dashboards already sum `amount_eur`; verify they keep working for both old/new entries.

## Dev Notes

- Reuse FX helpers from `funding_transaction_service` to freeze rates when recording the stake.
- Consider logging both native and EUR amounts for telemetry so reconciliation remains explainable.
- Update automated tests (unit + integration) to assert the new ledger rows and the idempotency guarantees.
